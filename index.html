<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RunPod ComfyUI Frontend</title>
  <style>
    :root{
      --bg: #0f1116; --panel:#171923; --muted:#a0abc0; --text:#e6eefc; --accent:#5aa9ff; --danger:#ff5964; --ok:#61d095; --border:#262b3a;
    }
    *{box-sizing:border-box}
    body{margin:0; font:14px/1.4 system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:var(--text); background:var(--bg);}    
    header{position:sticky; top:0; z-index:5; background:rgba(15,17,22,.85); backdrop-filter:saturate(180%) blur(10px); border-bottom:1px solid var(--border);}    
    header .wrap{max-width:1100px; margin:0 auto; padding:10px 16px; display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    header h1{font-size:16px; margin:0; font-weight:650}
    header .desc{color:var(--muted); font-size:12px}
    main{max-width:1100px; margin:0 auto; padding:16px; display:grid; grid-template-columns: 360px 1fr; gap:16px}
    @media (max-width: 880px){ main{grid-template-columns: 1fr;} }

    .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; overflow:hidden}
    .card header{position:unset; background:none; border:0; display:flex; align-items:center; justify-content:space-between; gap:8px}
    .card .body{padding:14px}

    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .row-3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    .row-4{display:grid; grid-template-columns: repeat(4,1fr); gap:10px}
    .lora-section{margin-top:16px}
    .lora-entry{border:1px solid var(--border); background:#0c0e14; border-radius:10px; padding:10px; margin-top:10px}
    .lora-entry-top{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .lora-toggle{display:flex; align-items:center; gap:8px}
    .lora-remove{background:none; border:0; color:var(--muted); font-size:20px; line-height:1; cursor:pointer; padding:4px; border-radius:6px}
    .lora-remove:hover{color:var(--danger); background:rgba(255,89,100,0.1)}
    .lora-entry label:first-of-type{margin-top:0}

    label{display:block; margin:10px 0 4px; font-weight:600; font-size:12px; color:#cdd6eb}
    input[type="text"], input[type="number"], select, textarea{
      width:100%; padding:10px 12px; border-radius:9px; border:1px solid var(--border); background:#0c0e14; color:var(--text);
      outline:none; transition:border .15s ease;
    }
    textarea{min-height:120px; resize:vertical}
    input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus{border-color:#33406b}

    .hint{color:var(--muted); font-size:12px}
    .muted{color:var(--muted)}

    .switch{display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none}
    .switch input{display:none}
    .switch .track{width:40px; height:22px; background:#0c0e14; border:1px solid var(--border); border-radius:999px; position:relative; transition:all .2s}
    .switch .thumb{position:absolute; top:1px; left:1px; width:18px; height:18px; border-radius:50%; background:#7b85a3; transition:left .2s}
    .switch input:checked + .track{background:#0d213c; border-color:#284e8a}
    .switch input:checked + .track .thumb{left:21px; background:var(--accent)}

    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; border:1px solid var(--border); background:#0d1320; color:var(--text); padding:10px 12px; border-radius:10px; cursor:pointer; text-decoration:none}
    .btn:hover{border-color:#2f3b5f}
    .btn.primary{background:#11305a}
    .btn.danger{background:#2a1114}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .status{font-size:12px; color:var(--muted)}

    .gallery{display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:12px; padding:12px}
    .shot{border:1px solid var(--border); background:#0c0e14; border-radius:10px; overflow:hidden}
    .shot header{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; border-bottom:1px solid var(--border)}
    .shot img{display:block; width:100%; height:auto}
    .shot video{display:block; width:100%; height:auto; background:#000}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px}
    details pre{max-height:300px; overflow:auto; background:#0b0e14; border:1px solid var(--border); border-radius:8px; padding:12px}
    .error{color:var(--danger)}
  

/* --- Tabs --- */
.tabs{max-width:1100px; margin:8px auto 0; padding:0 16px; display:flex; gap:8px}
.tab{padding:8px 12px; border:1px solid var(--border); background:#0d1320; color:var(--text); border-radius:10px; cursor:pointer; user-select:none}
.tab.active{background:#11305a}
.hidden{display:none}

    .lightbox{position:fixed; inset:0; background:rgba(0,0,0,.8); display:flex; align-items:center; justify-content:center; z-index:1000; padding:20px;}
    .lightbox.hidden{display:none}
    .lightbox img{max-width:100%; max-height:100%; border-radius:8px}
    .lightbox .close{position:absolute; top:16px; right:16px; background:none; border:0; color:#fff; font-size:32px; cursor:pointer}

</style>
</head>
<body>
  <div id="lightbox" class="lightbox hidden"><img alt="Full size" /><button class="close" aria-label="Close">&times;</button></div>
  <header>
    <div class="wrap">
      <h1>RunPod ComfyUI Frontend</h1>
      <div class="desc">Static client for /runsync. No backend. API key stays in-memory.</div>
    </div>
  </header>

<nav class="tabs" id="tabbar">
  <button class="tab active" data-tab="sdxl">SDXL</button>
  <button class="tab" data-tab="qwen">Qwen-Image</button>
  <button class="tab" data-tab="ace">ACE-Step</button>
  <button class="tab" data-tab="wan">Wan 2.2</button>
</nav>

<div id="apiKeyWrap" style="max-width:1100px; margin:8px auto 0; padding:0 16px; display:flex; flex-wrap:wrap; justify-content:flex-end; gap:8px; align-items:center;">
  <label for="apiKey" style="margin:0">RunPod API Key</label>
  <input id="apiKey" type="text" placeholder="rp_..." autocomplete="off" spellcheck="false" style="width:300px" />
  <div class="hint" style="width:100%; text-align:right">Used only in this page, not stored.</div>
</div>


  <main>
    <section class="card" id="controls">
      <header class="body" style="border-bottom:1px solid var(--border)">
        <strong>Controls</strong>
        <div style="display:flex; gap:8px; align-items:center">
          <div class="status" id="timer">00:00.00</div>
          <div class="status" id="status">Idle</div>
        </div>
      </header>
      <div class="body">
        <label for="model">Model</label>
        <select id="model">
          <option value="noobaiXLNAIXL_vPred10Version.safetensors">noobaiXLNAIXL_vPred10Version.safetensors</option>
          <option value="ΣIH-1.5.safetensors">ΣIH-1.5.safetensors</option>
          <option value="midnightNAIXLVpredv1.safetensors">midnightNAIXLVpredv1.safetensors</option>
          <option value="oneObsession_v16Noobai.safetensors">oneObsession_v16Noobai.safetensors</option>
          <option value="rouwei_v080Vpred.safetensors">rouwei_v080Vpred.safetensors</option>
        </select>

        <label for="prompt">Prompt</label>
        <textarea id="prompt" placeholder="Describe the image..."></textarea>

        <div id="negZeroRow" style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
          <label class="switch"><input id="negZero" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
          <span class="hint">Zero out negative prompt</span>
        </div>

        <div id="negWrap">
          <label for="negative">Negative prompt</label>
          <textarea id="negative" placeholder="Things to avoid..."></textarea>
        </div>

        <div id="rouweiWrap" style="display:none; margin-top:10px">
          <label for="rouweiPrefix">Rouwei prefix</label>
          <textarea id="rouweiPrefix" placeholder="Required artist and quality tags for rouwei..."></textarea>
          <div class="hint">Required when using rouwei_v080Vpred.safetensors.</div>
        </div>

        <div>
          <label for="dims">Dimensions</label>
          <select id="dims">
            <option>704x1408</option>
            <option>768x1344</option>
            <option>768x1280</option>
            <option>720x1280</option>
            <option>896x1152</option>
            <option>1024x1024</option>
            <option>1152x896</option>
            <option>1280x768</option>
            <option>1344x768</option>
            <option>1408x704</option>
            <option value="custom">Custom...</option>
          </select>
          <div id="customDimsWrap" class="row" style="display:none; margin-top:10px">
            <div>
              <label for="customWidth">Width</label>
              <input id="customWidth" type="number" min="512" max="2048" step="1" value="1024" />
            </div>
            <div>
              <label for="customHeight">Height</label>
              <input id="customHeight" type="number" min="512" max="2048" step="1" value="1024" />
            </div>
          </div>
        </div>

        <div style="margin-top:10px">
          <label for="batchSize">Batch size</label>
          <input id="batchSize" type="range" min="1" max="4" step="1" value="1" />
          <div class="hint" id="batchSizeHint">1 image per run</div>
        </div>

        <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
          <label class="switch"><input id="rmbg" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
          <span class="hint">Remove background (BiRefNet)</span>
        </div>

        <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
          <label class="switch"><input id="mahiroToggle" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label>
          <span class="hint">Enable Mahiro</span>
        </div>

        <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
          <label class="switch"><input id="apgToggle" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label>
          <span class="hint">Enable Adaptive Projected Guidance</span>
        </div>

        <div class="lora-section">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px">
            <strong>LoRA</strong>
            <button class="btn" id="addLoraBtn" type="button">Add LoRA</button>
          </div>
          <div id="loraList"></div>
        </div>

        <hr style="border:0; border-top:1px solid var(--border); margin:14px 0" />
        <strong></strong>
        <div class="row-3">
          <div>
            <label for="seed">Seed</label>
            <input id="seed" type="number" step="1" value="-1" />
            <div class="hint" id="seedHint">Use -1 for random</div>
          </div>
          <div>
            <label for="steps">Steps</label>
            <input id="steps" type="number" min="15" max="35" step="1" value="25" />
          </div>
          <div>
            <label for="cfg">CFG</label>
            <input id="cfg" type="number" step="0.1" value="5.0" />
            <div class="hint" id="cfgHint">Range 4.0–6.0 (non cfg_pp)</div>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="sampler">Sampler</label>
            <select id="sampler"></select>
          </div>
          <div>
            <label for="scheduler">Scheduler</label>
            <select id="scheduler"></select>
          </div>
        </div>

        <hr style="border:0; border-top:1px solid var(--border); margin:14px 0" />
        <div style="display:flex; align-items:center; justify-content:space-between; margin:8px 0">
          <strong>HiresFix</strong>
          <label class="switch"><input id="hiresToggle" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
        </div>
        <div id="hiresWrap" style="display:none">
          <div class="row-4">
            <div>
              <label for="hiresScale">Scale by</label>
              <input id="hiresScale" type="number" min="1.00" max="2.00" step="0.01" value="1.50" />
            </div>
            <div>
              <label for="hiresSteps">Steps</label>
              <input id="hiresSteps" type="number" min="15" max="25" step="1" value="20" />
            </div>
            <div>
              <label for="hiresCfg">CFG</label>
              <input id="hiresCfg" type="number" step="0.1" value="5.0" />
              <div class="hint" id="hiresCfgHint">Range 4.0–6.0 (non cfg_pp)</div>
            </div>
            <div>
              <label for="hiresDenoise">Denoise</label>
              <input id="hiresDenoise" type="number" min="0.00" max="1.00" step="0.01" value="0.56" />
            </div>
          </div>
          <div class="row">
            <div>
              <label for="hiresSampler">Sampler</label>
              <select id="hiresSampler"></select>
            </div>
            <div>
              <label for="hiresScheduler">Scheduler</label>
              <select id="hiresScheduler"></select>
            </div>
          </div>
          <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
            <label class="switch"><input id="hiresSeedCustom" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
            <span class="hint">Use custom HiresFix seed</span>
          </div>
          <div id="hiresSeedWrap" style="display:none">
            <label for="hiresSeed">HiresFix seed</label>
            <input id="hiresSeed" type="number" step="1" value="-1" />
          </div>
        </div>

        <hr style="border:0; border-top:1px solid var(--border); margin:14px 0" />
        <div class="row">
          <button class="btn primary" id="runBtn">Generate</button>
          <button class="btn" id="curlBtn" type="button">Copy cURL</button>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="resetBtn" type="button">Reset to defaults</button>
          <button class="btn danger" id="clearBtn" type="button">Clear gallery</button>
        </div>
        <p class="hint" style="margin-top:10px">Endpoint: <span class="mono">https://api.runpod.ai/v2/vpr9pkr7n873/runsync</span></p>
      </div>
    </section>

    <section class="card">
      <header class="body" style="border-bottom:1px solid var(--border)"><strong>Output (AVIF)</strong></header>
      <div class="gallery" id="gallery"></div>
      <div class="body">
        <details>
          <summary class="mono">Request payload (debug)</summary>
          <pre class="mono" id="debugReq"></pre>
        </details>
        <details>
          <summary class="mono">Raw response (debug)</summary>
          <pre class="mono" id="debugResp"></pre>
        </details>
      </div>
    </section>
  </main>

<main id="qwen-main" class="hidden">
  <section class="card" id="q-controls">
    <header class="body" style="border-bottom:1px solid var(--border)">
      <strong>Qwen-Image Controls</strong>
      <div style="display:flex; gap:8px; align-items:center">
        <div class="status" id="q-timer">00:00.00</div>
        <div class="status" id="q-status">Idle</div>
      </div>
    </header>
    <div class="body">
      <div class="hint" style="margin-bottom:10px">
        Uses the same RunPod API key field above (rp_…); endpoint identical to SDXL.
      </div>

      <label for="q-prompt">Prompt</label>
      <textarea id="q-prompt" placeholder="Describe the image..."></textarea>

      <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
        <label class="switch"><input id="q-lowstep" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
        <span class="hint">Use low-step (toggle between 4 and 8 steps; hides negative)</span>
      </div>

      <div id="q-negwrap">
        <label for="q-negative">Negative prompt</label>
        <textarea id="q-negative" placeholder="Things to avoid..."></textarea>
      </div>

      <div class="row">
        <div>
          <label for="q-width">Width</label>
          <input id="q-width" type="number" min="64" max="1920" step="1" value="1024" />
        </div>
        <div>
          <label for="q-height">Height</label>
          <input id="q-height" type="number" min="64" max="1920" step="1" value="1024" />
        </div>
      </div>

      <hr style="border:0; border-top:1px solid var(--border); margin:14px 0" />
      <strong>Sampler</strong>
      <div class="row-3">
        <div>
          <label for="q-seed">Seed</label>
          <input id="q-seed" type="number" step="1" value="-1" />
          <div class="hint" id="q-seedHint">-1 = random (client-side)</div>
        </div>
        <div id="q-steps-wrap">
          <label for="q-steps">Steps</label>
          <input id="q-steps" type="number" min="10" max="30" step="1" value="20" />
          <div id="q-steps-toggle" style="display:none; margin-top:8px; align-items:center; gap:8px;">
            <label class="switch" style="margin:0"><input id="q-steps-toggle-input" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label>
            <span class="hint" id="q-steps-toggle-hint">8 steps</span>
          </div>
        </div>
        <div>
          <label for="q-cfg">CFG</label>
          <input id="q-cfg" type="number" min="1.0" max="3.5" step="0.1" value="2.0" />
          <div class="hint">Always sent (even in low-step)</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="q-sampler">Sampler</label>
          <select id="q-sampler"></select>
        </div>
        <div>
          <label for="q-scheduler">Scheduler</label>
          <select id="q-scheduler"></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label for="q-model-shift">Model shift</label>
          <input id="q-model-shift" type="number" min="0.00" step="0.01" value="3.10" />
          <div class="hint">Two decimal places</div>
        </div>
      </div>

      <hr style="border:0; border-top:1px solid var(--border); margin:14px 0" />
      <div class="row">
        <button class="btn primary" id="q-run">Generate</button>
        <button class="btn" id="q-curl" type="button">Copy cURL</button>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="q-reset" type="button">Reset to defaults</button>
        <button class="btn danger" id="q-clear" type="button">Clear gallery</button>
      </div>
      <p class="hint" style="margin-top:10px">Endpoint: <span class="mono">https://api.runpod.ai/v2/vpr9pkr7n873/runsync</span></p>
    </div>
  </section>

  <section class="card">
    <header class="body" style="border-bottom:1px solid var(--border)"><strong>Output (AVIF)</strong></header>
    <div class="gallery" id="q-gallery"></div>
    <div class="body">
      <details>
        <summary class="mono">Request payload (debug)</summary>
        <pre class="mono" id="q-debugReq"></pre>
      </details>
      <details>
        <summary class="mono">Raw response (debug)</summary>
        <pre class="mono" id="q-debugResp"></pre>
      </details>
    </div>
  </section>
</main>

<main id="ace-main" class="hidden">
  <section class="card" id="ace-controls">
    <header class="body" style="border-bottom:1px solid var(--border)">
      <strong>ACE-Step Controls</strong>
      <div style="display:flex; gap:8px; align-items:center">
        <div class="status" id="ace-timer">00:00.00</div>
        <div class="status" id="ace-status">Idle</div>
      </div>
    </header>
    <div class="body">
      <div class="hint" style="margin-bottom:10px">
        Uses the same RunPod API key field above; dedicated endpoint for ACE-Step audio.
      </div>

      <label for="ace-tags">Tags</label>
      <textarea id="ace-tags" placeholder="Describe the song..."></textarea>

      <label for="ace-structure">Structure</label>
      <textarea id="ace-structure" placeholder="Describe the song structure..."></textarea>

      <label>Length (MM:SS)</label>
      <div class="row">
        <div>
          <label for="ace-minutes">Minutes</label>
          <input id="ace-minutes" type="number" min="0" step="1" value="0" />
        </div>
        <div>
          <label for="ace-seconds">Seconds</label>
          <input id="ace-seconds" type="number" min="0" max="59" step="1" value="30" />
        </div>
      </div>
      <div class="hint">Converted to total seconds before sending.</div>

      <div class="row-3">
        <div>
          <label for="ace-seed">Seed</label>
          <input id="ace-seed" type="number" step="1" value="-1" />
          <div class="hint" id="ace-seedHint">Use -1 for random</div>
        </div>
        <div>
          <label for="ace-steps">Steps</label>
          <input id="ace-steps" type="number" min="25" max="75" step="1" value="50" />
        </div>
        <div>
          <label for="ace-cfg">CFG</label>
          <input id="ace-cfg" type="number" min="1.0" step="0.1" value="5.0" />
          <div class="hint">Minimum 1.0</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="ace-sampler">Sampler</label>
          <select id="ace-sampler"></select>
        </div>
        <div>
          <label for="ace-scheduler">Scheduler</label>
          <select id="ace-scheduler"></select>
        </div>
      </div>

      <label for="ace-quality">Quality</label>
      <select id="ace-quality">
        <option value="96k">96k</option>
        <option value="128k" selected>128k</option>
        <option value="192k">192k</option>
        <option value="320k">320k</option>
      </select>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="ace-run">Generate</button>
        <button class="btn" id="ace-curl" type="button">Copy cURL</button>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="ace-reset" type="button">Reset to defaults</button>
        <button class="btn danger" id="ace-clear" type="button">Clear outputs</button>
      </div>
      <p class="hint" style="margin-top:10px">Endpoint: <span class="mono">https://api.runpod.ai/v2/e1hyz03h6llhvn/runsync</span></p>
    </div>
  </section>

  <section class="card">
    <header class="body" style="border-bottom:1px solid var(--border)"><strong>Output (Opus)</strong></header>
    <div class="gallery" id="ace-gallery"></div>
    <div class="body">
      <details>
        <summary class="mono">Request payload (debug)</summary>
        <pre class="mono" id="ace-debugReq"></pre>
      </details>
      <details>
        <summary class="mono">Raw response (debug)</summary>
        <pre class="mono" id="ace-debugResp"></pre>
      </details>
    </div>
  </section>
</main>


<main id="wan-main" class="hidden">
  <section class="card" id="wan-controls">
    <header class="body" style="border-bottom:1px solid var(--border)">
      <strong>Wan 2.2 Controls</strong>
      <div style="display:flex; gap:8px; align-items:center">
        <div class="status" id="wan-timer">00:00.00</div>
        <div class="status" id="wan-status">Idle</div>
      </div>
    </header>
    <div class="body">
      <div class="hint" style="margin-bottom:10px">
        Uses the same RunPod API key field above; endpoint matches ACE-Step (video/mp4 output).
      </div>

      <label for="wan-img-url">Image URL</label>
      <input id="wan-img-url" type="text" placeholder="https://..." autocomplete="off" spellcheck="false" />
      <div class="hint">Direct link to the starting image.</div>

      <label for="wan-prompt">Prompt</label>
      <textarea id="wan-prompt" placeholder="Describe the motion..."></textarea>

      <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
        <label class="switch"><input id="wan-nsfw" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
        <span class="hint">NSFW prompt (adds safety prefix)</span>
      </div>

      <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
        <label class="switch"><input id="wan-lowstep" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
        <span class="hint">Low-step mode (steps 4–8, CFG forced to 1.0; hides negative)</span>
      </div>

      <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
        <label class="switch"><input id="wan-zero-negative" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
        <span class="hint">Zero out negative prompt</span>
      </div>

      <div id="wan-negative-wrap">
        <label for="wan-negative">Negative prompt</label>
        <textarea id="wan-negative" placeholder="Things to avoid..."></textarea>
      </div>

      <label for="wan-seed">Seed</label>
      <input id="wan-seed" type="number" step="1" value="-1" />
      <div class="hint" id="wan-seedHint">Use -1 for random (client-side).</div>

      <div class="row">
        <div>
          <label for="wan-steps">Steps</label>
          <input id="wan-steps" type="number" min="10" max="25" step="2" value="16" />
          <div class="hint" id="wan-steps-hint">Even values from 10–24.</div>
        </div>
        <div id="wan-cfg-wrap">
          <label for="wan-cfg">CFG</label>
          <input id="wan-cfg" type="number" min="1.0" max="6.0" step="0.1" value="3.5" />
          <div class="hint" id="wan-cfg-hint">Range 1.0–6.0 (ignored in low-step).</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="wan-sampler">Sampler</label>
          <select id="wan-sampler"></select>
        </div>
        <div>
          <label for="wan-scheduler">Scheduler</label>
          <select id="wan-scheduler"></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="wan-length">Video length</label>
          <input id="wan-length" type="number" min="33" max="81" step="1" value="48" />
          <div class="hint">Range 33–81 frames.</div>
        </div>
        <div>
          <label for="wan-mp">Megapixels</label>
          <input id="wan-mp" type="number" min="0.50" max="1.00" step="0.01" value="1.00" />
          <div class="hint">Range 0.50–1.00 (two decimals).</div>
        </div>
      </div>

      <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
        <label class="switch"><input id="wan-interpolate" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label>
        <span class="hint">Interpolate frames with RIFE after generation</span>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="wan-run">Generate</button>
        <button class="btn" id="wan-curl" type="button">Copy cURL</button>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="wan-reset" type="button">Reset to defaults</button>
        <button class="btn danger" id="wan-clear" type="button">Clear outputs</button>
      </div>
      <p class="hint" style="margin-top:10px">Endpoint: <span class="mono">https://api.runpod.ai/v2/e1hyz03h6llhvn/runsync</span></p>
    </div>
  </section>

  <section class="card">
    <header class="body" style="border-bottom:1px solid var(--border)"><strong>Output (H.264 MP4)</strong></header>
    <div class="gallery" id="wan-gallery"></div>
    <div class="body">
      <details>
        <summary class="mono">Request payload (debug)</summary>
        <pre class="mono" id="wan-debugReq"></pre>
      </details>
      <details>
        <summary class="mono">Raw response (debug)</summary>
        <pre class="mono" id="wan-debugResp"></pre>
      </details>
    </div>
  </section>
</main>



  <!-- Workflow template embedded as JSON for robust placeholder replacement -->
  <script id="workflow-template" type="application/json">{"1":{"inputs":{"ckpt_name":"%model%"},"class_type":"CheckpointLoaderSimple","_meta":{"title":"Load Checkpoint"}},"2":{"inputs":{"text":"%prompt%","clip":["15",1]},"class_type":"CLIPTextEncode","_meta":{"title":"Positive Prompt (Main)"}},"3":{"inputs":{"text":"%rouwei_prefix%","clip":["1",1]},"class_type":"CLIPTextEncode","_meta":{"title":"Positive Prompt (Rouwei)"}},"4":{"inputs":{"conditioning1":["3",0],"conditioning2":["2",0]},"class_type":"ImpactConcatConditionings","_meta":{"title":"Concat Conditionings"}},"5":{"inputs":{"boolean":["6",0],"on_true":["4",0],"on_false":["2",0]},"class_type":"easy ifElse","_meta":{"title":"If else"}},"6":{"inputs":{"string":"%model%","substring":"rouwei","case_sensitive":true},"class_type":"StringContains","_meta":{"title":"Contains"}},"7":{"inputs":{"conditioning":["5",0]},"class_type":"ConditioningZeroOut","_meta":{"title":"ConditioningZeroOut"}},"8":{"inputs":{"boolean":"%neg_zero_out%","on_true":["7",0],"on_false":["9",0]},"class_type":"easy ifElse","_meta":{"title":"Zero Out Negative"}},"9":{"inputs":{"text":"%negative_prompt%","clip":["1",1]},"class_type":"CLIPTextEncode","_meta":{"title":"Negative Prompt"}},"10":{"inputs":{"seed":"%seed%","steps":"%steps%","cfg":"%cfg%","sampler_name":"%sampler%","scheduler":"%scheduler%","denoise":1,"model":["14",0],"positive":["5",0],"negative":["8",0],"latent_image":["16",0]},"class_type":"KSampler","_meta":{"title":"KSampler (initial)"}},"11":{"inputs":{"model":["15",0]},"class_type":"Mahiro","_meta":{"title":"Mahiro"}},"12":{"inputs":{"boolean":"%enable_mahiro%","on_true":["11",0],"on_false":["1",0]},"class_type":"easy ifElse","_meta":{"title":"Enable Mahiro"}},"13":{"inputs":{"eta":1,"norm_threshold":20,"momentum":0,"model":["12",0]},"class_type":"APG","_meta":{"title":"Adaptive Projected Guidance"}},"14":{"inputs":{"boolean":"%enable_apg%","on_true":["13",0],"on_false":["12",0]},"class_type":"easy ifElse","_meta":{"title":"Enable APG"}},"15":{"inputs":{"PowerLoraLoaderHeaderWidget":{"type":"PowerLoraLoaderHeaderWidget"},"lora_1":{"on":"%lora1_toggle%","lora":"%lora1_name%","strength":"%lora1_strength%"},"lora_2":{"on":"%lora2_toggle%","lora":"%lora2_name%","strength":"%lora2_strength%"},"lora_3":{"on":"%lora3_toggle%","lora":"%lora3_name%","strength":"%lora3_strength%"},"\u2795 Add Lora":"","model":["1",0],"clip":["1",1]},"class_type":"Power Lora Loader (rgthree)","_meta":{"title":"Power Lora Loader (rgthree)"}},"16":{"inputs":{"width":"%width%","height":"%height%","batch_size":"%batch_size%"},"class_type":"EmptyLatentImage","_meta":{"title":"Empty Latent Image"}},"17":{"inputs":{"upscale_method":"nearest-exact","scale_by":"%hiresfix_scale_by%","samples":["10",0]},"class_type":"LatentUpscaleBy","_meta":{"title":"Upscale Latent By"}},"18":{"inputs":{"seed":"%hiresfix_seed%","steps":"%hiresfix_steps%","cfg":"%hiresfix_cfg%","sampler_name":"%hiresfix_sampler%","scheduler":"%hiresfix_scheduler%","denoise":"%hiresfix_denoise%","model":["14",0],"positive":["5",0],"negative":["8",0],"latent_image":["17",0]},"class_type":"KSampler","_meta":{"title":"KSampler (hiresfix)"}},"19":{"inputs":{"samples":["23",0],"vae":["1",2]},"class_type":"VAEDecode","_meta":{"title":"VAE Decode"}},"20":{"inputs":{"filename_prefix":"ComfyUI","filename_keys":"","foldername_prefix":"","foldername_keys":"","delimiter":"-","save_job_data":"disabled","job_data_per_image":false,"job_custom_text":"","save_metadata":false,"counter_digits":4,"counter_position":"last","one_counter_per_folder":true,"image_preview":true,"output_ext":".avif","quality":99,"images":["22",0]},"class_type":"SaveImageExtended","_meta":{"title":"\ud83d\udcbe Save Image Extended"}},"21":{"inputs":{"model":"BiRefNet_dynamic","mask_blur":0,"mask_offset":0,"invert_output":false,"refine_foreground":false,"background":"Alpha","background_color":"#000000","image":["19",0]},"class_type":"BiRefNetRMBG","_meta":{"title":"BiRefNet Remove Background (RMBG)"}},"22":{"inputs":{"boolean":"%remove_bg%","on_true":["21",0],"on_false":["19",0]},"class_type":"easy ifElse","_meta":{"title":"Remove Background"}},"23":{"inputs":{"boolean":"%use_hiresfix%","on_true":["18",0],"on_false":["10",0]},"class_type":"easy ifElse","_meta":{"title":"HiresFix Enable"}}}</script>

<script id="qwen-template" type="application/json">
{
  "1": {"inputs":{"unet_name":"qwen_image_fp8_e4m3fn.safetensors","weight_dtype":"default"},"class_type":"UNETLoader","_meta":{"title":"Load Diffusion Model"}},
  "2": {"inputs":{"clip_name":"qwen_2.5_vl_7b.safetensors","type":"qwen_image","device":"default"},"class_type":"CLIPLoader","_meta":{"title":"Load CLIP"}},
  "3": {"inputs":{"vae_name":"qwen_image_vae.safetensors"},"class_type":"VAELoader","_meta":{"title":"Load VAE"}},
  "5": {"inputs":{"value":"%use_low_step%"},"class_type":"PrimitiveBoolean","_meta":{"title":"Low Step"}},
  "6": {"inputs":{"text":"%prompt%","clip":["2",0]},"class_type":"CLIPTextEncode","_meta":{"title":"CLIP Text Encode (Positive Prompt)"}},
  "7": {"inputs":{"text":"%negative_prompt%","clip":["2",0]},"class_type":"CLIPTextEncode","_meta":{"title":"CLIP Text Encode (Negative Prompt)"}},
  "8": {"inputs":{"width":"%width%","height":"%height%","batch_size":1},"class_type":"EmptySD3LatentImage","_meta":{"title":"EmptySD3LatentImage"}},
  "9": {"inputs":{"seed":"%seed%","steps":"%steps%","cfg":["20",0],"sampler_name":"%sampler%","scheduler":"%scheduler%","denoise":1,"model":["10",0],"positive":["6",0],"negative":["14",0],"latent_image":["8",0]},"class_type":"KSampler","_meta":{"title":"KSampler"}},
  "10": {"inputs":{"shift":"%model_shift%","model":["12",0]},"class_type":"ModelSamplingAuraFlow","_meta":{"title":"ModelSamplingAuraFlow"}},
  "11": {"inputs":{"lora_name":"%low_step_lora%","strength_model":1,"model":["1",0]},"class_type":"LoraLoaderModelOnly","_meta":{"title":"LoraLoaderModelOnly"}},
  "12": {"inputs":{"boolean":["5",0],"on_true":["11",0],"on_false":["1",0]},"class_type":"easy ifElse","_meta":{"title":"If else"}},
  "13": {"inputs":{"conditioning":["6",0]},"class_type":"ConditioningZeroOut","_meta":{"title":"ConditioningZeroOut"}},
  "14": {"inputs":{"boolean":["5",0],"on_true":["13",0],"on_false":["7",0]},"class_type":"easy ifElse","_meta":{"title":"If else"}},
  "15": {"inputs":{"samples":["9",0],"vae":["3",0]},"class_type":"VAEDecode","_meta":{"title":"VAE Decode"}},
  "16": {"inputs":{"filename_prefix":"Qwen","filename_keys":"","foldername_prefix":"","foldername_keys":"","delimiter":"-","save_job_data":"disabled","job_data_per_image":false,"job_custom_text":"","save_metadata":false,"counter_digits":4,"counter_position":"last","one_counter_per_folder":true,"image_preview":true,"output_ext":".avif","quality":99,"images":["15",0]},"class_type":"SaveImageExtended","_meta":{"title":"\ud83d\udcbe Save Image Extended"}},
  "20": {"inputs":{"boolean":["5",0],"on_true":["21",0],"on_false":["22",0]},"class_type":"easy ifElse","_meta":{"title":"If else"}},
  "21": {"inputs":{"value":1},"class_type":"PrimitiveFloat","_meta":{"title":"LSCFG"}},
  "22": {"inputs":{"value":"%cfg%"},"class_type":"PrimitiveFloat","_meta":{"title":"Standard CFG"}}
}
</script>

<script id="wan-template" type="application/json">
{
  "1":{"inputs":{"unet_name":"wan2.2_i2v_high_noise_14B_fp16.safetensors","weight_dtype":"default"},"class_type":"UNETLoader","_meta":{"title":"Load High Noise"}},
  "2":{"inputs":{"unet_name":"wan2.2_i2v_low_noise_14B_fp16.safetensors","weight_dtype":"default"},"class_type":"UNETLoader","_meta":{"title":"Load Low Noise"}},
  "3":{"inputs":{"lora_name":"wan2.2_lightx2v_high.safetensors","strength_model":1,"model":["10",0]},"class_type":"LoraLoaderModelOnly","_meta":{"title":"LoraLoaderModelOnly HN"}},
  "4":{"inputs":{"lora_name":"wan2.2_lightx2v_low.safetensors","strength_model":1,"model":["13",0]},"class_type":"LoraLoaderModelOnly","_meta":{"title":"LoraLoaderModelOnly LN"}},
  "5":{"inputs":{"lora_name":"NSFW-22-H-e8.safetensors","strength_model":1,"strength_clip":1,"model":["1",0],"clip":["8",0]},"class_type":"LoraLoader","_meta":{"title":"NSFW H"}},
  "6":{"inputs":{"value":"%prompt%"},"class_type":"PrimitiveStringMultiline","_meta":{"title":"Positive Prompt"}},
  "7":{"inputs":{"lora_name":"NSFW-22-L-e8.safetensors","strength_model":1,"strength_clip":1,"model":["2",0],"clip":["8",0]},"class_type":"LoraLoader","_meta":{"title":"NSFW L"}},
  "8":{"inputs":{"clip_name":"umt5_xxl_fp16.safetensors","type":"wan","device":"default"},"class_type":"CLIPLoader","_meta":{"title":"Load CLIP"}},
  "9":{"inputs":{"vae_name":"wan_2.1_vae.safetensors"},"class_type":"VAELoader","_meta":{"title":"Load VAE"}},
  "10":{"inputs":{"boolean":["11",0],"on_true":["5",0],"on_false":["1",0]},"class_type":"easy ifElse","_meta":{"title":"Is NSFW High"}},
  "11":{"inputs":{"value":"%is_nsfw%"},"class_type":"PrimitiveBoolean","_meta":{"title":"Is NSFW"}},
  "12":{"inputs":{"value":"%low_step%"},"class_type":"PrimitiveBoolean","_meta":{"title":"Low Step"}},
  "13":{"inputs":{"boolean":["11",0],"on_true":["7",0],"on_false":["2",0]},"class_type":"easy ifElse","_meta":{"title":"Is NSFW Low"}},
  "14":{"inputs":{"boolean":["12",0],"on_true":["3",0],"on_false":["10",0]},"class_type":"easy ifElse","_meta":{"title":"Low Step High"}},
  "15":{"inputs":{"boolean":["12",0],"on_true":["4",0],"on_false":["13",0]},"class_type":"easy ifElse","_meta":{"title":"Low Step Low"}},
  "16":{"inputs":{"text":["71",0],"clip":["70",0]},"class_type":"CLIPTextEncode","_meta":{"title":"Main Prompt"}},
  "18":{"inputs":{"string_a":"nsfwsks","string_b":["6",0],"delimiter":", "},"class_type":"StringConcatenate","_meta":{"title":"Concatenate"}},
  "19":{"inputs":{"text":["18",0],"clip":["7",1]},"class_type":"CLIPTextEncode","_meta":{"title":"NSFW PL"}},
  "20":{"inputs":{"value":"%zero_out_negative%"},"class_type":"PrimitiveBoolean","_meta":{"title":"Zero Out Negative"}},
  "21":{"inputs":{"text":"%negative_prompt%","clip":["8",0]},"class_type":"CLIPTextEncode","_meta":{"title":"Negative Prompt"}},
  "23":{"inputs":{"boolean_a":["12",0],"boolean_b":["20",0]},"class_type":"Logic Comparison OR","_meta":{"title":"Logic Comparison OR"}},
  "28":{"inputs":{"shift":8,"model":["14",0]},"class_type":"ModelSamplingSD3","_meta":{"title":"ModelSamplingSD3"}},
  "29":{"inputs":{"shift":8,"model":["15",0]},"class_type":"ModelSamplingSD3","_meta":{"title":"ModelSamplingSD3"}},
  "30":{"inputs":{"add_noise":"enable","noise_seed":"%seed%","steps":["32",0],"cfg":"%cfg%","sampler_name":"%sampler%","scheduler":"%scheduler%","start_at_step":0,"end_at_step":["33",0],"return_with_leftover_noise":"disable","model":["28",0],"positive":["34",0],"negative":["34",1],"latent_image":["34",2]},"class_type":"KSamplerAdvanced","_meta":{"title":"KSampler High"}},
  "31":{"inputs":{"add_noise":"disable","noise_seed":0,"steps":["32",0],"cfg":"%cfg%","sampler_name":"%sampler%","scheduler":"%scheduler%","start_at_step":["33",0],"end_at_step":["32",0],"return_with_leftover_noise":"disable","model":["29",0],"positive":["44",0],"negative":["34",1],"latent_image":["30",0]},"class_type":"KSamplerAdvanced","_meta":{"title":"KSampler Low"}},
  "32":{"inputs":{"value":"%steps%"},"class_type":"PrimitiveInt","_meta":{"title":"Steps"}},
  "33":{"inputs":{"a":["32",0],"b":2,"operation":"divide"},"class_type":"easy mathInt","_meta":{"title":"Math Int"}},
  "34":{"inputs":{"width":["66",1],"height":["66",2],"length":["43",0],"batch_size":1,"positive":["16",0],"negative":["73",0],"vae":["9",0],"start_image":["66",0]},"class_type":"WanImageToVideo","_meta":{"title":"WanImageToVideo High"}},
  "41":{"inputs":{"width":["66",1],"height":["66",2],"length":["43",0],"batch_size":1,"positive":["19",0],"negative":["73",0],"vae":["9",0],"start_image":["66",0]},"class_type":"WanImageToVideo","_meta":{"title":"WanImageToVideo Low"}},
  "43":{"inputs":{"value":"%length%"},"class_type":"PrimitiveInt","_meta":{"title":"Length"}},
  "44":{"inputs":{"boolean":["11",0],"on_true":["41",0],"on_false":["34",0]},"class_type":"easy ifElse","_meta":{"title":"Prompt Switch"}},
  "45":{"inputs":{"samples":["31",0],"vae":["9",0]},"class_type":"VAEDecode","_meta":{"title":"VAE Decode"}},
  "46":{"inputs":{"ckpt_name":"rife49.pth","clear_cache_after_n_frames":10,"multiplier":2,"fast_mode":true,"ensemble":true,"scale_factor":1,"frames":["45",0]},"class_type":"RIFE VFI","_meta":{"title":"RIFE VFI (recommend rife47 and rife49)"}},
  "49":{"inputs":{"boolean":["53",0],"on_true":["46",0],"on_false":["45",0]},"class_type":"easy ifElse","_meta":{"title":"If else"}},
  "50":{"inputs":{"boolean":["53",0],"on_true":["52",0],"on_false":["51",0]},"class_type":"easy ifElse","_meta":{"title":"If else"}},
  "51":{"inputs":{"value":16},"class_type":"PrimitiveInt","_meta":{"title":"Int"}},
  "52":{"inputs":{"value":24},"class_type":"PrimitiveInt","_meta":{"title":"Int"}},
  "53":{"inputs":{"value":"%interpolate%"},"class_type":"PrimitiveBoolean","_meta":{"title":"Interpolate with RIFE"}},
  "65":{"inputs":{"upscale_method":"lanczos","megapixels":"%mp%","image":["69",0]},"class_type":"ImageScaleToTotalPixels","_meta":{"title":"Scale Image to Total Pixels"}},
  "66":{"inputs":{"width":["67",4],"height":["67",5],"upscale_method":"nearest-exact","keep_proportion":"stretch","pad_color":"0, 0, 0","crop_position":"center","divisible_by":16,"device":"gpu","image":["69",0]},"class_type":"ImageResizeKJv2","_meta":{"title":"Resize Image v2"}},
  "67":{"inputs":{"image":["65",0]},"class_type":"Image Size to Number","_meta":{"title":"Image Size to Number"}},
  "69":{"inputs":{"url":"%img_url%","cache":true},"class_type":"LoadImageByUrl //Browser","_meta":{"title":"Load Image By URL"}},
  "70":{"inputs":{"boolean":["11",0],"on_true":["5",1],"on_false":["8",0]},"class_type":"easy ifElse","_meta":{"title":"If else"}},
  "71":{"inputs":{"boolean":["11",0],"on_true":["18",0],"on_false":["6",0]},"class_type":"easy ifElse","_meta":{"title":"If else"}},
  "72":{"inputs":{"conditioning":["16",0]},"class_type":"ConditioningZeroOut","_meta":{"title":"ConditioningZeroOut"}},
  "73":{"inputs":{"boolean":["23",0],"on_true":["72",0],"on_false":["21",0]},"class_type":"easy ifElse","_meta":{"title":"If else"}},
  "74":{"inputs":{"images":["49",0],"fps":["50",0]},"class_type":"CreateVideo","_meta":{"title":"Create Video"}},
  "75":{"inputs":{"filename_prefix":"video/ComfyUI","format":"mp4","codec":"h264","video":["74",0]},"class_type":"SaveVideo","_meta":{"title":"Save Video"}}
}
</script>

<script id="ace-template" type="application/json">
{
  "1": {
    "inputs": {
      "ckpt_name": "ace_step_v1_3.5b.safetensors"
    },
    "class_type": "CheckpointLoaderSimple",
    "_meta": {
      "title": "Load Checkpoint"
    }
  },
  "3": {
    "inputs": {
      "seconds": "%length%",
      "batch_size": 1
    },
    "class_type": "EmptyAceStepLatentAudio",
    "_meta": {
      "title": "EmptyAceStepLatentAudio"
    }
  },
  "7": {
    "inputs": {
      "tags": "%tags%",
      "lyrics": "%structure%",
      "lyrics_strength": 0.99,
      "clip": [
        "1",
        1
      ]
    },
    "class_type": "TextEncodeAceStepAudio",
    "_meta": {
      "title": "TextEncodeAceStepAudio"
    }
  },
  "8": {
    "inputs": {
      "seed": "%seed%",
      "steps": "%steps%",
      "cfg": "%cfg%",
      "sampler_name": "%sampler%",
      "scheduler": "%scheduler%",
      "denoise": 1,
      "model": [
        "11",
        0
      ],
      "positive": [
        "7",
        0
      ],
      "negative": [
        "9",
        0
      ],
      "latent_image": [
        "3",
        0
      ]
    },
    "class_type": "KSampler",
    "_meta": {
      "title": "KSampler"
    }
  },
  "9": {
    "inputs": {
      "conditioning": [
        "7",
        0
      ]
    },
    "class_type": "ConditioningZeroOut",
    "_meta": {
      "title": "ConditioningZeroOut"
    }
  },
  "10": {
    "inputs": {
      "shift": 5,
      "model": [
        "1",
        0
      ]
    },
    "class_type": "ModelSamplingSD3",
    "_meta": {
      "title": "ModelSamplingSD3"
    }
  },
  "11": {
    "inputs": {
      "model": [
        "10",
        0
      ],
      "operation": [
        "12",
        0
      ]
    },
    "class_type": "LatentApplyOperationCFG",
    "_meta": {
      "title": "ApplyOperationCFG"
    }
  },
  "12": {
    "inputs": {
      "multiplier": 1
    },
    "class_type": "LatentOperationTonemapReinhard",
    "_meta": {
      "title": "LatentOperationTonemapReinhard"
    }
  },
  "13": {
    "inputs": {
      "samples": [
        "8",
        0
      ],
      "vae": [
        "1",
        2
      ]
    },
    "class_type": "VAEDecodeAudio",
    "_meta": {
      "title": "VAEDecodeAudio"
    }
  },
  "14": {
    "inputs": {
      "filename_prefix": "audio/ComfyUI",
      "quality": "%quality%",
      "audioUI": "",
      "audio": [
        "13",
        0
      ]
    },
    "class_type": "SaveAudioOpus",
    "_meta": {
      "title": "Save Audio (Opus)"
    }
  }
}
</script>



  <script>
    const ENDPOINT = 'https://api.runpod.ai/v2/vpr9pkvlr7n873/runsync';
    const STATUS_ENDPOINT = ENDPOINT.replace('/runsync', '/status');
    const ACE_ENDPOINT = 'https://api.runpod.ai/v2/e1hyz03h6llhvn/runsync';
    const ACE_STATUS_ENDPOINT = ACE_ENDPOINT.replace('/runsync', '/status');
    const WAN_ENDPOINT = ACE_ENDPOINT;
    const WAN_STATUS_ENDPOINT = ACE_STATUS_ENDPOINT;
    const ACE_BASE_ENDPOINT = ACE_ENDPOINT.replace(/\/runsync$/, '');
    const ACE_FILE_ENDPOINT = `${ACE_BASE_ENDPOINT}/file`;
    const ACE_FILES_ENDPOINT = `${ACE_BASE_ENDPOINT}/files`;
    const ACE_RUNS_ENDPOINT = `${ACE_BASE_ENDPOINT}/runs`;
    const ACE_RUN_ENDPOINT = `${ACE_BASE_ENDPOINT}/run`;
    const SAMPLERS = [
      'euler', 'euler_ancestral', 'euler_cfg_pp', 'euler_ancestral_cfg_pp',
      'heunpp2', 'lcm', 'dpmpp_2m', 'dpmpp_2m_cfg_pp', 'dpmpp_2s_ancestral',
      'dpmpp_sde', 'dpmpp_2s_ancestral_cfg_pp', 'dpmpp_2m_sde_heun',
      'res_multistep', 'res_multistep_cfg_pp', 'res_multistep_ancestral_cfg_pp',
      'res_2s_ode', 'sa_solver_pece', 'ipndm', 'deis', 'er_sde', 'seeds_2',
      'gradient_estimation', 'gradient_estimation_cfg_pp', 'uni_pc'
    ];
    const SCHEDULERS = ['normal', 'simple', 'sgm_uniform', 'karras', 'exponential', 'beta', 'zeta', 'linear_quadratic', 'kl_optimal'];
    const LORA_OPTIONS = [
      'Smooth_Booster_v3.safetensors',
      'Matte_Skin_Illustrious_v4.safetensors',
      'noobai_vp10_stabilizer_v0.271_fp16.safetensors',
      'noobai_vpred_1_masterpieces.safetensors'
    ];
    const MAX_LORAS = 3;

    function genRandomSeed(){
      if(window.crypto && crypto.getRandomValues){
        const buf = new Uint32Array(1); crypto.getRandomValues(buf);
        return (buf[0] >>> 0) || 1;
      }
      return Math.floor(Math.random()*2147483647) + 1;
    }

    function populateSelect(sel, options, def){
      if(!sel) return;
      sel.innerHTML = options.map(o => `<option>${o}</option>`).join('');
      if(def) sel.value = def;
    }

    function formatDuration(ms){
      const minutes = Math.floor(ms / 60000);
      const seconds = Math.floor((ms % 60000) / 1000);
      const hundredths = Math.floor((ms % 1000) / 10);
      return `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}.${String(hundredths).padStart(2,'0')}`;
    }

    function makeTimer(el){
      let start = 0;
      let handle = null;
      function update(){
        if(!el) return;
        const diff = performance.now() - start;
        el.textContent = formatDuration(diff);
      }
      return {
        start(){
          start = performance.now();
          update();
          handle = setInterval(update, 30);
        },
        stop(){
          if(handle) clearInterval(handle);
          handle = null;
          update();
        }
      };
    }

    const qs = id => document.getElementById(id);
    const el = {
      apiKey: qs('apiKey'), model: qs('model'), prompt: qs('prompt'),
      negZero: qs('negZero'), negZeroRow: qs('negZeroRow'), negative: qs('negative'), negWrap: qs('negWrap'),
      rouweiWrap: qs('rouweiWrap'), rouweiPrefix: qs('rouweiPrefix'),
      dims: qs('dims'), customDimsWrap: qs('customDimsWrap'), customWidth: qs('customWidth'), customHeight: qs('customHeight'),
      batchSize: qs('batchSize'), batchSizeHint: qs('batchSizeHint'),
      rmbg: qs('rmbg'),
      mahiroToggle: qs('mahiroToggle'), apgToggle: qs('apgToggle'),
      addLoraBtn: qs('addLoraBtn'), loraList: qs('loraList'),
      seed: qs('seed'), seedHint: qs('seedHint'), steps: qs('steps'), cfg: qs('cfg'), cfgHint: qs('cfgHint'),
      sampler: qs('sampler'), scheduler: qs('scheduler'),
      hiresToggle: qs('hiresToggle'), hiresWrap: qs('hiresWrap'), hiresScale: qs('hiresScale'), hiresSteps: qs('hiresSteps'), hiresCfg: qs('hiresCfg'), hiresCfgHint: qs('hiresCfgHint'), hiresDenoise: qs('hiresDenoise'), hiresSampler: qs('hiresSampler'), hiresScheduler: qs('hiresScheduler'), hiresSeedCustom: qs('hiresSeedCustom'), hiresSeedWrap: qs('hiresSeedWrap'), hiresSeed: qs('hiresSeed'),
      runBtn: qs('runBtn'), curlBtn: qs('curlBtn'), resetBtn: qs('resetBtn'), clearBtn: qs('clearBtn'),
      status: qs('status'), timer: qs('timer'), gallery: qs('gallery'), debugReq: qs('debugReq'), debugResp: qs('debugResp'),
    };

    const timer = makeTimer(el.timer);
    const loraEntries = [];

    const clampNumber = (value, min, max) => Math.min(max, Math.max(min, value));
    let lastPresetDims = el.dims && el.dims.value && el.dims.value !== 'custom' ? el.dims.value : '1024x1024';
    let customDimsDirty = false;

    el.seedHintDefault = el.seedHint ? el.seedHint.textContent : '';

    function isRouweiSelected(){
      return !!(el.model && typeof el.model.value === 'string' && el.model.value.includes('rouwei'));
    }

    function updateNegativeVisibility(){
      const rouwei = isRouweiSelected();
      if(el.negWrap){
        el.negWrap.style.display = (el.negZero && el.negZero.checked && !rouwei) ? 'none' : '';
      }
    }

    function updateRouweiState(){
      const rouwei = isRouweiSelected();
      if(el.rouweiWrap){
        el.rouweiWrap.style.display = rouwei ? '' : 'none';
      }
      if(rouwei){
        if(el.negZero) el.negZero.checked = false;
        if(el.negZeroRow) el.negZeroRow.style.display = 'none';
      } else if(el.negZeroRow){
        el.negZeroRow.style.display = '';
      }
      updateNegativeVisibility();
    }

    function clampLoraStrength(value){
      let v = parseFloat(value);
      if(!Number.isFinite(v)) v = 0.6;
      if(v < 0.01) v = 0.01;
      if(v > 1) v = 1;
      return Math.round(v * 100) / 100;
    }

    function formatLoraStrength(value){
      const clamped = clampLoraStrength(value);
      let str = clamped.toFixed(2);
      str = str.replace(/(\.\d*?)0+$/, '$1').replace(/\.$/, '');
      return str;
    }

    function updateLoraStrengthInput(input){
      if(!input) return;
      input.value = formatLoraStrength(input.value || '0.6');
    }

    function updateAddLoraState(){
      if(!el.addLoraBtn) return;
      el.addLoraBtn.disabled = loraEntries.length >= MAX_LORAS;
    }

    function removeLoraEntry(entry){
      const idx = loraEntries.indexOf(entry);
      if(idx !== -1) loraEntries.splice(idx, 1);
      if(entry && entry.wrap && entry.wrap.parentNode){
        entry.wrap.parentNode.removeChild(entry.wrap);
      }
      updateAddLoraState();
    }

    function createLoraEntry(initial = {}){
      if(!el.loraList || loraEntries.length >= MAX_LORAS) return null;
      const wrap = document.createElement('div');
      wrap.className = 'lora-entry';

      const entry = { wrap, toggle: null, select: null, strength: null };

      const top = document.createElement('div');
      top.className = 'lora-entry-top';
      const toggleRow = document.createElement('div');
      toggleRow.className = 'lora-toggle';
      const switchLabel = document.createElement('label');
      switchLabel.className = 'switch';
      const toggleInput = document.createElement('input');
      toggleInput.type = 'checkbox';
      toggleInput.checked = initial.toggle !== undefined ? !!initial.toggle : true;
      const track = document.createElement('span');
      track.className = 'track';
      const thumb = document.createElement('span');
      thumb.className = 'thumb';
      track.appendChild(thumb);
      switchLabel.appendChild(toggleInput);
      switchLabel.appendChild(track);
      const toggleHint = document.createElement('span');
      toggleHint.className = 'hint';
      toggleHint.textContent = 'Enabled';
      toggleRow.appendChild(switchLabel);
      toggleRow.appendChild(toggleHint);
      top.appendChild(toggleRow);

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'lora-remove';
      removeBtn.setAttribute('aria-label', 'Remove LoRA');
      removeBtn.innerHTML = '&times;';
      top.appendChild(removeBtn);
      wrap.appendChild(top);

      const unique = Math.random().toString(36).slice(2, 9);
      const selectId = `lora-name-${unique}`;
      const strengthId = `lora-strength-${unique}`;

      const nameLabel = document.createElement('label');
      nameLabel.setAttribute('for', selectId);
      nameLabel.textContent = 'LoRA';
      wrap.appendChild(nameLabel);

      const select = document.createElement('select');
      select.id = selectId;
      for(const opt of LORA_OPTIONS){
        const optionEl = document.createElement('option');
        optionEl.value = opt;
        optionEl.textContent = opt;
        select.appendChild(optionEl);
      }
      if(initial.name && LORA_OPTIONS.includes(initial.name)){
        select.value = initial.name;
      }
      wrap.appendChild(select);

      const strengthLabel = document.createElement('label');
      strengthLabel.setAttribute('for', strengthId);
      strengthLabel.textContent = 'Strength';
      wrap.appendChild(strengthLabel);

      const strengthInput = document.createElement('input');
      strengthInput.type = 'number';
      strengthInput.id = strengthId;
      strengthInput.min = '0.01';
      strengthInput.max = '1.00';
      strengthInput.step = '0.01';
      strengthInput.value = initial.strength !== undefined ? String(initial.strength) : '0.6';
      updateLoraStrengthInput(strengthInput);
      strengthInput.addEventListener('change', () => updateLoraStrengthInput(strengthInput));
      wrap.appendChild(strengthInput);

      entry.toggle = toggleInput;
      entry.select = select;
      entry.strength = strengthInput;

      removeBtn.addEventListener('click', () => removeLoraEntry(entry));

      loraEntries.push(entry);
      el.loraList.appendChild(wrap);
      updateAddLoraState();
      return entry;
    }

    function clearLoras(){
      while(loraEntries.length){
        removeLoraEntry(loraEntries[0]);
      }
      if(el.loraList) el.loraList.innerHTML = '';
      updateAddLoraState();
    }

    function updateCustomDimsVisibility(){
      if(!el.customDimsWrap || !el.dims) return;
      const isCustom = el.dims.value === 'custom';
      el.customDimsWrap.style.display = isCustom ? '' : 'none';
    }

    function updateBatchSizeDisplay(){
      if(!el.batchSize) return 1;
      let raw = parseInt(el.batchSize.value || '1', 10);
      if(!Number.isFinite(raw)) raw = 1;
      raw = clampNumber(raw, 1, 4);
      el.batchSize.value = raw;
      if(el.batchSizeHint){
        el.batchSizeHint.textContent = `${raw} image${raw === 1 ? '' : 's'} per run`;
      }
      return raw;
    }

    if(el.customWidth) el.customWidth.addEventListener('input', () => { customDimsDirty = true; });
    if(el.customHeight) el.customHeight.addEventListener('input', () => { customDimsDirty = true; });

    if(el.batchSize) el.batchSize.addEventListener('input', updateBatchSizeDisplay);

    if(el.dims) el.dims.addEventListener('change', () => {
      if(el.dims.value === 'custom'){
        if(!customDimsDirty && lastPresetDims){
          const [presetW, presetH] = lastPresetDims.split('x').map(n => parseInt(n, 10));
          if(el.customWidth && !Number.isNaN(presetW)) el.customWidth.value = clampNumber(presetW, 512, 2048);
          if(el.customHeight && !Number.isNaN(presetH)) el.customHeight.value = clampNumber(presetH, 512, 2048);
        }
      } else {
        lastPresetDims = el.dims.value;
      }
      updateCustomDimsVisibility();
    });

    updateCustomDimsVisibility();
    updateBatchSizeDisplay();

    populateSelect(el.sampler, SAMPLERS, 'euler');
    populateSelect(el.scheduler, SCHEDULERS, 'normal');
    populateSelect(el.hiresSampler, SAMPLERS, 'euler');
    populateSelect(el.hiresScheduler, SCHEDULERS, 'normal');
  
    function setCfgRangeForSampler(samplerSel, cfgInput, hintEl){
      const isCfgPP = samplerSel.value.includes('cfg_pp');
      if(isCfgPP){
        cfgInput.min = 0.5; cfgInput.max = 3.0; cfgInput.step = 0.1;
        if(+cfgInput.value < 0.5 || +cfgInput.value > 3.0) cfgInput.value = 1.0;
        hintEl.textContent = 'Range 0.5–3.0 (cfg_pp)';
      } else {
        cfgInput.min = 4.0; cfgInput.max = 6.0; cfgInput.step = 0.1;
        if(+cfgInput.value < 4.0 || +cfgInput.value > 6.0) cfgInput.value = 5.0;
        hintEl.textContent = 'Range 4.0–6.0 (non cfg_pp)';
      }
    }

    setCfgRangeForSampler(el.sampler, el.cfg, el.cfgHint);
    setCfgRangeForSampler(el.hiresSampler, el.hiresCfg, el.hiresCfgHint);

    el.sampler.addEventListener('change', () => setCfgRangeForSampler(el.sampler, el.cfg, el.cfgHint));
    el.hiresSampler.addEventListener('change', () => setCfgRangeForSampler(el.hiresSampler, el.hiresCfg, el.hiresCfgHint));

    if(el.negZero) el.negZero.addEventListener('change', updateNegativeVisibility);

    if(el.model) el.model.addEventListener('change', updateRouweiState);

    if(el.addLoraBtn) el.addLoraBtn.addEventListener('click', () => { createLoraEntry(); });

    updateAddLoraState();
    updateRouweiState();

    el.hiresToggle.addEventListener('change', () => {
      el.hiresWrap.style.display = el.hiresToggle.checked ? '' : 'none';
    });

    el.hiresSeedCustom.addEventListener('change', () => {
      el.hiresSeedWrap.style.display = el.hiresSeedCustom.checked ? '' : 'none';
    });

    if(el.resetBtn) el.resetBtn.addEventListener('click', () => {
      // Minimal reset to spec defaults
      if(el.prompt) el.prompt.value = '';
      if(el.negative) el.negative.value = '';
      if(el.negZero) el.negZero.checked = false;
      if(el.negWrap) el.negWrap.style.display = '';
      if(el.rouweiPrefix) el.rouweiPrefix.value = '';
      if(el.dims) el.dims.value = '1024x1024';
      lastPresetDims = '1024x1024';
      customDimsDirty = false;
      if(el.customWidth) el.customWidth.value = 1024;
      if(el.customHeight) el.customHeight.value = 1024;
      updateCustomDimsVisibility();
      if(el.batchSize){ el.batchSize.value = 1; updateBatchSizeDisplay(); }
      if(el.rmbg) el.rmbg.checked = false;
      if(el.mahiroToggle) el.mahiroToggle.checked = true;
      if(el.apgToggle) el.apgToggle.checked = true;
      clearLoras();
      if(el.seed) el.seed.value = -1;
      if(el.steps) el.steps.value = 25;
      if(el.cfg) el.cfg.value = 5.0;
      if(el.sampler && el.cfg){
        el.sampler.value = 'euler';
        setCfgRangeForSampler(el.sampler, el.cfg, el.cfgHint);
      }
      if(el.scheduler) el.scheduler.value = 'normal';
      if(el.hiresToggle){ el.hiresToggle.checked = false; if(el.hiresWrap) el.hiresWrap.style.display = 'none'; }
      if(el.hiresScale) el.hiresScale.value = 1.50;
      if(el.hiresSteps) el.hiresSteps.value = 20;
      if(el.hiresCfg){
        el.hiresCfg.value = 5.0;
        if(el.hiresSampler) setCfgRangeForSampler(el.hiresSampler, el.hiresCfg, el.hiresCfgHint);
      }
      if(el.hiresDenoise) el.hiresDenoise.value = 0.56;
      if(el.hiresSampler) el.hiresSampler.value='euler';
      if(el.hiresScheduler) el.hiresScheduler.value='normal';
      if(el.hiresSeedCustom){ el.hiresSeedCustom.checked = false; if(el.hiresSeedWrap) el.hiresSeedWrap.style.display = 'none'; }
      if(el.hiresSeed) el.hiresSeed.value=-1;
      if(el.seedHint) el.seedHint.textContent = el.seedHintDefault;
      updateRouweiState();
      el.status.textContent = 'Reset to defaults';
    });

    el.clearBtn.addEventListener('click', () => { el.gallery.innerHTML = ''; el.status.textContent = 'Gallery cleared'; });

    function getWorkflowTemplate(){
      const raw = document.getElementById('workflow-template').textContent.trim();
      return JSON.parse(raw);
    }

    function getAceTemplate(){
      const el = document.getElementById('ace-template');
      if(!el) throw new Error('ACE template missing');
      return JSON.parse(el.textContent.trim());
    }

    function deepReplacePlaceholders(obj, map){
      if (obj === null || obj === undefined) return obj;
      if (typeof obj === 'string'){
        // Replace only if the entire string is a placeholder like %name%
        const m = obj.match(/^%([a-zA-Z0-9_]+)%$/);
        if (m){
          const key = m[1];
          if (!(key in map)) throw new Error(`Missing placeholder: ${key}`);
          return map[key];
        }
        return obj;
      } else if (Array.isArray(obj)){
        return obj.map(v => deepReplacePlaceholders(v, map));
      } else if (typeof obj === 'object'){
        const out = Array.isArray(obj) ? [] : {};
        for (const k of Object.keys(obj)) out[k] = deepReplacePlaceholders(obj[k], map);
        return out;
      }
      return obj;
    }

    function buildPlaceholderMap(){
      let width = 1024;
      let height = 1024;
      if(el.dims){
        if(el.dims.value === 'custom'){
          if(el.customWidth){
            const customWidth = parseInt(el.customWidth.value || '1024', 10);
            if(!Number.isNaN(customWidth)) width = clampNumber(customWidth, 512, 2048);
          }
          if(el.customHeight){
            const customHeight = parseInt(el.customHeight.value || '1024', 10);
            if(!Number.isNaN(customHeight)) height = clampNumber(customHeight, 512, 2048);
          }
        } else if(el.dims.value){
          const [parsedW, parsedH] = el.dims.value.split('x').map(n => parseInt(n, 10));
          if(!Number.isNaN(parsedW)) width = parsedW;
          if(!Number.isNaN(parsedH)) height = parsedH;
        }
      }
      const batchSizeVal = updateBatchSizeDisplay();
      const rouweiSelected = isRouweiSelected();
      const negZeroToggle = el.negZero ? !!el.negZero.checked : false;
      const negZero = rouweiSelected ? false : negZeroToggle;
      const hiresOn = !!(el.hiresToggle && el.hiresToggle.checked);
      let seedVal = parseInt((el.seed && el.seed.value) || '-1', 10);
      if(seedVal === -1){
        seedVal = genRandomSeed();
        if(el.seedHint) el.seedHint.textContent = `Random seed: ${seedVal}`;
      } else if(el.seedHint){
        el.seedHint.textContent = el.seedHintDefault;
      }
      const useHiresSeed = el.hiresSeedCustom && el.hiresSeedCustom.checked;
      const hiresSeed = useHiresSeed && el.hiresSeed ? parseInt(el.hiresSeed.value || '-1', 10) : seedVal;
      const enableMahiro = el.mahiroToggle ? !!el.mahiroToggle.checked : true;
      const enableApg = el.apgToggle ? !!el.apgToggle.checked : true;
      const rouweiPrefix = el.rouweiPrefix ? el.rouweiPrefix.value || '' : '';
      const modelValue = el.model ? el.model.value : '';
      const promptText = el.prompt ? el.prompt.value || '' : '';
      const negativeText = el.negative ? el.negative.value || '' : '';
      const samplerValue = el.sampler ? el.sampler.value : '';
      const schedulerValue = el.scheduler ? el.scheduler.value : '';
      const hiresSamplerValue = el.hiresSampler ? el.hiresSampler.value : '';
      const hiresSchedulerValue = el.hiresScheduler ? el.hiresScheduler.value : '';
      const hiresScaleVal = el.hiresScale ? parseFloat(el.hiresScale.value || '1.50') : 1.5;
      const hiresStepsVal = parseInt((el.hiresSteps && el.hiresSteps.value) || '20', 10);
      const hiresCfgVal = parseFloat((el.hiresCfg && el.hiresCfg.value) || '5.0');
      const hiresDenoiseVal = parseFloat((el.hiresDenoise && el.hiresDenoise.value) || '0.56');
      const stepsVal = parseInt((el.steps && el.steps.value) || '25', 10);
      const cfgVal = parseFloat((el.cfg && el.cfg.value) || '5.0');
      const hiresfixDenoise = hiresDenoiseVal;
      const loras = loraEntries.map(entry => ({
        toggle: !!(entry.toggle && entry.toggle.checked),
        name: entry.select ? entry.select.value : '',
        strength: clampLoraStrength(entry.strength ? entry.strength.value : 0.6)
      }));
      const defaultLora = { toggle: false, name: '', strength: 0.6 };
      while(loras.length < MAX_LORAS){
        loras.push({ ...defaultLora });
      }
      return {
        model: modelValue,
        prompt: promptText,
        rouwei_prefix: rouweiPrefix,
        neg_zero_out: negZero,
        negative_prompt: negZero ? '' : negativeText,
        width: width, height: height,
        batch_size: batchSizeVal,
        remove_bg: !!(el.rmbg && el.rmbg.checked),
        seed: seedVal,
        steps: stepsVal,
        cfg: cfgVal,
        sampler: samplerValue,
        scheduler: schedulerValue,
        enable_mahiro: enableMahiro,
        enable_apg: enableApg,
        use_hiresfix: hiresOn,
        hiresfix_scale_by: hiresScaleVal,
        hiresfix_seed: hiresSeed,
        hiresfix_steps: hiresStepsVal,
        hiresfix_cfg: hiresCfgVal,
        hiresfix_sampler: hiresSamplerValue,
        hiresfix_scheduler: hiresSchedulerValue,
        hiresfix_denoise: hiresfixDenoise,
        lora1_toggle: loras[0].toggle,
        lora1_name: loras[0].name,
        lora1_strength: loras[0].strength,
        lora2_toggle: loras[1].toggle,
        lora2_name: loras[1].name,
        lora2_strength: loras[1].strength,
        lora3_toggle: loras[2].toggle,
        lora3_name: loras[2].name,
        lora3_strength: loras[2].strength,
      };
    }

    function buildPayload(){
      const template = getWorkflowTemplate();
      const map = buildPlaceholderMap();
      // Map keys used in placeholders are without % per deepReplacePlaceholders
      const resolved = deepReplacePlaceholders(template, map);
      return { input: { workflow: resolved } };
    }

    function makeCurl(payload){
      const key = el.apiKey.value.trim() || '<api_key>';
      return [
        'curl -sX POST',
        `  -H "Authorization: Bearer ${key}"`,
        '  -H "Content-Type: application/json"',
        `  -d '${JSON.stringify(payload)}'`,
        `  ${ENDPOINT}`
      ].join(' \n');
    }

    async function pollStatus(key, id, debugEl, statusEndpoint = STATUS_ENDPOINT){
      let attempt = 0;
      while(true){
        attempt++;
        const resp = await fetch(`${statusEndpoint}/${id}`, {
          headers: { 'Authorization': `Bearer ${key}` }
        });
        const data = await resp.json();
        if(debugEl) debugEl.textContent = JSON.stringify(data, null, 2);
        if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
        if(data.status === 'COMPLETED') return data;
        if(data.status === 'FAILED' || data.status === 'CANCELLED') throw new Error(`Job status: ${data.status}`);
        const delay = Number(data.delayTime) || Math.min(1000 * attempt, 5000);
        await new Promise(r => setTimeout(r, delay));
      }
    }

    function setBusy(b){
      el.runBtn.disabled = b;
      el.status.textContent = b? 'Running…' : 'Idle';
      if(el.timer){ b ? timer.start() : timer.stop(); }
    }

    async function run(){
      const key = el.apiKey.value.trim();
      if (!key){ el.status.textContent = 'API key required'; return; }
      if(isRouweiSelected() && (!el.rouweiPrefix || !el.rouweiPrefix.value.trim())){
        el.status.innerHTML = '<span class="error">Rouwei prefix required when using rouwei_v080Vpred.safetensors</span>';
        return;
      }
      try{
        setBusy(true);
        const payload = buildPayload();
        el.debugReq.textContent = JSON.stringify(payload, null, 2);
        const resp = await fetch(ENDPOINT, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${key}`, 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        let data = await resp.json();
        el.debugResp.textContent = JSON.stringify(data, null, 2);

        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        if (data.status !== 'COMPLETED'){
          if(data.id){
            el.status.textContent = 'Waiting for job...';
            data = await pollStatus(key, data.id, el.debugResp);
          } else {
            throw new Error(`Job status: ${data.status}`);
          }
        }
        if (!data.output || !Array.isArray(data.output.images) || data.output.images.length === 0) throw new Error('No images in response');

        for (const item of data.output.images){
          if (item.type === 'base64' && item.data){
            const imgUrl = `data:image/avif;base64,${item.data}`;
            addShot(imgUrl, item.filename || 'image.avif');
          } else if (item.type === 's3_url' && item.data){
            addShot(item.data, item.filename || 'image.avif');
          }
        }
        el.status.textContent = `Completed in ${data.executionTime ?? '?'} ms`;
      } catch(err){
        console.error(err);
        el.status.innerHTML = `<span class="error">Error: ${err.message}</span>`;
      } finally{ setBusy(false); }
    }

    function addShot(url, name){
      const wrap = document.createElement('div');
      wrap.className = 'shot';
      const header = document.createElement('div'); header.className = 'header';
      header.innerHTML = `<header><span class="mono" title="${name}">${name}</span><a class="btn" href="${url}" download>Download</a></header>`;
      wrap.appendChild(header);
      const img = new Image(); img.loading = 'lazy'; img.src = url; img.addEventListener('click', ()=>openLightbox(url)); wrap.appendChild(img);
      el.gallery.prepend(wrap);
    }

    el.runBtn.addEventListener('click', (e)=>{ e.preventDefault(); run(); });

    el.curlBtn.addEventListener('click', ()=>{
      const payload = buildPayload();
      const text = makeCurl(payload);
      navigator.clipboard.writeText(text).then(()=>{ el.status.textContent = 'cURL copied'; });
    });

    // --- ACE-Step helpers ---
    const ace = id => document.getElementById(id);
    const acel = {
      apiKey: document.getElementById('apiKey'),
      tags: ace('ace-tags'),
      structure: ace('ace-structure'),
      minutes: ace('ace-minutes'),
      seconds: ace('ace-seconds'),
      seed: ace('ace-seed'), seedHint: ace('ace-seedHint'),
      steps: ace('ace-steps'), cfg: ace('ace-cfg'),
      sampler: ace('ace-sampler'), scheduler: ace('ace-scheduler'),
      quality: ace('ace-quality'),
      runBtn: ace('ace-run'), curlBtn: ace('ace-curl'), resetBtn: ace('ace-reset'), clearBtn: ace('ace-clear'),
      status: ace('ace-status'), timer: ace('ace-timer'), gallery: ace('ace-gallery'),
      debugReq: ace('ace-debugReq'), debugResp: ace('ace-debugResp'),
    };

    const acetimer = makeTimer(acel.timer);
    const aceBlobCleanups = [];

    if(acel.sampler) populateSelect(acel.sampler, SAMPLERS, 'res_multistep');
    if(acel.scheduler) populateSelect(acel.scheduler, SCHEDULERS, 'linear_quadratic');

    acel.seedHintDefault = acel.seedHint ? acel.seedHint.textContent : '';

    function clampSeconds(val){
      let s = parseFloat(val);
      if(!Number.isFinite(s)) s = 0;
      if(s < 0) s = 0;
      if(s > 59.999) s = 59.999;
      return s;
    }

    function parseAceDurationToSeconds(value){
      if(value === null || value === undefined) return null;
      if(typeof value === 'number'){ return Number.isFinite(value) && value > 0 ? value : null; }
      if(typeof value !== 'string') return null;
      const trimmed = value.trim();
      if(!trimmed) return null;
      if(/^\d+(?:\.\d+)?$/.test(trimmed)){ return parseFloat(trimmed); }
      const colonParts = trimmed.split(':');
      if(colonParts.length > 1){
        let total = 0;
        let multiplier = 1;
        while(colonParts.length){
          const part = colonParts.pop();
          if(part === undefined) break;
          const num = parseFloat(part);
          if(!Number.isFinite(num)) return null;
          total += num * multiplier;
          multiplier *= 60;
        }
        return total > 0 ? total : null;
      }
      const unitMatch = trimmed.match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|sec|secs|seconds|m|min|minutes|h|hr|hrs|hours)$/i);
      if(unitMatch){
        const magnitude = parseFloat(unitMatch[1]);
        if(!Number.isFinite(magnitude) || magnitude <= 0) return null;
        const unit = unitMatch[2].toLowerCase();
        if(unit === 'ms') return magnitude / 1000;
        if(unit === 's' || unit === 'sec' || unit === 'secs' || unit === 'seconds') return magnitude;
        if(unit === 'm' || unit === 'min' || unit === 'minutes') return magnitude * 60;
        if(unit === 'h' || unit === 'hr' || unit === 'hrs' || unit === 'hours') return magnitude * 3600;
      }
      const simpleMatch = trimmed.match(/^([0-9]+)m(?:\s*([0-9]+(?:\.[0-9]+)?)s)?$/i);
      if(simpleMatch){
        const minutes = parseFloat(simpleMatch[1]);
        const seconds = simpleMatch[2] ? parseFloat(simpleMatch[2]) : 0;
        if(Number.isFinite(minutes) && minutes >= 0 && Number.isFinite(seconds) && seconds >= 0){
          const total = minutes * 60 + seconds;
          return total > 0 ? total : null;
        }
      }
      return null;
    }

    function findAceDurationSeconds(obj, visited = new WeakSet()){
      if(!obj || typeof obj !== 'object') return null;
      if(visited.has(obj)) return null;
      visited.add(obj);
      const candidateKeys = [
        'duration', 'durationSeconds', 'duration_seconds', 'duration_sec', 'seconds', 'secs',
        'length', 'length_seconds', 'lengthSeconds', 'audio_seconds', 'audioSeconds',
        'total_seconds', 'time_seconds', 'time'
      ];
      for(const key of candidateKeys){
        if(Object.prototype.hasOwnProperty.call(obj, key)){
          const parsed = parseAceDurationToSeconds(obj[key]);
          if(parsed) return parsed;
        }
      }
      const nestedKeys = ['metadata', 'meta', 'info', 'details', 'extra', 'attributes', 'audioInfo', 'audio_info'];
      for(const key of nestedKeys){
        if(!Object.prototype.hasOwnProperty.call(obj, key)) continue;
        const value = obj[key];
        if(Array.isArray(value)){
          for(const item of value){
            const found = findAceDurationSeconds(item, visited);
            if(found) return found;
          }
        } else if(value && typeof value === 'object'){
          const found = findAceDurationSeconds(value, visited);
          if(found) return found;
        }
      }
      return null;
    }

    function formatAceClock(seconds){
      if(!Number.isFinite(seconds) || seconds <= 0) return null;
      const totalSeconds = Math.floor(seconds);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const secs = totalSeconds % 60;
      const secStr = String(secs).padStart(2, '0');
      if(hours > 0){
        return `${hours}:${String(minutes).padStart(2, '0')}:${secStr}`;
      }
      return `${minutes}:${secStr}`;
    }

    function formatAceSecondsValue(seconds){
      if(!Number.isFinite(seconds) || seconds <= 0) return null;
      let decimals = 0;
      if(seconds < 10) decimals = 2;
      else if(seconds < 100) decimals = 1;
      let str = seconds.toFixed(decimals);
      if(decimals > 0) str = str.replace(/\.0+$/, '').replace(/(\.\d*?)0+$/, '$1');
      return str;
    }

    function formatAceDurationLabel(seconds){
      if(!Number.isFinite(seconds) || seconds <= 0) return null;
      const clock = formatAceClock(seconds);
      const precise = formatAceSecondsValue(seconds);
      if(clock && precise) return `Length: ${clock} (${precise}s)`;
      if(clock) return `Length: ${clock}`;
      if(precise) return `Length: ${precise}s`;
      return null;
    }

    function guessAceFilenameFromUrl(url){
      try{
        const u = new URL(url);
        const parts = u.pathname.split('/').filter(Boolean);
        const name = parts.pop();
        if(name) return name;
      }catch(err){
        if(typeof url === 'string'){
          const tail = url.split('/').filter(Boolean).pop();
          if(tail) return tail;
        }
      }
      return 'audio.ogg';
    }

    function guessAceFilenameFromDataUri(uri){
      const match = /^data:audio\/([^;,]+)/i.exec(uri || '');
      if(match && match[1]){
        const ext = match[1].split('/').pop();
        if(ext) return `audio.${ext}`;
      }
      return 'audio.ogg';
    }

    function finalizeAceSource(src, context, fallbackDuration){
      if(!src) return src;
      let duration = null;
      if(Number.isFinite(fallbackDuration) && fallbackDuration > 0){
        duration = fallbackDuration;
      } else if(typeof context === 'number'){
        duration = context;
      } else if(context && typeof context === 'object'){
        duration = findAceDurationSeconds(context);
      }
      if(Number.isFinite(duration) && duration > 0) src.duration = duration;
      return src;
    }

    function parseContentDispositionFilename(header){
      if(!header) return null;
      const star = header.match(/filename\*=UTF-8''([^;]+)/i);
      if(star && star[1]){
        try{ return decodeURIComponent(star[1]); }
        catch(err){ return star[1]; }
      }
      const quoted = header.match(/filename="?([^";]+)"?/i);
      if(quoted && quoted[1]) return quoted[1];
      return null;
    }

    if(acel.seconds){
      acel.seconds.addEventListener('change', ()=>{
        const s = clampSeconds(acel.seconds.value || '0');
        acel.seconds.value = Number.isInteger(s) ? String(Math.trunc(s)) : s.toFixed(3);
      });
    }

    if(acel.minutes){
      acel.minutes.addEventListener('change', ()=>{
        let m = parseInt(acel.minutes.value || '0', 10);
        if(!Number.isFinite(m) || m < 0) m = 0;
        acel.minutes.value = m;
      });
    }

    function getAceLengthSeconds(){
      const minutes = Math.max(0, parseInt(acel.minutes && acel.minutes.value || '0', 10) || 0);
      const seconds = clampSeconds(acel.seconds && acel.seconds.value || '0');
      return Math.round((minutes * 60 + seconds) * 1000) / 1000;
    }

    function buildAcePlaceholderMap(){
      let seedVal = parseInt(acel.seed && acel.seed.value || '-1', 10);
      if(!Number.isFinite(seedVal)) seedVal = -1;
      if(seedVal === -1){
        seedVal = genRandomSeed();
        if(acel.seedHint) acel.seedHint.textContent = `Random seed: ${seedVal}`;
      } else if(acel.seedHint){
        acel.seedHint.textContent = acel.seedHintDefault;
      }
      const rawSteps = parseInt(acel.steps && (acel.steps.value || '50'), 10);
      const stepsVal = Number.isFinite(rawSteps) ? Math.min(75, Math.max(25, rawSteps)) : 50;
      const rawCfg = parseFloat(acel.cfg && (acel.cfg.value || '5.0'));
      const cfgVal = Number.isFinite(rawCfg) ? Math.max(1.0, rawCfg) : 5.0;
      return {
        tags: acel.tags && acel.tags.value || '',
        structure: acel.structure && acel.structure.value || '',
        length: getAceLengthSeconds(),
        seed: seedVal,
        steps: stepsVal,
        cfg: Number.isFinite(cfgVal) ? cfgVal : 5.0,
        sampler: acel.sampler && acel.sampler.value || 'res_multistep',
        scheduler: acel.scheduler && acel.scheduler.value || 'linear_quadratic',
        quality: acel.quality && acel.quality.value || '128k',
      };
    }

    function buildAcePayload(){
      const template = getAceTemplate();
      const map = buildAcePlaceholderMap();
      const resolved = deepReplacePlaceholders(template, map);
      return { input: { workflow: resolved } };
    }

    function makeAceCurl(payload){
      const key = (acel.apiKey && acel.apiKey.value || '').trim() || '<api_key>';
      return [
        'curl -sX POST',
        `  -H "Authorization: Bearer ${key}"`,
        '  -H "Content-Type: application/json"',
        `  -d '${JSON.stringify(payload)}'`,
        `  ${ACE_ENDPOINT}`
      ].join(' \n');
    }

    function setAceBusy(b){
      if(acel.runBtn) acel.runBtn.disabled = b;
      if(acel.status){
        if(b){
          acel.status.textContent = 'Running…';
        } else if(acel.status.textContent === 'Running…' || acel.status.textContent === 'Fetching audio files…'){
          acel.status.textContent = 'Idle';
        }
      }
      if(acel.timer){ b ? acetimer.start() : acetimer.stop(); }
    }

    function aceItemToSource(item){
      if(!item) return null;
      const audioPattern = /\.(?:ogg|opus|wav|mp3|m4a|flac)(?:\?.*)?$/i;
      if(typeof item === 'string'){
        const trimmed = item.trim();
        if(trimmed.startsWith('data:audio/')){
          return { kind: 'data', url: trimmed, filename: guessAceFilenameFromDataUri(trimmed) };
        }
        if(/^https?:/i.test(trimmed) && audioPattern.test(trimmed)){
          return { kind: 'url', url: trimmed, filename: guessAceFilenameFromUrl(trimmed) };
        }
        return null;
      }
      if(Array.isArray(item)){
        // Arrays are handled by extractAceAudios walker, but keep a fallback
        for(const entry of item){
          const found = aceItemToSource(entry);
          if(found) return found;
        }
        return null;
      }
      if(typeof item !== 'object') return null;

      const filename = item.filename || item.file_name || item.name || item.originalName || null;
      const typeRaw = item.type || item.kind || '';
      const contentTypeRaw = item.content_type || item.contentType || item.mime || '';
      const lowerType = typeof typeRaw === 'string' ? typeRaw.toLowerCase() : '';
      const lowerContentType = typeof contentTypeRaw === 'string' ? contentTypeRaw.toLowerCase() : '';
      const fallbackDuration = findAceDurationSeconds(item);

      if(lowerType === 'base64' && item.data){
        const mime = lowerContentType || 'audio/ogg';
        return finalizeAceSource({
          kind: 'data',
          url: `data:${mime};base64,${item.data}`,
          filename: filename || guessAceFilenameFromDataUri(`data:${mime}`)
        }, item, fallbackDuration);
      }

      const candidateKeys = ['url', 'data', 'path', 'location', 'signed_url', 'signedUrl', 'downloadUrl', 'download_url'];
      for(const key of candidateKeys){
        const value = item[key];
        if(typeof value !== 'string') continue;
        const trimmed = value.trim();
        if(trimmed.startsWith('data:audio/')){
          return finalizeAceSource({ kind: 'data', url: trimmed, filename: filename || guessAceFilenameFromDataUri(trimmed) }, item, fallbackDuration);
        }
        if(/^https?:/i.test(trimmed) && (audioPattern.test(trimmed) || lowerType.includes('audio') || lowerContentType.startsWith('audio'))){
          return finalizeAceSource({ kind: 'url', url: trimmed, filename: filename || guessAceFilenameFromUrl(trimmed) }, item, fallbackDuration);
        }
      }

      if((lowerType && lowerType.startsWith('audio')) || (lowerContentType && lowerContentType.startsWith('audio'))){
        if(item.data && typeof item.data === 'string'){
          if(item.data.startsWith('http')){
            return finalizeAceSource({ kind: 'url', url: item.data, filename: filename || guessAceFilenameFromUrl(item.data) }, item, fallbackDuration);
          }
          if(item.data.startsWith('data:audio/')){
            return finalizeAceSource({ kind: 'data', url: item.data, filename: filename || guessAceFilenameFromDataUri(item.data) }, item, fallbackDuration);
          }
          return finalizeAceSource({
            kind: 'data',
            url: `data:${lowerContentType || lowerType};base64,${item.data}`,
            filename: filename || guessAceFilenameFromDataUri(`data:${lowerContentType || lowerType}`)
          }, item, fallbackDuration);
        }
      }

      if(item.bucket && item.key && typeof item.bucket === 'string' && typeof item.key === 'string'){
        const s3Url = item.key.startsWith('http') ? item.key : `https://${item.bucket}.s3.amazonaws.com/${item.key.replace(/^\//, '')}`;
        if(/^https?:/i.test(s3Url)){
          return finalizeAceSource({ kind: 'url', url: s3Url, filename: filename || guessAceFilenameFromUrl(s3Url) }, item, fallbackDuration);
        }
      }

      if(item.data && typeof item.data === 'object'){
        const nested = aceItemToSource(item.data);
        if(nested){
          if((!Number.isFinite(nested.duration) || nested.duration <= 0) && Number.isFinite(fallbackDuration) && fallbackDuration > 0){
            nested.duration = fallbackDuration;
          }
          return nested;
        }
      }
      if(item.output && typeof item.output === 'object'){
        const nested = aceItemToSource(item.output);
        if(nested){
          if((!Number.isFinite(nested.duration) || nested.duration <= 0) && Number.isFinite(fallbackDuration) && fallbackDuration > 0){
            nested.duration = fallbackDuration;
          }
          return nested;
        }
      }
      if(item.result && typeof item.result === 'object'){
        const nested = aceItemToSource(item.result);
        if(nested){
          if((!Number.isFinite(nested.duration) || nested.duration <= 0) && Number.isFinite(fallbackDuration) && fallbackDuration > 0){
            nested.duration = fallbackDuration;
          }
          return nested;
        }
      }

      let fileId = item.fileId || item.file_id || null;
      if(!fileId && item.id && (lowerType === 'file' || lowerType === 'output')) fileId = item.id;
      const hasExplicitUrl = candidateKeys.some(key => typeof item[key] === 'string' && item[key].trim().startsWith('http'));
      if(!fileId && item.id && (filename || item.name) && !hasExplicitUrl) fileId = item.id;
      if(fileId){
        const inferredName = filename || item.name || guessAceFilenameFromUrl(item.path || item.key || '');
        return finalizeAceSource({
          kind: 'file',
          fileId,
          filename: inferredName || 'audio.ogg'
        }, item, fallbackDuration);
      }

      return null;
    }

    function extractAceAudios(data){
      const ready = [];
      const pending = [];
      const seenUrls = new Set();
      const seenFiles = new Set();
      const visited = new WeakSet();

      function pushSource(src){
        if(!src) return;
        if(src.kind === 'file'){
          const fid = src.fileId;
          if(fid && !seenFiles.has(fid)){
            seenFiles.add(fid);
            pending.push({ fileId: fid, filename: src.filename || 'audio.ogg', duration: Number.isFinite(src.duration) && src.duration > 0 ? src.duration : null });
          }
          return;
        }
        const url = src.url;
        if(!url || seenUrls.has(url)) return;
        seenUrls.add(url);
        const name = src.filename || (src.kind === 'data' ? guessAceFilenameFromDataUri(url) : guessAceFilenameFromUrl(url));
        const entry = { url, filename: name, cleanup: src.cleanup };
        if(Number.isFinite(src.duration) && src.duration > 0) entry.duration = src.duration;
        ready.push(entry);
      }

      function walk(node){
        if(node === null || node === undefined) return;
        if(typeof node === 'string'){
          const trimmed = node.trim();
          if(!trimmed) return;
          const maybe = aceItemToSource(trimmed);
          if(maybe) pushSource(maybe);
          return;
        }
        if(typeof node === 'number' || typeof node === 'boolean') return;
        if(Array.isArray(node)){
          for(const item of node) walk(item);
          return;
        }
        if(typeof node === 'object'){
          if(visited.has(node)) return;
          visited.add(node);
          pushSource(aceItemToSource(node));
          for(const key of Object.keys(node)){
            if(key === 'id' || key === 'status' || key === 'executionTime' || key === 'delayTime' || key === 'workerId') continue;
            walk(node[key]);
          }
        }
      }

      walk(data);
      return { ready, pending };
    }

    async function downloadAceFile(key, jobId, fileId, filename){
      if(!fileId) return null;
      const headers = { 'Authorization': `Bearer ${key}` };
      const bases = new Set();
      bases.add(`${ACE_FILE_ENDPOINT}/${fileId}`);
      bases.add(`${ACE_FILES_ENDPOINT}/${fileId}`);
      bases.add(`${ACE_BASE_ENDPOINT}/output/${fileId}`);
      if(jobId){
        bases.add(`${ACE_RUNS_ENDPOINT}/${jobId}/output/${fileId}`);
        bases.add(`${ACE_RUNS_ENDPOINT}/${jobId}/file/${fileId}`);
        bases.add(`${ACE_RUN_ENDPOINT}/${jobId}/output/${fileId}`);
        bases.add(`${ACE_ENDPOINT}/${jobId}/output/${fileId}`);
        bases.add(`${ACE_ENDPOINT}/${jobId}/file/${fileId}`);
      }
      const queries = ['', '?download=1', '?rp_download=1', '?rp_download=true'];
      const baseVariants = new Set();
      for(const base of bases){
        baseVariants.add(base);
        baseVariants.add(`${base}/download`);
      }
      for(const base of baseVariants){
        for(const q of queries){
          const target = `${base}${q}`;
          try{
            const resp = await fetch(target, { headers });
            if(!resp.ok) continue;
            const contentType = resp.headers.get('content-type') || '';
            const headerDuration = parseAceDurationToSeconds(resp.headers.get('x-runpod-duration') || resp.headers.get('x-runpod-audio-seconds') || resp.headers.get('content-duration'));
            if(contentType.includes('application/json')){
              const json = await resp.json();
              const src = aceItemToSource(json);
              if(src && src.kind !== 'file'){
                if((!Number.isFinite(src.duration) || src.duration <= 0) && Number.isFinite(headerDuration) && headerDuration > 0){
                  src.duration = headerDuration;
                }
                const out = { url: src.url, filename: src.filename || filename || 'audio.ogg' };
                if(Number.isFinite(src.duration) && src.duration > 0) out.duration = src.duration;
                if(typeof src.cleanup === 'function') out.cleanup = src.cleanup;
                return out;
              }
              continue;
            }
            const blob = await resp.blob();
            const name = parseContentDispositionFilename(resp.headers.get('content-disposition')) || filename || 'audio.ogg';
            const blobUrl = URL.createObjectURL(blob);
            const out = { url: blobUrl, filename: name, cleanup: () => URL.revokeObjectURL(blobUrl) };
            if(Number.isFinite(headerDuration) && headerDuration > 0) out.duration = headerDuration;
            return out;
          } catch(err){
            console.debug('ACE download candidate failed', target, err);
          }
        }
      }
      return null;
    }

    function addAceTrack(entry){
      if(!entry || !acel.gallery) return;
      const url = entry.url;
      if(!url) return;
      const name = entry.filename || guessAceFilenameFromUrl(url);
      const wrap = document.createElement('div');
      wrap.className = 'shot';
      const header = document.createElement('div');
      header.className = 'header';
      const titleWrap = document.createElement('div');
      titleWrap.style.display = 'flex';
      titleWrap.style.flexDirection = 'column';
      titleWrap.style.gap = '4px';
      titleWrap.style.minWidth = '0';
      const title = document.createElement('span');
      title.className = 'mono';
      title.textContent = name;
      title.title = name;
      title.style.wordBreak = 'break-word';
      const durationLabel = document.createElement('span');
      durationLabel.className = 'hint';
      durationLabel.textContent = 'Length: loading…';
      titleWrap.appendChild(title);
      titleWrap.appendChild(durationLabel);
      const download = document.createElement('a');
      download.className = 'btn';
      download.href = url;
      download.download = name;
      download.textContent = 'Download';
      header.appendChild(titleWrap);
      header.appendChild(download);
      wrap.appendChild(header);
      const audio = document.createElement('audio');
      audio.controls = true;
      audio.preload = 'metadata';
      audio.src = url;
      audio.style.width = '100%';
      const applyDuration = seconds => {
        const text = formatAceDurationLabel(seconds);
        if(text){
          durationLabel.textContent = text;
          durationLabel.title = text;
          durationLabel.dataset.hasDuration = 'true';
        }
      };
      const initialDuration = parseAceDurationToSeconds(entry.duration);
      if(Number.isFinite(initialDuration) && initialDuration > 0){
        applyDuration(initialDuration);
      }
      const handleDurationEvent = () => {
        const dur = audio.duration;
        if(Number.isFinite(dur) && dur > 0){ applyDuration(dur); return; }
        if(audio.seekable && audio.seekable.length){
          const end = audio.seekable.end(audio.seekable.length - 1);
          if(Number.isFinite(end) && end > 0){ applyDuration(end); }
        }
      };
      audio.addEventListener('loadedmetadata', handleDurationEvent);
      audio.addEventListener('durationchange', handleDurationEvent);
      audio.addEventListener('loadeddata', handleDurationEvent);
      audio.addEventListener('error', ()=>{
        if(!durationLabel.dataset.hasDuration){
          durationLabel.textContent = 'Length: unavailable';
          durationLabel.removeAttribute('title');
        }
      });
      if(audio.readyState >= 1) handleDurationEvent();
      wrap.appendChild(audio);
      if(entry.cleanup && typeof entry.cleanup === 'function'){
        aceBlobCleanups.push(entry.cleanup);
      }
      acel.gallery.prepend(wrap);
    }

    async function runAce(){
      const key = (acel.apiKey && acel.apiKey.value || '').trim();
      if(!key){ if(acel.status) acel.status.textContent = 'API key required'; return; }
      try{
        setAceBusy(true);
        const payload = buildAcePayload();
        if(acel.debugReq) acel.debugReq.textContent = JSON.stringify(payload, null, 2);
        const resp = await fetch(ACE_ENDPOINT, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${key}`, 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        let data = await resp.json();
        let jobId = data && data.id ? data.id : null;
        if(acel.debugResp) acel.debugResp.textContent = JSON.stringify(data, null, 2);

        if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
        if(data.status !== 'COMPLETED'){
          if(data.id){
            if(acel.status) acel.status.textContent = 'Waiting for job...';
            data = await pollStatus(key, data.id, acel.debugResp, ACE_STATUS_ENDPOINT);
            if(data && data.id) jobId = data.id;
          } else {
            throw new Error(`Job status: ${data.status}`);
          }
        }

        const { ready, pending } = extractAceAudios(data);
        const tracks = [...ready];
        if(pending.length && acel.status) acel.status.textContent = 'Fetching audio files…';
        for(const file of pending){
          const downloaded = await downloadAceFile(key, jobId, file.fileId, file.filename);
          if(downloaded){
            if(Number.isFinite(file.duration) && file.duration > 0 && (!Number.isFinite(downloaded.duration) || downloaded.duration <= 0)){
              downloaded.duration = file.duration;
            }
            tracks.push(downloaded);
          }
        }
        if(!tracks.length){
          const workerStatus = data && data.output && data.output.status ? data.output.status : null;
          throw new Error(workerStatus ? `No audio returned (worker status: ${workerStatus})` : 'No audio returned');
        }

        for(const item of tracks){
          addAceTrack(item);
        }
        if(acel.status) acel.status.textContent = `Completed in ${data.executionTime ?? '?'} ms`;
      } catch(err){
        console.error(err);
        if(acel.status) acel.status.innerHTML = `<span class="error">Error: ${err.message}</span>`;
      } finally { setAceBusy(false); }
    }

    if(acel.runBtn) acel.runBtn.addEventListener('click', (e)=>{ e.preventDefault(); runAce(); });
    if(acel.curlBtn) acel.curlBtn.addEventListener('click', ()=>{
      const payload = buildAcePayload();
      const text = makeAceCurl(payload);
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(()=>{ if(acel.status) acel.status.textContent = 'cURL copied'; });
      }
    });

    if(acel.resetBtn) acel.resetBtn.addEventListener('click', ()=>{
      if(acel.tags) acel.tags.value = '';
      if(acel.structure) acel.structure.value = '';
      if(acel.minutes) acel.minutes.value = 0;
      if(acel.seconds) acel.seconds.value = 30;
      if(acel.seed) acel.seed.value = -1;
      if(acel.steps) acel.steps.value = 50;
      if(acel.cfg) acel.cfg.value = 5.0;
      if(acel.sampler) acel.sampler.value = 'res_multistep';
      if(acel.scheduler) acel.scheduler.value = 'linear_quadratic';
      if(acel.quality) acel.quality.value = '128k';
      if(acel.seedHint) acel.seedHint.textContent = acel.seedHintDefault;
      if(acel.status) acel.status.textContent = 'Reset to defaults';
    });

    if(acel.clearBtn) acel.clearBtn.addEventListener('click', ()=>{
      if(acel.gallery) acel.gallery.innerHTML = '';
      while(aceBlobCleanups.length){
        const fn = aceBlobCleanups.pop();
        try{ if(typeof fn === 'function') fn(); } catch(err){ console.debug('ACE cleanup error', err); }
      }
      if(acel.status) acel.status.textContent = 'Outputs cleared';
    });

    // Initialize
    (function(){
      if(!el.dims) return;
      el.dims.value = '1024x1024';
      lastPresetDims = '1024x1024';
      customDimsDirty = false;
      if(el.customWidth) el.customWidth.value = 1024;
      if(el.customHeight) el.customHeight.value = 1024;
      updateCustomDimsVisibility();
    })();
  </script>


<script>
  // --- Tabs: label the existing main and wire toggling without changing SDXL code ---
  (function(){
    const sdxlMain = document.querySelector('body > main') || document.querySelector('main');
    const qwenMain = document.getElementById('qwen-main');
    const aceMain = document.getElementById('ace-main');
    const wanMain = document.getElementById('wan-main');
    const tabbar = document.getElementById('tabbar');
    if (!sdxlMain || !tabbar) return;
    sdxlMain.id = 'sdxl-main';
    const sections = { sdxl: sdxlMain };
    if(qwenMain) sections.qwen = qwenMain;
    if(aceMain) sections.ace = aceMain;
    if(wanMain) sections.wan = wanMain;
    tabbar.addEventListener('click', (e)=>{
      const btn = e.target.closest('.tab'); if(!btn) return;
      const tab = btn.dataset.tab;
      if(!tab || !sections[tab]) return;
      for(const b of tabbar.querySelectorAll('.tab')) b.classList.remove('active');
      btn.classList.add('active');
      for (const key of Object.keys(sections)){
        if(key === tab) sections[key].classList.remove('hidden');
        else sections[key].classList.add('hidden');
      }
    });
  })();

  // --- Wan 2.2 helpers ---
  const w = id => document.getElementById(id);
  const wanel = {
    apiKey: document.getElementById('apiKey'),
    prompt: w('wan-prompt'),
    negative: w('wan-negative'), negWrap: w('wan-negative-wrap'),
    seed: w('wan-seed'), seedHint: w('wan-seedHint'),
    nsfw: w('wan-nsfw'), lowStep: w('wan-lowstep'), zeroNegative: w('wan-zero-negative'),
    steps: w('wan-steps'), stepsHint: w('wan-steps-hint'),
    cfg: w('wan-cfg'), cfgHint: w('wan-cfg-hint'), cfgWrap: w('wan-cfg-wrap'),
    sampler: w('wan-sampler'), scheduler: w('wan-scheduler'),
    length: w('wan-length'), mp: w('wan-mp'),
    imgUrl: w('wan-img-url'), interpolate: w('wan-interpolate'),
    status: w('wan-status'), timer: w('wan-timer'), gallery: w('wan-gallery'),
    runBtn: w('wan-run'), curlBtn: w('wan-curl'), resetBtn: w('wan-reset'), clearBtn: w('wan-clear'),
    debugReq: w('wan-debugReq'), debugResp: w('wan-debugResp'),
  };

  wanel.seedHintDefault = wanel.seedHint ? wanel.seedHint.textContent : '';

  const wantimer = makeTimer(wanel.timer);
  const wanBlobCleanups = [];

  populateSelect(wanel.sampler, SAMPLERS, 'euler');
  populateSelect(wanel.scheduler, SCHEDULERS, 'simple');

  function updateWanNegativeVisibility(){
    if(!wanel.negWrap) return;
    const show = !(wanel.lowStep && wanel.lowStep.checked) && !(wanel.zeroNegative && wanel.zeroNegative.checked);
    wanel.negWrap.style.display = show ? '' : 'none';
  }

  function clampWanSteps(){
    const low = !!(wanel.lowStep && wanel.lowStep.checked);
    if(!wanel.steps) return low ? 6 : 16;
    let raw = parseInt(wanel.steps.value || (low ? '6' : '16'), 10);
    if(!Number.isFinite(raw)) raw = low ? 6 : 16;
    const min = low ? 4 : 10;
    const max = low ? 8 : 25;
    raw = Math.max(min, Math.min(max, raw));
    if(raw % 2 !== 0){
      raw += 1;
      if(raw > max) raw -= 2;
    }
    if(raw % 2 !== 0){
      raw = min % 2 === 0 ? min : min + 1;
    }
    wanel.steps.value = raw;
    return raw;
  }

  function clampWanLength(){
    if(!wanel.length) return 48;
    let raw = parseInt(wanel.length.value || '48', 10);
    if(!Number.isFinite(raw)) raw = 48;
    raw = Math.max(33, Math.min(81, raw));
    wanel.length.value = raw;
    return raw;
  }

  function clampWanMp(){
    if(!wanel.mp) return 1.0;
    let raw = parseFloat(wanel.mp.value || '1');
    if(!Number.isFinite(raw)) raw = 1.0;
    raw = Math.max(0.5, Math.min(1.0, raw));
    raw = Math.round(raw * 100) / 100;
    wanel.mp.value = raw.toFixed(2);
    return raw;
  }

  function clampWanCfg(){
    if(!wanel.cfg) return 3.5;
    if(wanel.cfg.disabled) return 1.0;
    let raw = parseFloat(wanel.cfg.value || '3.5');
    if(!Number.isFinite(raw)) raw = 3.5;
    raw = Math.max(1.0, Math.min(6.0, raw));
    wanel.cfg.value = raw.toFixed(1);
    return raw;
  }

  function updateWanLowStepState(){
    const low = !!(wanel.lowStep && wanel.lowStep.checked);
    if(wanel.steps){
      wanel.steps.min = low ? 4 : 10;
      wanel.steps.max = low ? 8 : 25;
      wanel.steps.step = 2;
    }
    if(wanel.stepsHint) wanel.stepsHint.textContent = low ? 'Even values from 4–8 (low-step mode).' : 'Even values from 10–24.';
    if(wanel.cfgHint) wanel.cfgHint.textContent = low ? 'CFG forced to 1.0 in low-step mode.' : 'Range 1.0–6.0 (ignored in low-step).';
    if(wanel.cfg){
      if(low){
        if(!wanel.cfg.dataset.prevValue) wanel.cfg.dataset.prevValue = wanel.cfg.value || '3.5';
        wanel.cfg.value = '1.0';
        wanel.cfg.disabled = true;
      } else {
        wanel.cfg.disabled = false;
        const prev = wanel.cfg.dataset.prevValue;
        let restored = prev;
        if(restored !== undefined){
          const prevNum = parseFloat(restored);
          restored = Number.isFinite(prevNum) ? Math.max(1.0, Math.min(6.0, prevNum)).toFixed(1) : '3.5';
        } else {
          const current = parseFloat(wanel.cfg.value || '3.5');
          restored = Number.isFinite(current) ? Math.max(1.0, Math.min(6.0, current)).toFixed(1) : '3.5';
        }
        wanel.cfg.value = restored;
        delete wanel.cfg.dataset.prevValue;
      }
    }
    clampWanSteps();
    if(!low) clampWanCfg();
    updateWanNegativeVisibility();
  }

  function guessWanFilenameFromUrl(url){
    try{
      const u = new URL(url);
      const parts = u.pathname.split('/').filter(Boolean);
      const name = parts.pop();
      if(name) return name;
    }catch(err){
      if(typeof url === 'string'){
        const tail = url.split('/').filter(Boolean).pop();
        if(tail) return tail;
      }
    }
    return 'video.mp4';
  }

  function guessWanFilenameFromDataUri(uri){
    const match = /^data:video\/([^;,]+)/i.exec(uri || '');
    if(match && match[1]){
      const ext = match[1].split('/').pop();
      if(ext) return `video.${ext}`;
    }
    return 'video.mp4';
  }

  function extractWanVideos(data){
    const ready = [];
    const pending = [];
    const seenUrls = new Set();
    const seenFiles = new Set();
    const visited = new WeakSet();
    const videoPattern = /\.(?:mp4|webm|mov|m4v)(?:\?.*)?$/i;

    function pushUrl(url, filename){
      if(!url || seenUrls.has(url)) return;
      seenUrls.add(url);
      ready.push({ url, filename: filename || guessWanFilenameFromUrl(url) });
    }

    function pushFile(fileId, filename){
      if(!fileId || seenFiles.has(fileId)) return;
      seenFiles.add(fileId);
      pending.push({ fileId, filename: filename || 'video.mp4' });
    }

    function walk(node){
      if(node === null || node === undefined) return;
      if(typeof node === 'string'){
        const trimmed = node.trim();
        if(!trimmed) return;
        if(trimmed.startsWith('data:video/')){
          pushUrl(trimmed, guessWanFilenameFromDataUri(trimmed));
        } else if(/^https?:/i.test(trimmed) && (videoPattern.test(trimmed) || trimmed.includes('/file/') || trimmed.includes('/output/'))){
          pushUrl(trimmed, guessWanFilenameFromUrl(trimmed));
        }
        return;
      }
      if(typeof node === 'number' || typeof node === 'boolean') return;
      if(Array.isArray(node)){
        for(const item of node) walk(item);
        return;
      }
      if(typeof node !== 'object') return;
      if(visited.has(node)) return;
      visited.add(node);

      const type = typeof node.type === 'string' ? node.type.toLowerCase() : '';
      const mime = typeof node.mime === 'string' ? node.mime.toLowerCase() :
        typeof node.content_type === 'string' ? node.content_type.toLowerCase() :
        typeof node.contentType === 'string' ? node.contentType.toLowerCase() : '';
      const filename = node.filename || node.file_name || node.name || null;

      if(type === 'base64' && typeof node.data === 'string'){
        const mimeType = mime && mime.startsWith('video/') ? mime : 'video/mp4';
        pushUrl(`data:${mimeType};base64,${node.data}`, filename || guessWanFilenameFromDataUri(`data:${mimeType}`));
      }

      const dataField = node.data;
      if(typeof dataField === 'string' || Array.isArray(dataField) || (dataField && typeof dataField === 'object')){
        walk(dataField);
      }

      const urlFields = [node.url, node.path, node.location, node.signed_url, node.signedUrl, node.download_url, node.downloadUrl];
      for(const value of urlFields){
        if(typeof value !== 'string') continue;
        const trimmed = value.trim();
        if(!trimmed) continue;
        if(trimmed.startsWith('data:video/')){
          pushUrl(trimmed, filename || guessWanFilenameFromDataUri(trimmed));
        } else if(/^https?:/i.test(trimmed) && (videoPattern.test(trimmed) || type.includes('video') || mime.startsWith('video'))){
          pushUrl(trimmed, filename || guessWanFilenameFromUrl(trimmed));
        }
      }

      if(node.output !== undefined) walk(node.output);
      if(node.videos !== undefined) walk(node.videos);
      if(node.images !== undefined) walk(node.images);
      if(node.frames !== undefined) walk(node.frames);

      let fileId = node.fileId || node.file_id || null;
      const hasExplicitUrl = urlFields.some(v => typeof v === 'string' && v.trim().startsWith('http'));
      if(!fileId && node.id && (type.includes('video') || mime.startsWith('video') || filename) && !hasExplicitUrl){
        fileId = node.id;
      }
      if(fileId){
        pushFile(fileId, filename || 'video.mp4');
      }

      for(const key of Object.keys(node)){
        if(key === 'id' || key === 'status' || key === 'executionTime' || key === 'delayTime' || key === 'workerId') continue;
        if(key === 'data' || key === 'output' || key === 'url' || key === 'path' || key === 'location' || key === 'signed_url' || key === 'signedUrl' || key === 'download_url' || key === 'downloadUrl') continue;
        walk(node[key]);
      }
    }

    walk(data);
    return { ready, pending };
  }

  function addWanVideo(entry){
    if(!entry || !entry.url || !wanel.gallery) return;
    const name = entry.filename || guessWanFilenameFromUrl(entry.url);
    const wrap = document.createElement('div');
    wrap.className = 'shot';
    const header = document.createElement('div'); header.className = 'header';
    header.innerHTML = `<header><span class="mono" title="${name}">${name}</span><a class="btn" href="${entry.url}" download>Download</a></header>`;
    wrap.appendChild(header);
    const video = document.createElement('video');
    video.controls = true;
    video.preload = 'metadata';
    video.src = entry.url;
    video.playsInline = true;
    video.style.width = '100%';
    wrap.appendChild(video);
    if(entry.cleanup && typeof entry.cleanup === 'function') wanBlobCleanups.push(entry.cleanup);
    wanel.gallery.prepend(wrap);
  }

  function getWanTemplate(){
    const el = document.getElementById('wan-template');
    if(!el) throw new Error('Missing wan-template');
    const raw = el.textContent.trim();
    return JSON.parse(raw);
  }

  function buildWanPlaceholderMap(){
    let seedVal = parseInt(wanel.seed && (wanel.seed.value || '-1'), 10);
    if(!Number.isFinite(seedVal)) seedVal = -1;
    if(seedVal === -1){
      seedVal = genRandomSeed();
      if(wanel.seedHint) wanel.seedHint.textContent = `Random seed: ${seedVal}`;
    } else if(wanel.seedHint){
      wanel.seedHint.textContent = wanel.seedHintDefault || '';
    }
    const lowStep = !!(wanel.lowStep && wanel.lowStep.checked);
    const zeroNeg = !!(wanel.zeroNegative && wanel.zeroNegative.checked);
    const cfgVal = clampWanCfg();
    const stepsVal = clampWanSteps();
    const mpVal = clampWanMp();
    const lengthVal = clampWanLength();
    updateWanNegativeVisibility();
    const imgUrl = (wanel.imgUrl && wanel.imgUrl.value || '').trim();
    return {
      prompt: wanel.prompt ? wanel.prompt.value || '' : '',
      negative_prompt: (!lowStep && !zeroNeg && wanel.negative) ? (wanel.negative.value || '') : '',
      is_nsfw: !!(wanel.nsfw && wanel.nsfw.checked),
      low_step: lowStep,
      zero_out_negative: zeroNeg,
      cfg: lowStep ? 1.0 : parseFloat(cfgVal.toFixed(1)),
      sampler: wanel.sampler ? wanel.sampler.value : 'euler',
      scheduler: wanel.scheduler ? wanel.scheduler.value : 'simple',
      seed: seedVal,
      steps: stepsVal,
      img_url: imgUrl,
      mp: parseFloat(mpVal.toFixed(2)),
      length: lengthVal,
      interpolate: !!(wanel.interpolate && wanel.interpolate.checked)
    };
  }

  function buildWanPayload(){
    const template = getWanTemplate();
    const map = buildWanPlaceholderMap();
    const resolved = deepReplacePlaceholders(template, map);
    return { input: { workflow: resolved } };
  }

  function makeWanCurl(payload){
    const key = (wanel.apiKey && wanel.apiKey.value || '').trim() || '<api_key>';
    return [
      'curl -sX POST',
      `  -H "Authorization: Bearer ${key}"`,
      '  -H "Content-Type: application/json"',
      `  -d '${JSON.stringify(payload)}'`,
      `  ${WAN_ENDPOINT}`
    ].join(' \n');
  }

  function setWanBusy(b){
    if(wanel.runBtn) wanel.runBtn.disabled = b;
    if(wanel.status) wanel.status.textContent = b ? 'Running…' : 'Idle';
    if(wanel.timer){ b ? wantimer.start() : wantimer.stop(); }
  }

  async function runWan(){
    const key = (wanel.apiKey && wanel.apiKey.value || '').trim();
    if(!key){ if(wanel.status) wanel.status.textContent = 'API key required'; return; }
    const imgUrl = (wanel.imgUrl && wanel.imgUrl.value || '').trim();
    if(!imgUrl){ if(wanel.status) wanel.status.textContent = 'Image URL required'; return; }
    try{
      setWanBusy(true);
      const payload = buildWanPayload();
      if(wanel.debugReq) wanel.debugReq.textContent = JSON.stringify(payload, null, 2);
      const resp = await fetch(WAN_ENDPOINT, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${key}`, 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      let data = await resp.json();
      if(wanel.debugResp) wanel.debugResp.textContent = JSON.stringify(data, null, 2);
      let jobId = data && data.id ? data.id : null;

      if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
      if(data.status !== 'COMPLETED'){
        if(data.id){
          if(wanel.status) wanel.status.textContent = 'Waiting for job...';
          data = await pollStatus(key, data.id, wanel.debugResp, WAN_STATUS_ENDPOINT);
          if(data && data.id) jobId = data.id;
        } else {
          throw new Error(`Job status: ${data.status}`);
        }
      }

      const { ready, pending } = extractWanVideos(data);
      const clips = [...ready];
      if(pending.length && wanel.status) wanel.status.textContent = 'Fetching video files…';
      for(const file of pending){
        const downloaded = await downloadAceFile(key, jobId, file.fileId, file.filename);
        if(downloaded){
          clips.push(downloaded);
        }
      }
      if(!clips.length){
        const workerStatus = data && data.output && data.output.status ? data.output.status : null;
        throw new Error(workerStatus ? `No video returned (worker status: ${workerStatus})` : 'No video returned');
      }

      for(const item of clips){
        addWanVideo(item);
      }
      if(wanel.status) wanel.status.textContent = `Completed in ${data.executionTime ?? '?'} ms`;
    } catch(err){
      console.error(err);
      if(wanel.status) wanel.status.innerHTML = `<span class="error">Error: ${err.message}</span>`;
    } finally { setWanBusy(false); }
  }

  function resetWanDefaults(){
    if(wanel.prompt) wanel.prompt.value = '';
    if(wanel.negative) wanel.negative.value = '';
    if(wanel.nsfw) wanel.nsfw.checked = false;
    if(wanel.lowStep) wanel.lowStep.checked = false;
    if(wanel.zeroNegative) wanel.zeroNegative.checked = false;
    if(wanel.seed) wanel.seed.value = -1;
    if(wanel.seedHint) wanel.seedHint.textContent = wanel.seedHintDefault || '';
    if(wanel.steps) wanel.steps.value = 16;
    if(wanel.cfg){
      wanel.cfg.disabled = false;
      delete wanel.cfg.dataset.prevValue;
      wanel.cfg.value = '3.5';
    }
    if(wanel.sampler) wanel.sampler.value = 'euler';
    if(wanel.scheduler) wanel.scheduler.value = 'simple';
    if(wanel.length) wanel.length.value = 48;
    if(wanel.mp) wanel.mp.value = '1.00';
    if(wanel.imgUrl) wanel.imgUrl.value = '';
    if(wanel.interpolate) wanel.interpolate.checked = true;
    updateWanLowStepState();
    clampWanCfg();
    clampWanMp();
    clampWanLength();
    updateWanNegativeVisibility();
  }

  if(wanel.lowStep) wanel.lowStep.addEventListener('change', updateWanLowStepState);
  if(wanel.zeroNegative) wanel.zeroNegative.addEventListener('change', updateWanNegativeVisibility);
  if(wanel.steps){
    wanel.steps.addEventListener('change', clampWanSteps);
    wanel.steps.addEventListener('blur', clampWanSteps);
  }
  if(wanel.cfg){
    wanel.cfg.addEventListener('change', clampWanCfg);
    wanel.cfg.addEventListener('blur', clampWanCfg);
  }
  if(wanel.mp){
    wanel.mp.addEventListener('change', clampWanMp);
    wanel.mp.addEventListener('blur', clampWanMp);
  }
  if(wanel.length){
    wanel.length.addEventListener('change', clampWanLength);
    wanel.length.addEventListener('blur', clampWanLength);
  }

  if(wanel.runBtn) wanel.runBtn.addEventListener('click', (e)=>{ e.preventDefault(); runWan(); });
  if(wanel.curlBtn) wanel.curlBtn.addEventListener('click', ()=>{
    const payload = buildWanPayload();
    const text = makeWanCurl(payload);
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).then(()=>{ if(wanel.status) wanel.status.textContent = 'cURL copied'; });
    }
  });
  if(wanel.resetBtn) wanel.resetBtn.addEventListener('click', ()=>{
    resetWanDefaults();
    if(wanel.status) wanel.status.textContent = 'Reset to defaults';
  });
  if(wanel.clearBtn) wanel.clearBtn.addEventListener('click', ()=>{
    if(wanel.gallery) wanel.gallery.innerHTML = '';
    while(wanBlobCleanups.length){
      const fn = wanBlobCleanups.pop();
      try{ if(typeof fn === 'function') fn(); } catch(err){ console.debug('WAN cleanup error', err); }
    }
    if(wanel.status) wanel.status.textContent = 'Outputs cleared';
  });

  resetWanDefaults();

  // --- Qwen element helpers ---
  const q = id => document.getElementById(id);
  const qel = {
    apiKey: document.getElementById('apiKey'),
    prompt: q('q-prompt'),
    lowstep: q('q-lowstep'),
    negative: q('q-negative'), negwrap: q('q-negwrap'),
    width: q('q-width'), height: q('q-height'),
    seed: q('q-seed'), seedHint: q('q-seedHint'), steps: q('q-steps'), stepsWrap: q('q-steps-wrap'),
    stepsToggleWrap: q('q-steps-toggle'), stepsToggle: q('q-steps-toggle-input'), stepsToggleHint: q('q-steps-toggle-hint'),
    cfg: q('q-cfg'), sampler: q('q-sampler'), scheduler: q('q-scheduler'),
    modelShift: q('q-model-shift'),
    runBtn: q('q-run'), curlBtn: q('q-curl'), resetBtn: q('q-reset'), clearBtn: q('q-clear'),
    status: q('q-status'), timer: q('q-timer'), gallery: q('q-gallery'), debugReq: q('q-debugReq'), debugResp: q('q-debugResp'),
  };

  const qtimer = makeTimer(qel.timer);

  qel.seedHintDefault = qel.seedHint ? qel.seedHint.textContent : '';

  populateSelect(qel.sampler, SAMPLERS, 'euler');
  populateSelect(qel.scheduler, SCHEDULERS, 'normal');

  function updateLowstepStepsHint(){
    if(!qel.stepsToggleHint) return;
    const useEight = !!(qel.stepsToggle && qel.stepsToggle.checked);
    qel.stepsToggleHint.textContent = useEight ? '8 steps' : '4 steps';
  }

  function updateLowstepUI(){
    const on = !!(qel.lowstep && qel.lowstep.checked);
    if(qel.negwrap) qel.negwrap.style.display = on ? 'none' : '';
    if(qel.steps) qel.steps.style.display = on ? 'none' : '';
    if(qel.stepsToggleWrap) qel.stepsToggleWrap.style.display = on ? 'flex' : 'none';
    updateLowstepStepsHint();
  }

  if(qel.lowstep) qel.lowstep.addEventListener('change', updateLowstepUI);
  if(qel.stepsToggle) qel.stepsToggle.addEventListener('change', updateLowstepStepsHint);
  updateLowstepUI();

  qel.resetBtn.addEventListener('click', ()=>{
    qel.prompt.value = '';
    qel.lowstep.checked = false;
    if(qel.stepsToggle) qel.stepsToggle.checked = true;
    updateLowstepUI();
    qel.negative.value = '';
    qel.width.value = 1024; qel.height.value = 1024;
    qel.seed.value = -1; qel.steps.value = 20; qel.cfg.value = 2.0;
    qel.sampler.value = 'euler'; qel.scheduler.value = 'normal';
    qel.modelShift.value = 3.10;
    if(qel.seedHint) qel.seedHint.textContent = qel.seedHintDefault;
    qel.status.textContent = 'Reset to defaults';
  });

  qel.clearBtn.addEventListener('click', ()=>{ qel.gallery.innerHTML=''; qel.status.textContent='Gallery cleared'; });

  function buildQwenPlaceholderMap(){
    let seedVal = parseInt(qel.seed.value || '-1', 10);
    if(seedVal === -1){
      seedVal = genRandomSeed();
      if(qel.seedHint) qel.seedHint.textContent = `Random seed: ${seedVal}`;
    } else if(qel.seedHint){
      qel.seedHint.textContent = qel.seedHintDefault;
    }
    const low = !!(qel.lowstep && qel.lowstep.checked);
    const lowToggleEight = !!(qel.stepsToggle && qel.stepsToggle.checked);
    let steps;
    let lowStepLora = 'Qwen-Image-Lightning-8steps-V2.0.safetensors';
    if(low){
      if(lowToggleEight){
        steps = 8;
        lowStepLora = 'Qwen-Image-Lightning-8steps-V2.0.safetensors';
      } else {
        steps = 4;
        lowStepLora = 'Qwen-Image-Lightning-4steps-V2.0.safetensors';
      }
    } else {
      steps = Math.max(10, Math.min(30, parseInt(qel.steps.value || '20',10)));
    }
    const cfg = Math.max(1.0, Math.min(3.5, parseFloat((qel.cfg.value || '2.0').toString())));
    const w = Math.max(64, Math.min(1920, parseInt(qel.width.value || '1024',10)));
    const h = Math.max(64, Math.min(1920, parseInt(qel.height.value || '1024',10)));
    const shift = Math.max(0, parseFloat((qel.modelShift.value || '3.10')).toFixed(2));
    return {
      use_low_step: low,
      prompt: qel.prompt.value || '',
      negative_prompt: low ? '' : (qel.negative.value || ''),
      width: w, height: h,
      seed: seedVal, steps: steps,
      cfg: parseFloat(cfg.toFixed(1)),
      sampler: qel.sampler.value,
      scheduler: qel.scheduler.value,
      model_shift: shift,
      low_step_lora: lowStepLora
    };
  }

  function getQwenTemplate(){
    const el = document.getElementById('qwen-template');
    if(!el) throw new Error('Missing qwen-template');
    const raw = el.textContent.trim();
    return JSON.parse(raw);
  }

  function deepReplacePlaceholdersQ(obj, map){
    if (obj === null || obj === undefined) return obj;
    if (typeof obj === 'string'){
      const m = obj.match(/^%([a-zA-Z0-9_]+)%$/);
      if (m){
        const key = m[1];
        if (!(key in map)) throw new Error(`Missing placeholder: ${key}`);
        return map[key];
      }
      return obj;
    } else if (Array.isArray(obj)){
      return obj.map(v => deepReplacePlaceholdersQ(v, map));
    } else if (typeof obj === 'object'){
      const out = {};
      for (const k of Object.keys(obj)) out[k] = deepReplacePlaceholdersQ(obj[k], map);
      return out;
    }
    return obj;
  }

  function buildQwenPayload(){
    const template = getQwenTemplate();
    const map = buildQwenPlaceholderMap();
    const resolved = deepReplacePlaceholdersQ(template, map);
    return { input: { workflow: resolved } };
  }

  function makeQwenCurl(payload){
    const key = (qel.apiKey && qel.apiKey.value || '').trim() || '<api_key>';
    return [
      'curl -sX POST',
      `  -H "Authorization: Bearer ${key}"`,
      '  -H "Content-Type: application/json"',
      `  -d '${JSON.stringify(payload)}'`,
      `  ${ENDPOINT}`
    ].join(' \\n');
  }

  function setQBusy(b){
    if(qel.runBtn) qel.runBtn.disabled = b;
    if(qel.status) qel.status.textContent = b? 'Running…' : 'Idle';
    if(qel.timer){ b ? qtimer.start() : qtimer.stop(); }
  }

  function addQShot(url, name){
    const wrap = document.createElement('div');
    wrap.className = 'shot';
    const header = document.createElement('div'); header.className = 'header';
    header.innerHTML = `<header><span class="mono" title="${name}">${name}</span><a class="btn" href="${url}" download>Download</a></header>`;
    wrap.appendChild(header);
    const img = new Image(); img.loading = 'lazy'; img.src = url; img.addEventListener('click', ()=>openLightbox(url)); wrap.appendChild(img);
    qel.gallery.prepend(wrap);
  }

  async function runQwen(){
    const key = (qel.apiKey && qel.apiKey.value || '').trim();
    if(!key){ if(qel.status) qel.status.textContent = 'API key required'; return; }
    try{
      setQBusy(true);
      const payload = buildQwenPayload();
      if(qel.debugReq) qel.debugReq.textContent = JSON.stringify(payload, null, 2);
      const resp = await fetch(ENDPOINT, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${key}`, 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      let data = await resp.json();
      if(qel.debugResp) qel.debugResp.textContent = JSON.stringify(data, null, 2);

      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      if (data.status !== 'COMPLETED'){
        if(data.id){
          if(qel.status) qel.status.textContent = 'Waiting for job...';
          data = await pollStatus(key, data.id, qel.debugResp);
        }else{
          throw new Error(`Job status: ${data.status}`);
        }
      }
      if (!data.output || !Array.isArray(data.output.images) || data.output.images.length === 0) throw new Error('No images in response');

      for (const item of data.output.images){
        if (item.type === 'base64' && item.data){
          const imgUrl = `data:image/avif;base64,${item.data}`;
          addQShot(imgUrl, item.filename || 'image.avif');
        } else if (item.type === 's3_url' && item.data){
          addQShot(item.data, item.filename || 'image.avif');
        }
      }
      if(qel.status) qel.status.textContent = `Completed in ${data.executionTime ?? '?'} ms`;
    } catch(err){
      console.error(err);
      if(qel.status) qel.status.innerHTML = `<span class="error">Error: ${err.message}</span>`;
    } finally{ setQBusy(false); }
  }

  if (qel.runBtn) qel.runBtn.addEventListener('click', (e)=>{ e.preventDefault(); runQwen(); });
  if (qel.curlBtn) qel.curlBtn.addEventListener('click', ()=>{
    const payload = buildQwenPayload();
    const text = makeQwenCurl(payload);
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(()=>{ if(qel.status) qel.status.textContent = 'cURL copied'; });
    }
  });
</script>

<script>
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = lightbox.querySelector('img');
  const lightboxClose = lightbox.querySelector('.close');
  function openLightbox(src){
    lightboxImg.src = src;
    lightbox.classList.remove('hidden');
  }
  function closeLightbox(){
    lightbox.classList.add('hidden');
    lightboxImg.src = '';
  }
  lightbox.addEventListener('click', (e)=>{ if(e.target === lightbox) closeLightbox(); });
  if (lightboxClose) lightboxClose.addEventListener('click', closeLightbox);
  window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeLightbox(); });
</script>

</body>
</html>
