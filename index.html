<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RunPod ComfyUI Frontend</title>
  <style>
    :root{
      --bg: #0f1116; --panel:#171923; --muted:#a0abc0; --text:#e6eefc; --accent:#5aa9ff; --danger:#ff5964; --ok:#61d095; --border:#262b3a;
    }
    *{box-sizing:border-box}
    body{margin:0; font:14px/1.4 system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:var(--text); background:var(--bg);}    
    header{position:sticky; top:0; z-index:5; background:rgba(15,17,22,.85); backdrop-filter:saturate(180%) blur(10px); border-bottom:1px solid var(--border);}    
    header .wrap{max-width:1100px; margin:0 auto; padding:10px 16px; display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    header h1{font-size:16px; margin:0; font-weight:650}
    header .desc{color:var(--muted); font-size:12px}
    main{max-width:1100px; margin:0 auto; padding:16px; display:grid; grid-template-columns: 360px 1fr; gap:16px}
    @media (max-width: 880px){ main{grid-template-columns: 1fr;} }

    .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; overflow:hidden}
    .card header{position:unset; background:none; border:0; display:flex; align-items:center; justify-content:space-between; gap:8px}
    .card .body{padding:14px}

    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .row-3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    .row-4{display:grid; grid-template-columns: repeat(4,1fr); gap:10px}
    .lora-section{margin-top:16px}
    .lora-entry{border:1px solid var(--border); background:#0c0e14; border-radius:10px; padding:10px; margin-top:10px}
    .lora-entry-top{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .lora-toggle{display:flex; align-items:center; gap:8px}
    .lora-remove{background:none; border:0; color:var(--muted); font-size:20px; line-height:1; cursor:pointer; padding:4px; border-radius:6px}
    .lora-remove:hover{color:var(--danger); background:rgba(255,89,100,0.1)}
    .lora-entry label:first-of-type{margin-top:0}

    label{display:block; margin:10px 0 4px; font-weight:600; font-size:12px; color:#cdd6eb}
    input[type="text"], input[type="number"], select, textarea{
      width:100%; padding:10px 12px; border-radius:9px; border:1px solid var(--border); background:#0c0e14; color:var(--text);
      outline:none; transition:border .15s ease;
    }
    textarea{min-height:120px; resize:vertical}
    input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus{border-color:#33406b}

    .hint{color:var(--muted); font-size:12px}
    .muted{color:var(--muted)}

    .switch{display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none}
    .switch input{display:none}
    .switch .track{width:40px; height:22px; background:#0c0e14; border:1px solid var(--border); border-radius:999px; position:relative; transition:all .2s}
    .switch .thumb{position:absolute; top:1px; left:1px; width:18px; height:18px; border-radius:50%; background:#7b85a3; transition:left .2s}
    .switch input:checked + .track{background:#0d213c; border-color:#284e8a}
    .switch input:checked + .track .thumb{left:21px; background:var(--accent)}

    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; border:1px solid var(--border); background:#0d1320; color:var(--text); padding:10px 12px; border-radius:10px; cursor:pointer; text-decoration:none}
    .btn:hover{border-color:#2f3b5f}
    .btn.primary{background:#11305a}
    .btn.danger{background:#2a1114}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .status{font-size:12px; color:var(--muted)}

    .gallery{display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:12px; padding:12px}
    .shot{border:1px solid var(--border); background:#0c0e14; border-radius:10px; overflow:hidden}
    .shot header{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; border-bottom:1px solid var(--border)}
    .shot img{display:block; width:100%; height:auto}
    .shot video{display:block; width:100%; height:auto; background:#000}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px}
    details pre{max-height:300px; overflow:auto; background:#0b0e14; border:1px solid var(--border); border-radius:8px; padding:12px}
    .error{color:var(--danger)}
  

/* --- Tabs --- */
.tabs{max-width:1100px; margin:8px auto 0; padding:0 16px; display:flex; gap:8px}
.tab{padding:8px 12px; border:1px solid var(--border); background:#0d1320; color:var(--text); border-radius:10px; cursor:pointer; user-select:none}
.tab.active{background:#11305a}
.hidden{display:none}
.tabs.subtabs{grid-column:1 / -1; margin:0 0 12px; padding:0; justify-content:flex-start}
.tabs.subtabs .tab{background:#111425}
.tabs.subtabs .tab.active{background:#1b2f55}
.sdxl-subtab{display:contents}
.sdxl-subtab.hidden{display:none}

.mask-editor{--editor-width:1024; --editor-height:1024; position:relative; width:100%; border:1px solid var(--border); border-radius:12px; background:#0c0e14; aspect-ratio: var(--editor-width) / var(--editor-height); overflow:hidden; touch-action:none; margin-top:12px}
.mask-editor-inner{position:absolute; inset:0}
.mask-region{position:absolute; border:2px solid rgba(255,255,255,0.9); border-radius:8px; background:rgba(255,255,255,0.18); cursor:move; color:transparent}
.mask-region.disabled{opacity:0.35}
.mask-region.selected{box-shadow:0 0 0 2px rgba(90,169,255,0.65)}
.mask-handle{position:absolute; width:12px; height:12px; border-radius:50%; border:1px solid var(--panel); background:var(--text); box-shadow:0 1px 2px rgba(0,0,0,0.4)}
.mask-handle[data-handle="nw"]{top:-6px; left:-6px; cursor:nwse-resize}
.mask-handle[data-handle="ne"]{top:-6px; right:-6px; cursor:nesw-resize}
.mask-handle[data-handle="sw"]{bottom:-6px; left:-6px; cursor:nesw-resize}
.mask-handle[data-handle="se"]{bottom:-6px; right:-6px; cursor:nwse-resize}

.region-manager{margin-top:18px}
.region-manager-top{display:flex; align-items:center; justify-content:space-between; gap:8px}
.region-list{margin-top:12px}
.region-entry{border:1px solid var(--border); background:#0c0e14; border-radius:10px; padding:10px; margin-top:10px}
.region-entry.selected{border-color:#2f3b5f; box-shadow:0 0 0 1px rgba(90,169,255,0.3)}
.region-entry-top{display:flex; align-items:center; justify-content:space-between; gap:8px}
.region-chip{display:inline-flex; align-items:center; gap:8px; font-weight:600}
.region-chip .swatch{width:14px; height:14px; border-radius:4px; display:inline-block}
.region-remove{background:none; border:0; color:var(--muted); font-size:20px; line-height:1; cursor:pointer; padding:4px; border-radius:6px}
.region-remove:hover{color:var(--danger); background:rgba(255,89,100,0.1)}
.region-entry.disabled{opacity:0.7}
.region-grid{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:10px}
.region-grid label{margin-top:0}
.region-grid input{width:100%}


    .lightbox{position:fixed; inset:0; background:rgba(0,0,0,.8); display:flex; align-items:center; justify-content:center; z-index:1000; padding:20px;}
    .lightbox.hidden{display:none}
    .lightbox img{max-width:100%; max-height:100%; border-radius:8px}
    .lightbox .close{position:absolute; top:16px; right:16px; background:none; border:0; color:#fff; font-size:32px; cursor:pointer}

</style>
</head>
<body>
  <div id="lightbox" class="lightbox hidden"><img alt="Full size" /><button class="close" aria-label="Close">&times;</button></div>
  <header>
    <div class="wrap">
      <h1>RunPod ComfyUI Frontend</h1>
      <div class="desc">Static client for /runsync. No backend. API key stays in-memory.</div>
    </div>
  </header>

<nav class="tabs" id="tabbar">
  <button class="tab active" data-tab="sdxl">SDXL</button>
  <button class="tab" data-tab="qwen">Qwen-Image</button>
  <button class="tab" data-tab="ace">ACE-Step</button>
  <button class="tab" data-tab="wan">Wan 2.2</button>
</nav>

<div id="apiKeyWrap" style="max-width:1100px; margin:8px auto 0; padding:0 16px; display:flex; flex-wrap:wrap; justify-content:flex-end; gap:8px; align-items:center;">
  <label for="apiKey" style="margin:0">RunPod API Key</label>
  <input id="apiKey" type="text" placeholder="rp_..." autocomplete="off" spellcheck="false" style="width:300px" />
  <div class="hint" style="width:100%; text-align:right">Used only in this page, not stored.</div>
</div>


  <main>
    <nav class="tabs subtabs" id="sdxl-subtabbar">
      <button class="tab active" data-subtab="standard">Standard SDXL</button>
      <button class="tab" data-subtab="regional">Regional Prompter</button>
    </nav>

    <div class="sdxl-subtab" data-subtab="standard">
      <section class="card" id="controls">
        <header class="body" style="border-bottom:1px solid var(--border)">
          <strong>Mana AI - SDXL</strong>
          <div style="display:flex; gap:8px; align-items:center">
            <div class="status" id="timer">00:00.00</div>
            <div class="status" id="status">Idle</div>
          </div>
        </header>
        <div class="body">
          <p class="hint" style="margin:0 0 8px; font-weight:600; text-transform:uppercase; letter-spacing:.05em">Main</p>
          <label for="checkpoint">Checkpoint</label>
          <select id="checkpoint">
            <option value="noobaiXLNAIXL_vPred10Version.safetensors">noobaiXLNAIXL_vPred10Version.safetensors</option>
            <option value="ΣIH-1.5.safetensors">ΣIH-1.5.safetensors</option>
            <option value="midnightNAIXLVpredv1.safetensors">midnightNAIXLVpredv1.safetensors</option>
            <option value="oneObsession_v15Noobai.safetensors">oneObsession_v15Noobai.safetensors</option>
            <option value="oneObsession_v16Noobai.safetensors">oneObsession_v16Noobai.safetensors</option>
            <option value="rouwei_v080Vpred.safetensors">rouwei_v080Vpred.safetensors</option>
            <option value="seeleNoobaiSDXL_v21.safetensors">seeleNoobaiSDXL_v21.safetensors</option>
            <option value="NoobAI-RectifiedFlow-test-step486k.safetensors">NoobAI-RectifiedFlow-test-step486k.safetensors</option>
          </select>

          <label for="prompt">Prompt</label>
          <textarea id="prompt" placeholder="Describe the image..."></textarea>

          <div id="rouweiWrap" style="display:none; margin-top:10px">
            <label for="rouweiPrefix">Rouwei prefix</label>
            <textarea id="rouweiPrefix" placeholder="Required artist and quality tags for rouwei..."></textarea>
            <div class="hint">Required when using rouwei_v080Vpred.safetensors.</div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label for="width">Width</label>
              <input id="width" type="number" min="512" max="2048" step="1" value="1024" />
            </div>
            <div>
              <label for="height">Height</label>
              <input id="height" type="number" min="512" max="2048" step="1" value="1024" />
            </div>
          </div>
          <div id="seeleScaleWrap" style="display:none; margin-top:8px">
            <label for="seeleScale">Seele latent scale (1.0–1.5x)</label>
            <input id="seeleScale" type="range" min="1.0" max="1.5" step="0.05" value="1.0" />
            <div class="hint" id="seeleScaleHint">1.0x (HiresFix stays available)</div>
          </div>

          <div style="margin-top:10px">
            <label for="batchSize">Batch size</label>
            <input id="batchSize" type="range" min="1" max="4" step="1" value="1" />
            <div class="hint" id="batchSizeHint">1 image per run</div>
          </div>

          <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
            <label class="switch"><input id="useBakedVae" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label>
            <span class="hint">Use baked VAE (forced for RF Noob)</span>
          </div>
          <div id="vaeWrap" style="margin-top:8px">
            <label for="vaeName">External VAE</label>
            <select id="vaeName">
              <option value="sdxl-vae-anime-alpha-67500.safetensors">sdxl-vae-anime-alpha-67500.safetensors</option>
            </select>
          </div>

          <p class="hint" style="margin:16px 0 6px; font-weight:600; text-transform:uppercase; letter-spacing:.05em">LoRA</p>
          <div class="lora-entry">
            <div class="lora-entry-top">
              <div class="lora-toggle"><label class="switch"><input id="lora1Enable" type="checkbox"><span class="track"><span class="thumb"></span></span></label><span class="hint">Enable LoRA 1</span></div>
            </div>
            <label for="lora1Name">LoRA 1</label>
            <select id="lora1Name"></select>
            <label for="lora1Strength">Strength</label>
            <input id="lora1Strength" type="number" min="0.00" max="1.00" step="0.01" value="0.60" />
          </div>
          <div class="lora-entry">
            <div class="lora-entry-top">
              <div class="lora-toggle"><label class="switch"><input id="lora2Enable" type="checkbox"><span class="track"><span class="thumb"></span></span></label><span class="hint">Enable LoRA 2</span></div>
            </div>
            <label for="lora2Name">LoRA 2</label>
            <select id="lora2Name"></select>
            <label for="lora2Strength">Strength</label>
            <input id="lora2Strength" type="number" min="0.00" max="1.00" step="0.01" value="0.60" />
          </div>
          <div class="lora-entry">
            <div class="lora-entry-top">
              <div class="lora-toggle"><label class="switch"><input id="lora3Enable" type="checkbox"><span class="track"><span class="thumb"></span></span></label><span class="hint">Enable LoRA 3</span></div>
            </div>
            <label for="lora3Name">LoRA 3</label>
            <select id="lora3Name"></select>
            <label for="lora3Strength">Strength</label>
            <input id="lora3Strength" type="number" min="0.00" max="1.00" step="0.01" value="0.60" />
          </div>

          <p class="hint" style="margin:16px 0 6px; font-weight:600; text-transform:uppercase; letter-spacing:.05em">Model patches</p>
          <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
            <label class="switch"><input id="enableMahiro" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label>
            <span class="hint">Enable Mahiro</span>
          </div>
          <div id="epsilonWrap" style="display:none; margin-top:8px">
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <label class="switch"><input id="enableEps" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
              <span class="hint">Enable epsilon scaling</span>
            </div>
            <label for="epsilonFactor">Epsilon scaling factor</label>
            <input id="epsilonFactor" type="number" min="1.000" max="1.050" step="0.001" value="1.005" />
          </div>
          <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
            <label class="switch"><input id="enableApg" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label>
            <span class="hint">Enable APG</span>
          </div>
          <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
            <label class="switch"><input id="enablePag" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
            <span class="hint">Enable PAG</span>
          </div>

          <p class="hint" style="margin:16px 0 6px; font-weight:600; text-transform:uppercase; letter-spacing:.05em">Negative conds</p>
          <div id="negZeroRow" style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
            <label class="switch"><input id="zeroNegative" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
            <span class="hint">Zero out negative prompt</span>
          </div>
          <div id="negWrap">
            <label for="negativePrompt">Negative prompt</label>
            <textarea id="negativePrompt" placeholder="Things to avoid..."></textarea>
          </div>

          <p class="hint" style="margin:16px 0 6px; font-weight:600; text-transform:uppercase; letter-spacing:.05em">Sampler settings</p>
          <div class="row-3">
            <div>
              <label for="seed">Seed</label>
              <input id="seed" type="number" step="1" value="-1" />
              <div class="hint" id="seedHint">Use -1 for random</div>
            </div>
            <div>
              <label for="steps">Steps</label>
              <input id="steps" type="number" min="15" max="35" step="1" value="25" />
            </div>
            <div>
              <label for="cfg">CFG</label>
              <input id="cfg" type="number" step="0.1" value="5.0" />
              <div class="hint" id="cfgHint">Range depends on sampler</div>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="sampler">Sampler</label>
              <select id="sampler"></select>
            </div>
            <div>
              <label for="scheduler">Scheduler</label>
              <select id="scheduler"></select>
            </div>
          </div>
          <label for="denoise" style="margin-top:10px">Denoise</label>
          <input id="denoise" type="number" min="0.00" max="1.00" step="0.01" value="1.00" />
          <div id="fsamplerWrap" style="display:none; margin-top:10px">
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <label class="switch"><input id="enableFsampler" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
              <span class="hint">Enable FSampler</span>
            </div>
            <label for="skipMode">Skip mode</label>
            <select id="skipMode">
              <option value="h2/s4">h2/s4</option>
              <option value="h2/s8">h2/s8</option>
              <option value="h4/s4">h4/s4</option>
              <option value="h4/s8">h4/s8</option>
            </select>
          </div>

          <p class="hint" style="margin:16px 0 6px; font-weight:600; text-transform:uppercase; letter-spacing:.05em">HiresFix</p>
          <div style="display:flex; align-items:center; justify-content:space-between; margin:8px 0">
            <label class="switch"><input id="hiresEnable" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
            <span class="hint" id="hiresHint">Enable HiresFix</span>
          </div>
          <div id="hiresWrap" style="display:none">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-top:4px">
              <label class="switch"><input id="hiresType" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
              <span class="hint">Pixel HiresFix (decode, upscale, encode)</span>
            </div>
            <div class="row-4" style="margin-top:8px">
              <div>
                <label for="hiresScale">Scale by</label>
                <input id="hiresScale" type="number" min="1.00" max="2.00" step="0.01" value="1.50" />
              </div>
              <div>
                <label for="hiresSteps">Steps</label>
                <input id="hiresSteps" type="number" min="10" max="20" step="1" value="15" />
              </div>
              <div>
                <label for="hiresCfg">CFG</label>
                <input id="hiresCfg" type="number" step="0.1" value="5.0" />
                <div class="hint" id="hiresCfgHint">Range depends on sampler</div>
              </div>
              <div>
                <label for="hiresDenoise">Denoise</label>
                <input id="hiresDenoise" type="number" min="0.00" max="1.00" step="0.01" value="0.56" />
              </div>
            </div>
            <div class="row" style="margin-top:8px">
              <div>
                <label for="hiresSampler">Sampler</label>
                <select id="hiresSampler"></select>
              </div>
              <div>
                <label for="hiresScheduler">Scheduler</label>
                <select id="hiresScheduler"></select>
              </div>
            </div>
            <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
              <label class="switch"><input id="hiresSeedCustom" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
              <span class="hint">Use custom HiresFix seed</span>
            </div>
            <div id="hiresSeedWrap" style="display:none">
              <label for="hiresSeed">HiresFix seed</label>
              <input id="hiresSeed" type="number" step="1" value="-1" />
            </div>
          </div>

          <p class="hint" style="margin:16px 0 6px; font-weight:600; text-transform:uppercase; letter-spacing:.05em">Detailers</p>
          <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
            <label class="switch"><input id="usePersonDetailer" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
            <span class="hint">Use person detailer</span>
          </div>
          <div id="detailer1Wrap" style="display:none">
            <div class="row-4" style="margin-top:8px">
              <div>
                <label for="detailer1Seed">Seed</label>
                <input id="detailer1Seed" type="number" value="-1" />
              </div>
              <div>
                <label for="detailer1Steps">Steps</label>
                <input id="detailer1Steps" type="number" min="10" max="30" step="1" value="20" />
              </div>
              <div>
                <label for="detailer1Cfg">CFG</label>
                <input id="detailer1Cfg" type="number" step="0.1" value="5.0" />
                <div class="hint" id="detailer1CfgHint">Range depends on sampler</div>
              </div>
              <div>
                <label for="detailer1Denoise">Denoise</label>
                <input id="detailer1Denoise" type="number" min="0.00" max="1.00" step="0.01" value="0.50" />
              </div>
            </div>
            <div class="row" style="margin-top:8px">
              <div>
                <label for="detailer1Sampler">Sampler</label>
                <select id="detailer1Sampler"></select>
              </div>
              <div>
                <label for="detailer1Scheduler">Scheduler</label>
                <select id="detailer1Scheduler"></select>
              </div>
            </div>
          </div>

          <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
            <label class="switch"><input id="useFaceDetailer" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
            <span class="hint">Use face detailer</span>
          </div>
          <div id="detailer2Wrap" style="display:none">
            <div class="row-4" style="margin-top:8px">
              <div>
                <label for="detailer2Seed">Seed</label>
                <input id="detailer2Seed" type="number" value="-1" />
              </div>
              <div>
                <label for="detailer2Steps">Steps</label>
                <input id="detailer2Steps" type="number" min="10" max="30" step="1" value="20" />
              </div>
              <div>
                <label for="detailer2Cfg">CFG</label>
                <input id="detailer2Cfg" type="number" step="0.1" value="5.0" />
                <div class="hint" id="detailer2CfgHint">Range depends on sampler</div>
              </div>
              <div>
                <label for="detailer2Denoise">Denoise</label>
                <input id="detailer2Denoise" type="number" min="0.00" max="1.00" step="0.01" value="0.50" />
              </div>
            </div>
            <div class="row" style="margin-top:8px">
              <div>
                <label for="detailer2Sampler">Sampler</label>
                <select id="detailer2Sampler"></select>
              </div>
              <div>
                <label for="detailer2Scheduler">Scheduler</label>
                <select id="detailer2Scheduler"></select>
              </div>
            </div>
            <label for="facePrompt" style="margin-top:8px">Face prompt</label>
            <textarea id="facePrompt" placeholder="Leave empty to reuse main prompt"></textarea>
          </div>

          <p class="hint" style="margin:16px 0 6px; font-weight:600; text-transform:uppercase; letter-spacing:.05em">HSV</p>
          <div class="row-3">
            <div>
              <label for="hue">Hue</label>
              <input id="hue" type="number" min="-180" max="180" step="1" value="0" />
            </div>
            <div>
              <label for="saturation">Saturation</label>
              <input id="saturation" type="number" min="-100" max="100" step="1" value="0" />
            </div>
            <div>
              <label for="light">Light</label>
              <input id="light" type="number" min="-100" max="100" step="1" value="0" />
            </div>
          </div>

          <p class="hint" style="margin:16px 0 6px; font-weight:600; text-transform:uppercase; letter-spacing:.05em">Qwen-Image</p>
          <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
            <label class="switch"><input id="useQwen" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
            <span class="hint">Use Qwen-Image img2img</span>
          </div>
          <div id="qwenWrap" style="display:none">
            <label for="qwenPrompt">Qwen prompt</label>
            <textarea id="qwenPrompt" placeholder="Prompt for Qwen-Image"></textarea>
            <div class="row" style="margin-top:8px">
              <div>
                <label for="qwenWidth">Qwen width</label>
                <input id="qwenWidth" type="number" min="64" max="1920" step="16" value="1024" />
              </div>
              <div>
                <label for="qwenHeight">Qwen height</label>
                <input id="qwenHeight" type="number" min="64" max="1920" step="16" value="1024" />
              </div>
            </div>
            <div class="row-3" style="margin-top:8px">
              <div>
                <label for="qwenSeed">Seed</label>
                <input id="qwenSeed" type="number" value="-1" />
              </div>
              <div>
                <label for="qwenSampler">Sampler</label>
                <select id="qwenSampler"></select>
              </div>
              <div>
                <label for="qwenScheduler">Scheduler</label>
                <select id="qwenScheduler"></select>
              </div>
            </div>
            <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
              <label class="switch"><input id="qwen8Steps" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
              <span class="hint">Use 8 steps (off for 4)</span>
            </div>
          </div>

          <p class="hint" style="margin:16px 0 6px; font-weight:600; text-transform:uppercase; letter-spacing:.05em">Etc.</p>
          <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
            <label class="switch"><input id="removeBg" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
            <span class="hint">Remove background (BiRefNet)</span>
          </div>
          <label for="birefnetModel" style="margin-top:8px">BiRefNet model</label>
          <select id="birefnetModel">
            <option value="BiRefNet_dynamic">BiRefNet_dynamic</option>
            <option value="BiRefNet_toonout">BiRefNet_toonout</option>
          </select>

          <hr style="border:0; border-top:1px solid var(--border); margin:14px 0" />
          <div class="row">
            <button class="btn primary" id="runBtn">Generate</button>
            <button class="btn" id="curlBtn" type="button">Copy cURL</button>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="resetBtn" type="button">Reset to defaults</button>
            <button class="btn danger" id="clearBtn" type="button">Clear gallery</button>
          </div>
          <p class="hint" style="margin-top:10px">Endpoint: <span class="mono">https://api.runpod.ai/v2/vpr9pkr7n873/runsync</span></p>
        </div>
      </section>

      <section class="card">
        <header class="body" style="border-bottom:1px solid var(--border)"><strong>Output (AVIF)</strong></header>
        <div class="gallery" id="gallery"></div>
        <div class="body">
          <details>
            <summary class="mono">Request payload (debug)</summary>
            <pre class="mono" id="debugReq"></pre>
          </details>
          <details>
            <summary class="mono">Raw response (debug)</summary>
            <pre class="mono" id="debugResp"></pre>
          </details>
        </div>
      </section>
    </div>

    <div class="sdxl-subtab hidden" data-subtab="regional">
      <section class="card" id="regional-controls">
        <header class="body" style="border-bottom:1px solid var(--border)">
          <strong>Regional Prompter Controls</strong>
          <div style="display:flex; gap:8px; align-items:center">
            <div class="status" id="rp-timer">00:00.00</div>
            <div class="status" id="rp-status">Idle</div>
          </div>
        </header>
        <div class="body">
          <label for="rp-model">Model</label>
          <select id="rp-model">
            <option value="noobaiXLNAIXL_vPred10Version.safetensors">noobaiXLNAIXL_vPred10Version.safetensors</option>
            <option value="ΣIH-1.5.safetensors">ΣIH-1.5.safetensors</option>
            <option value="midnightNAIXLVpredv1.safetensors">midnightNAIXLVpredv1.safetensors</option>
            <option value="oneObsession_v16Noobai.safetensors">oneObsession_v16Noobai.safetensors</option>
            <option value="rouwei_v080Vpred.safetensors">rouwei_v080Vpred.safetensors</option>
          </select>

          <label for="rp-globalPrompt">Global prompt</label>
          <textarea id="rp-globalPrompt" placeholder="Describe the overall scene..."></textarea>

          <div id="rp-negZeroRow" style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
            <label class="switch"><input id="rp-negZero" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
            <span class="hint">Zero out negative prompt</span>
          </div>

          <div id="rp-negWrap">
            <label for="rp-negative">Negative prompt</label>
            <textarea id="rp-negative" placeholder="Things to avoid..."></textarea>
          </div>

          <div id="rp-rouweiWrap" style="display:none; margin-top:10px">
            <label for="rp-rouweiPrefix">Rouwei prefix</label>
            <textarea id="rp-rouweiPrefix" placeholder="Required artist and quality tags for rouwei..."></textarea>
            <div class="hint">Required when using rouwei_v080Vpred.safetensors.</div>
          </div>

          <div>
            <label for="rp-dims">Dimensions</label>
            <select id="rp-dims">
              <option>704x1408</option>
              <option>768x1344</option>
              <option>768x1280</option>
              <option>720x1280</option>
              <option>896x1152</option>
              <option>1024x1024</option>
              <option>1152x896</option>
              <option>1280x768</option>
              <option>1344x768</option>
              <option>1408x704</option>
              <option value="custom">Custom...</option>
            </select>
            <div id="rp-customDimsWrap" class="row" style="display:none; margin-top:10px">
              <div>
                <label for="rp-customWidth">Width</label>
                <input id="rp-customWidth" type="number" min="512" max="2048" step="1" value="1024" />
              </div>
              <div>
                <label for="rp-customHeight">Height</label>
                <input id="rp-customHeight" type="number" min="512" max="2048" step="1" value="1024" />
              </div>
            </div>
          </div>

          <div style="margin-top:10px">
            <label for="rp-batchSize">Batch size</label>
            <input id="rp-batchSize" type="range" min="1" max="4" step="1" value="1" />
            <div class="hint" id="rp-batchSizeHint">1 image per run</div>
          </div>

          <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
            <label class="switch"><input id="rp-rmbg" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
            <span class="hint">Remove background (BiRefNet)</span>
          </div>

          <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
            <label class="switch"><input id="rp-apgToggle" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label>
            <span class="hint">Enable Adaptive Projected Guidance</span>
          </div>

          <label for="rp-globalWeight">Global prompt weight</label>
          <input id="rp-globalWeight" type="number" min="0.01" max="1.00" step="0.01" value="0.35" />
          <div class="hint">Range 0.01–1.00 (default 0.35)</div>

          <div class="region-manager">
            <div class="region-manager-top">
              <strong>Regions</strong>
              <div style="display:flex; gap:8px; align-items:center">
                <button class="btn" id="rp-addRegion" type="button">Add region</button>
              </div>
            </div>
            <div class="hint" style="margin-top:6px">Drag the colored rectangles to adjust each region. Regions cannot overlap or leave the canvas.</div>
            <div id="rp-maskEditor" class="mask-editor">
              <div class="mask-editor-inner"></div>
            </div>
            <div id="rp-regionList" class="region-list"></div>
          </div>

          <hr style="border:0; border-top:1px solid var(--border); margin:14px 0" />
          <div class="row-3">
            <div>
              <label for="rp-seed">Seed</label>
              <input id="rp-seed" type="number" step="1" value="-1" />
              <div class="hint" id="rp-seedHint">Use -1 for random</div>
            </div>
            <div>
              <label for="rp-steps">Steps</label>
              <input id="rp-steps" type="number" min="15" max="35" step="1" value="25" />
            </div>
            <div>
              <label for="rp-cfg">CFG</label>
              <input id="rp-cfg" type="number" step="0.1" value="5.0" />
              <div class="hint" id="rp-cfgHint">Range 4.0–6.0 (non cfg_pp)</div>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="rp-sampler">Sampler</label>
              <select id="rp-sampler"></select>
            </div>
            <div>
              <label for="rp-scheduler">Scheduler</label>
              <select id="rp-scheduler"></select>
            </div>
          </div>

          <hr style="border:0; border-top:1px solid var(--border); margin:14px 0" />
          <div style="display:flex; align-items:center; justify-content:space-between; margin:8px 0">
            <strong>HiresFix</strong>
            <label class="switch"><input id="rp-hiresToggle" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
          </div>
          <div id="rp-hiresWrap" style="display:none">
            <div class="row-4">
              <div>
                <label for="rp-hiresScale">Scale by</label>
                <input id="rp-hiresScale" type="number" min="1.00" max="2.00" step="0.01" value="1.50" />
              </div>
              <div>
                <label for="rp-hiresSteps">Steps</label>
                <input id="rp-hiresSteps" type="number" min="15" max="25" step="1" value="20" />
              </div>
              <div>
                <label for="rp-hiresCfg">CFG</label>
                <input id="rp-hiresCfg" type="number" step="0.1" value="5.0" />
                <div class="hint" id="rp-hiresCfgHint">Range 4.0–6.0 (non cfg_pp)</div>
              </div>
              <div>
                <label for="rp-hiresDenoise">Denoise</label>
                <input id="rp-hiresDenoise" type="number" min="0.00" max="1.00" step="0.01" value="0.56" />
              </div>
            </div>
            <div class="row">
              <div>
                <label for="rp-hiresSampler">Sampler</label>
                <select id="rp-hiresSampler"></select>
              </div>
              <div>
                <label for="rp-hiresScheduler">Scheduler</label>
                <select id="rp-hiresScheduler"></select>
              </div>
            </div>
            <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
              <label class="switch"><input id="rp-hiresSeedCustom" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
              <span class="hint">Use custom HiresFix seed</span>
            </div>
            <div id="rp-hiresSeedWrap" style="display:none">
              <label for="rp-hiresSeed">HiresFix seed</label>
              <input id="rp-hiresSeed" type="number" step="1" value="-1" />
            </div>
          </div>

          <hr style="border:0; border-top:1px solid var(--border); margin:14px 0" />
          <div class="row">
            <button class="btn primary" id="rp-runBtn">Generate</button>
            <button class="btn" id="rp-curlBtn" type="button">Copy cURL</button>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="rp-resetBtn" type="button">Reset to defaults</button>
            <button class="btn danger" id="rp-clearBtn" type="button">Clear gallery</button>
          </div>
          <p class="hint" style="margin-top:10px">Endpoint: <span class="mono">https://api.runpod.ai/v2/vpr9pkr7n873/runsync</span></p>
        </div>
      </section>

      <section class="card">
        <header class="body" style="border-bottom:1px solid var(--border)"><strong>Regional Output (AVIF)</strong></header>
        <div class="gallery" id="rp-gallery"></div>
        <div class="body">
          <details>
            <summary class="mono">Request payload (debug)</summary>
            <pre class="mono" id="rp-debugReq"></pre>
          </details>
          <details>
            <summary class="mono">Raw response (debug)</summary>
            <pre class="mono" id="rp-debugResp"></pre>
          </details>
        </div>
      </section>
    </div>
  </main>

<main id="qwen-main" class="hidden">
  <section class="card" id="q-controls">
    <header class="body" style="border-bottom:1px solid var(--border)">
      <strong>Qwen-Image Controls</strong>
      <div style="display:flex; gap:8px; align-items:center">
        <div class="status" id="q-timer">00:00.00</div>
        <div class="status" id="q-status">Idle</div>
      </div>
    </header>
    <div class="body">
      <div class="hint" style="margin-bottom:10px">
        Uses the same RunPod API key field above (rp_…); endpoint identical to SDXL.
      </div>

      <label for="q-prompt">Prompt</label>
      <textarea id="q-prompt" placeholder="Describe the image..."></textarea>

      <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
        <label class="switch"><input id="q-lowstep" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
        <span class="hint">Use low-step (toggle between 4 and 8 steps; hides negative)</span>
      </div>

      <div id="q-negwrap">
        <label for="q-negative">Negative prompt</label>
        <textarea id="q-negative" placeholder="Things to avoid..."></textarea>
      </div>

      <div class="row">
        <div>
          <label for="q-width">Width</label>
          <input id="q-width" type="number" min="64" max="1920" step="1" value="1024" />
        </div>
        <div>
          <label for="q-height">Height</label>
          <input id="q-height" type="number" min="64" max="1920" step="1" value="1024" />
        </div>
      </div>

      <hr style="border:0; border-top:1px solid var(--border); margin:14px 0" />
      <strong>Sampler</strong>
      <div class="row-3">
        <div>
          <label for="q-seed">Seed</label>
          <input id="q-seed" type="number" step="1" value="-1" />
          <div class="hint" id="q-seedHint">-1 = random (client-side)</div>
        </div>
        <div id="q-steps-wrap">
          <label for="q-steps">Steps</label>
          <input id="q-steps" type="number" min="10" max="30" step="1" value="20" />
          <div id="q-steps-toggle" style="display:none; margin-top:8px; align-items:center; gap:8px;">
            <label class="switch" style="margin:0"><input id="q-steps-toggle-input" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label>
            <span class="hint" id="q-steps-toggle-hint">8 steps</span>
          </div>
        </div>
        <div>
          <label for="q-cfg">CFG</label>
          <input id="q-cfg" type="number" min="1.0" max="3.5" step="0.1" value="2.0" />
          <div class="hint">Always sent (even in low-step)</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="q-sampler">Sampler</label>
          <select id="q-sampler"></select>
        </div>
        <div>
          <label for="q-scheduler">Scheduler</label>
          <select id="q-scheduler"></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label for="q-model-shift">Model shift</label>
          <input id="q-model-shift" type="number" min="0.00" step="0.01" value="3.10" />
          <div class="hint">Two decimal places</div>
        </div>
      </div>

      <hr style="border:0; border-top:1px solid var(--border); margin:14px 0" />
      <div class="row">
        <button class="btn primary" id="q-run">Generate</button>
        <button class="btn" id="q-curl" type="button">Copy cURL</button>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="q-reset" type="button">Reset to defaults</button>
        <button class="btn danger" id="q-clear" type="button">Clear gallery</button>
      </div>
      <p class="hint" style="margin-top:10px">Endpoint: <span class="mono">https://api.runpod.ai/v2/vpr9pkr7n873/runsync</span></p>
    </div>
  </section>

  <section class="card">
    <header class="body" style="border-bottom:1px solid var(--border)"><strong>Output (AVIF)</strong></header>
    <div class="gallery" id="q-gallery"></div>
    <div class="body">
      <details>
        <summary class="mono">Request payload (debug)</summary>
        <pre class="mono" id="q-debugReq"></pre>
      </details>
      <details>
        <summary class="mono">Raw response (debug)</summary>
        <pre class="mono" id="q-debugResp"></pre>
      </details>
    </div>
  </section>
</main>

<main id="ace-main" class="hidden">
  <section class="card" id="ace-controls">
    <header class="body" style="border-bottom:1px solid var(--border)">
      <strong>ACE-Step Controls</strong>
      <div style="display:flex; gap:8px; align-items:center">
        <div class="status" id="ace-timer">00:00.00</div>
        <div class="status" id="ace-status">Idle</div>
      </div>
    </header>
    <div class="body">
      <div class="hint" style="margin-bottom:10px">
        Uses the same RunPod API key field above; dedicated endpoint for ACE-Step audio.
      </div>

      <label for="ace-tags">Tags</label>
      <textarea id="ace-tags" placeholder="Describe the song..."></textarea>

      <label for="ace-structure">Structure</label>
      <textarea id="ace-structure" placeholder="Describe the song structure..."></textarea>

      <label>Length (MM:SS)</label>
      <div class="row">
        <div>
          <label for="ace-minutes">Minutes</label>
          <input id="ace-minutes" type="number" min="0" step="1" value="0" />
        </div>
        <div>
          <label for="ace-seconds">Seconds</label>
          <input id="ace-seconds" type="number" min="0" max="59" step="1" value="30" />
        </div>
      </div>
      <div class="hint">Converted to total seconds before sending.</div>

      <div class="row-3">
        <div>
          <label for="ace-seed">Seed</label>
          <input id="ace-seed" type="number" step="1" value="-1" />
          <div class="hint" id="ace-seedHint">Use -1 for random</div>
        </div>
        <div>
          <label for="ace-steps">Steps</label>
          <input id="ace-steps" type="number" min="25" max="75" step="1" value="50" />
        </div>
        <div>
          <label for="ace-cfg">CFG</label>
          <input id="ace-cfg" type="number" min="1.0" step="0.1" value="5.0" />
          <div class="hint">Minimum 1.0</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="ace-sampler">Sampler</label>
          <select id="ace-sampler"></select>
        </div>
        <div>
          <label for="ace-scheduler">Scheduler</label>
          <select id="ace-scheduler"></select>
        </div>
      </div>

      <label for="ace-quality">Quality</label>
      <select id="ace-quality">
        <option value="96k">96k</option>
        <option value="128k" selected>128k</option>
        <option value="192k">192k</option>
        <option value="320k">320k</option>
      </select>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="ace-run">Generate</button>
        <button class="btn" id="ace-curl" type="button">Copy cURL</button>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="ace-reset" type="button">Reset to defaults</button>
        <button class="btn danger" id="ace-clear" type="button">Clear outputs</button>
      </div>
      <p class="hint" style="margin-top:10px">Endpoint: <span class="mono">https://api.runpod.ai/v2/e1hyz03h6llhvn/runsync</span></p>
    </div>
  </section>

  <section class="card">
    <header class="body" style="border-bottom:1px solid var(--border)"><strong>Output (Opus)</strong></header>
    <div class="gallery" id="ace-gallery"></div>
    <div class="body">
      <details>
        <summary class="mono">Request payload (debug)</summary>
        <pre class="mono" id="ace-debugReq"></pre>
      </details>
      <details>
        <summary class="mono">Raw response (debug)</summary>
        <pre class="mono" id="ace-debugResp"></pre>
      </details>
    </div>
  </section>
</main>


<main id="wan-main" class="hidden">
  <section class="card" id="wan-controls">
    <header class="body" style="border-bottom:1px solid var(--border)">
      <strong>Wan 2.2 Controls</strong>
      <div style="display:flex; gap:8px; align-items:center">
        <div class="status" id="wan-timer">00:00.00</div>
        <div class="status" id="wan-status">Idle</div>
      </div>
    </header>
    <div class="body">
      <div class="hint" style="margin-bottom:10px">
        Uses the same RunPod API key field above; endpoint matches ACE-Step (video/mp4 output).
      </div>

      <label for="wan-img-url">Image URL</label>
      <input id="wan-img-url" type="text" placeholder="https://..." autocomplete="off" spellcheck="false" />
      <div class="hint">Direct link to the starting image.</div>

      <div class="row" style="margin-top:10px">
        <div>
          <label for="wan-megapixels">Megapixels</label>
          <input id="wan-megapixels" type="number" min="0.25" max="1.00" step="0.01" value="0.50" />
          <div class="hint">0.25–1.00 (two decimals).</div>
        </div>
        <div>
          <label for="wan-model-shift">Model shift</label>
          <input id="wan-model-shift" type="number" min="3.00" max="10.00" step="0.01" value="5.00" />
          <div class="hint">Controls CFG shift (3.00–10.00).</div>
        </div>
      </div>

      <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
        <label class="switch"><input id="wan-nsfw" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
        <span class="hint">Enable NSFW LoRAs.</span>
      </div>

      <label for="wan-main-prompt" style="margin-top:12px">Main prompt</label>
      <textarea id="wan-main-prompt" placeholder="Describe the motion..."></textarea>

      <p class="hint" style="margin:18px 0 6px; font-weight:600; text-transform:uppercase; letter-spacing:.05em">Initial generation</p>

      <div class="row">
        <div>
          <label for="wan-initial-length">Frames</label>
          <select id="wan-initial-length">
            <option value="33">33</option>
            <option value="37">37</option>
            <option value="41">41</option>
            <option value="45" selected>45</option>
            <option value="49">49</option>
            <option value="53">53</option>
            <option value="57">57</option>
            <option value="61">61</option>
            <option value="65">65</option>
            <option value="69">69</option>
            <option value="73">73</option>
            <option value="77">77</option>
            <option value="81">81</option>
          </select>
          <div class="hint">First pass frame count.</div>
        </div>
        <div>
          <label for="wan-steps">Steps</label>
          <select id="wan-steps">
            <option value="4" selected>4</option>
            <option value="6">6</option>
            <option value="8">8</option>
          </select>
          <div class="hint">Allowed values: 4, 6, 8.</div>
        </div>
      </div>

      <label for="wan-seed" style="margin-top:12px">Seed</label>
      <input id="wan-seed" type="number" step="1" value="-1" />
      <div class="hint" id="wan-seed-hint">Use -1 for random (client-side).</div>

      <p class="hint" style="margin:18px 0 6px; font-weight:600; text-transform:uppercase; letter-spacing:.05em">Sampler settings</p>

      <div class="row">
        <div>
          <label for="wan-sampler-1">High-noise sampler</label>
          <select id="wan-sampler-1"></select>
        </div>
        <div>
          <label for="wan-scheduler-1">High-noise scheduler</label>
          <select id="wan-scheduler-1"></select>
        </div>
      </div>

      <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
        <label class="switch"><input id="wan-same-sampler-2" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label>
        <span class="hint">Use same sampler for low-noise pass</span>
      </div>
      <div id="wan-sampler-2-wrap">
        <label for="wan-sampler-2">Low-noise sampler</label>
        <select id="wan-sampler-2"></select>
      </div>

      <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
        <label class="switch"><input id="wan-same-scheduler-2" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label>
        <span class="hint">Use same scheduler for low-noise pass</span>
      </div>
      <div id="wan-scheduler-2-wrap">
        <label for="wan-scheduler-2">Low-noise scheduler</label>
        <select id="wan-scheduler-2"></select>
      </div>

      <p class="hint" style="margin:18px 0 6px; font-weight:600; text-transform:uppercase; letter-spacing:.05em">Extend video</p>
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <label class="switch"><input id="wan-extend" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
        <span class="hint">Run a second pass starting from the final frame.</span>
      </div>

      <div id="wan-extend-wrap" style="display:none; margin-top:12px">
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <label class="switch"><input id="wan-alt-prompt" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
          <span class="hint">Use different prompt for second pass</span>
        </div>
        <div id="wan-second-prompt-wrap" style="display:none; margin-top:10px">
          <label for="wan-second-prompt">Second prompt</label>
          <textarea id="wan-second-prompt" placeholder="Describe the continuation..."></textarea>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label for="wan-ext-length">Frames</label>
            <select id="wan-ext-length">
              <option value="33">33</option>
              <option value="37">37</option>
              <option value="41">41</option>
              <option value="45" selected>45</option>
              <option value="49">49</option>
              <option value="53">53</option>
              <option value="57">57</option>
              <option value="61">61</option>
              <option value="65">65</option>
              <option value="69">69</option>
              <option value="73">73</option>
              <option value="77">77</option>
              <option value="81">81</option>
            </select>
            <div class="hint">Extended sequence frame count.</div>
          </div>
          <div>
            <label for="wan-ext-steps">Steps</label>
            <select id="wan-ext-steps">
              <option value="4" selected>4</option>
              <option value="6">6</option>
              <option value="8">8</option>
            </select>
            <div class="hint">Allowed values: 4, 6, 8.</div>
          </div>
        </div>

        <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
          <label class="switch"><input id="wan-ext-seed-same" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label>
          <span class="hint">Reuse initial seed</span>
        </div>
        <div class="hint" id="wan-ext-seed-hint" style="margin-top:4px">Matches initial seed when enabled.</div>

        <p class="hint" style="margin:18px 0 6px; font-weight:600; text-transform:uppercase; letter-spacing:.05em">Extended sampler settings</p>

        <div style="display:flex; align-items:center; justify-content:space-between;">
          <label class="switch"><input id="wan-ext-same-sampler-1" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label>
          <span class="hint">Use initial high-noise sampler</span>
        </div>
        <div id="wan-ext-sampler-1-wrap">
          <label for="wan-ext-sampler-1">Extended high-noise sampler</label>
          <select id="wan-ext-sampler-1"></select>
        </div>

        <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
          <label class="switch"><input id="wan-ext-same-scheduler-1" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label>
          <span class="hint">Use initial high-noise scheduler</span>
        </div>
        <div id="wan-ext-scheduler-1-wrap">
          <label for="wan-ext-scheduler-1">Extended high-noise scheduler</label>
          <select id="wan-ext-scheduler-1"></select>
        </div>

        <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
          <label class="switch"><input id="wan-ext-same-sampler-2" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label>
          <span class="hint">Use extended high-noise sampler for low-noise pass</span>
        </div>
        <div id="wan-ext-sampler-2-wrap">
          <label for="wan-ext-sampler-2">Extended low-noise sampler</label>
          <select id="wan-ext-sampler-2"></select>
        </div>

        <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
          <label class="switch"><input id="wan-ext-same-scheduler-2" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label>
          <span class="hint">Use extended high-noise scheduler for low-noise pass</span>
        </div>
        <div id="wan-ext-scheduler-2-wrap">
          <label for="wan-ext-scheduler-2">Extended low-noise scheduler</label>
          <select id="wan-ext-scheduler-2"></select>
        </div>
      </div>

      <p class="hint" style="margin:18px 0 6px; font-weight:600; text-transform:uppercase; letter-spacing:.05em">Output</p>

      <div style="display:flex; align-items:center; justify-content:space-between;">
        <label class="switch"><input id="wan-interpolate" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label>
        <span class="hint">Interpolate frames with RIFE (24 FPS).</span>
      </div>
      <div id="wan-fast-wrap" style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
        <label class="switch"><input id="wan-fast-interpolation" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label>
        <span class="hint">Use fast mode for RIFE.</span>
      </div>
      <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px">
        <label class="switch"><input id="wan-pingpong" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
        <span class="hint">Ping-pong the final video.</span>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="wan-run">Generate</button>
        <button class="btn" id="wan-curl" type="button">Copy cURL</button>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="wan-reset" type="button">Reset to defaults</button>
        <button class="btn danger" id="wan-clear" type="button">Clear outputs</button>
      </div>
      <p class="hint" style="margin-top:10px">Endpoint: <span class="mono">https://api.runpod.ai/v2/e1hyz03h6llhvn/runsync</span></p>
    </div>
  </section>

  <section class="card">
    <header class="body" style="border-bottom:1px solid var(--border)"><strong>Output (H.264 MP4)</strong></header>
    <div class="gallery" id="wan-gallery"></div>
    <div class="body">
      <details>
        <summary class="mono">Request payload (debug)</summary>
        <pre class="mono" id="wan-debugReq"></pre>
      </details>
      <details>
        <summary class="mono">Raw response (debug)</summary>
        <pre class="mono" id="wan-debugResp"></pre>
      </details>
    </div>
  </section>
</main>



  <!-- Workflow template embedded as JSON for robust placeholder replacement -->
  <script id="workflow-template" type="application/json">{
  "2": {
    "inputs": {
      "ckpt_name": "%checkpoint_name%"
    },
    "class_type": "Checkpoint Loader with Name (Image Saver)",
    "_meta": {
      "title": "Checkpoint Loader with Name (Image Saver)"
    }
  },
  "3": {
    "inputs": {
      "text": "%prompt%",
      "clip": [
        "28",
        1
      ]
    },
    "class_type": "CLIPTextEncode",
    "_meta": {
      "title": "Positive (main)"
    }
  },
  "4": {
    "inputs": {
      "width": "%width%",
      "height": "%height%",
      "batch_size": "%batch_size%"
    },
    "class_type": "EmptyLatentImage",
    "_meta": {
      "title": "Empty Latent Image"
    }
  },
  "5": {
    "inputs": {
      "text": "%rouwei_prefix%",
      "clip": [
        "28",
        1
      ]
    },
    "class_type": "CLIPTextEncode",
    "_meta": {
      "title": "Positive (rouwei prefix)"
    }
  },
  "6": {
    "inputs": {
      "conditioning1": [
        "5",
        0
      ],
      "conditioning2": [
        "3",
        0
      ]
    },
    "class_type": "ImpactConcatConditionings",
    "_meta": {
      "title": "Concat Conditionings"
    }
  },
  "7": {
    "inputs": {
      "string": [
        "2",
        3
      ],
      "substring": "rouwei",
      "case_sensitive": true
    },
    "class_type": "StringContains",
    "_meta": {
      "title": "Contains"
    }
  },
  "8": {
    "inputs": {
      "boolean": [
        "7",
        0
      ],
      "on_true": [
        "6",
        0
      ],
      "on_false": [
        "3",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "rouwei sw"
    }
  },
  "28": {
    "inputs": {
      "PowerLoraLoaderHeaderWidget": {
        "type": "PowerLoraLoaderHeaderWidget"
      },
      "lora_1": {
        "on": "%lora_1_enable%",
        "lora": "%lora_1_name%",
        "strength": "%lora_1_strength%"
      },
      "lora_2": {
        "on": "%lora_2_enable%",
        "lora": "%lora_2_name%",
        "strength": "%lora_2_strength%"
      },
      "lora_3": {
        "on": "%lora_3_enable%",
        "lora": "%lora_3_name%",
        "strength": "%lora_3_strength%"
      },
      "➕ Add Lora": "",
      "model": [
        "2",
        0
      ],
      "clip": [
        "2",
        1
      ]
    },
    "class_type": "Power Lora Loader (rgthree)",
    "_meta": {
      "title": "Power Lora Loader (rgthree)"
    }
  },
  "31": {
    "inputs": {
      "text": "%negative_prompt%",
      "clip": [
        "2",
        1
      ]
    },
    "class_type": "CLIPTextEncode",
    "_meta": {
      "title": "Negative Cond"
    }
  },
  "34": {
    "inputs": {
      "conditioning": [
        "3",
        0
      ]
    },
    "class_type": "ConditioningZeroOut",
    "_meta": {
      "title": "ConditioningZeroOut"
    }
  },
  "35": {
    "inputs": {
      "string": [
        "2",
        3
      ],
      "substring": "rouwei",
      "case_sensitive": true
    },
    "class_type": "StringContains",
    "_meta": {
      "title": "is_rouwei"
    }
  },
  "36": {
    "inputs": {
      "string": [
        "2",
        3
      ],
      "substring": "RectifiedFlow",
      "case_sensitive": true
    },
    "class_type": "StringContains",
    "_meta": {
      "title": "is_nai_rf"
    }
  },
  "37": {
    "inputs": {
      "boolean_a": [
        "35",
        0
      ],
      "boolean_b": [
        "36",
        0
      ]
    },
    "class_type": "Logic Comparison OR",
    "_meta": {
      "title": "OR"
    }
  },
  "39": {
    "inputs": {
      "boolean": [
        "37",
        0
      ],
      "on_true": [
        "40",
        0
      ],
      "on_false": [
        "34",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "If else"
    }
  },
  "40": {
    "inputs": {
      "text": "",
      "clip": [
        "2",
        1
      ]
    },
    "class_type": "CLIPTextEncode",
    "_meta": {
      "title": "blank cond"
    }
  },
  "41": {
    "inputs": {
      "boolean": "%zero_out_negative%",
      "on_true": [
        "39",
        0
      ],
      "on_false": [
        "31",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Zero Out Neg Cond"
    }
  },
  "43": {
    "inputs": {
      "seed": "%seed%",
      "steps": "%steps%",
      "cfg": "%cfg%",
      "sampler_name": "%sampler%",
      "scheduler": "%scheduler%",
      "denoise": "%denoise%",
      "model": [
        "26:25",
        0
      ],
      "positive": [
        "8",
        0
      ],
      "negative": [
        "41",
        0
      ],
      "latent_image": [
        "77",
        0
      ]
    },
    "class_type": "KSampler",
    "_meta": {
      "title": "KSampler"
    }
  },
  "44": {
    "inputs": {
      "seed": "%seed%",
      "steps": "%steps%",
      "cfg": "%cfg%",
      "scheduler": "%scheduler%",
      "sampler": "%fsampler_sampler%",
      "skip_mode": "%skip_mode%",
      "verbose": false,
      "model": [
        "26:25",
        0
      ],
      "positive": [
        "8",
        0
      ],
      "negative": [
        "41",
        0
      ],
      "latent_image": [
        "77",
        0
      ]
    },
    "class_type": "FSampler",
    "_meta": {
      "title": "FSampler"
    }
  },
  "49": {
    "inputs": {
      "seed": "%hiresfix_seed%",
      "steps": "%hiresfix_steps%",
      "cfg": "%hiresfix_cfg%",
      "sampler_name": "%hiresfix_sampler%",
      "scheduler": "%hiresfix_scheduler%",
      "denoise": "%hiresfix_denoise%",
      "model": [
        "26:25",
        0
      ],
      "positive": [
        "8",
        0
      ],
      "negative": [
        "41",
        0
      ],
      "latent_image": [
        "52",
        0
      ]
    },
    "class_type": "KSampler",
    "_meta": {
      "title": "KSampler (HiresFix)"
    }
  },
  "50": {
    "inputs": {
      "upscale_method": "nearest-exact",
      "scale_by": "%hiresfix_upscale_by%",
      "samples": [
        "48:45",
        0
      ]
    },
    "class_type": "LatentUpscaleBy",
    "_meta": {
      "title": "Upscale Latent By"
    }
  },
  "52": {
    "inputs": {
      "boolean": "%hiresfix_type%",
      "on_true": [
        "51:3",
        0
      ],
      "on_false": [
        "50",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "HiresFix Type"
    }
  },
  "53": {
    "inputs": {
      "samples": [
        "54",
        0
      ],
      "vae": [
        "82",
        0
      ]
    },
    "class_type": "VAEDecode",
    "_meta": {
      "title": "VAE Decode"
    }
  },
  "54": {
    "inputs": {
      "boolean": "%hiresfix_enable%",
      "on_true": [
        "49",
        0
      ],
      "on_false": [
        "48:45",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Enable HiresFix"
    }
  },
  "55": {
    "inputs": {
      "guide_size": 512,
      "guide_size_for": true,
      "max_size": 1024,
      "seed": "%detailer_1_seed%",
      "steps": "%detailer_1_steps%",
      "cfg": "%detailer_1_cfg%",
      "sampler_name": "%detailer_1_sampler%",
      "scheduler": "%detailer_1_scheduler%",
      "denoise": "%detailer_1_denoise%",
      "feather": 5,
      "noise_mask": true,
      "force_inpaint": true,
      "bbox_threshold": 0.5,
      "bbox_dilation": 10,
      "bbox_crop_factor": 3,
      "sam_detection_hint": "center-1",
      "sam_dilation": 0,
      "sam_threshold": 0.93,
      "sam_bbox_expansion": 0,
      "sam_mask_hint_threshold": 0.7,
      "sam_mask_hint_use_negative": "False",
      "drop_size": 10,
      "wildcard": "",
      "cycle": 1,
      "inpaint_model": false,
      "noise_mask_feather": 20,
      "tiled_encode": false,
      "tiled_decode": false,
      "image": [
        "53",
        0
      ],
      "model": [
        "26:25",
        0
      ],
      "clip": [
        "28",
        1
      ],
      "vae": [
        "82",
        0
      ],
      "positive": [
        "8",
        0
      ],
      "negative": [
        "41",
        0
      ],
      "bbox_detector": [
        "56",
        0
      ],
      "segm_detector_opt": [
        "56",
        1
      ]
    },
    "class_type": "FaceDetailer",
    "_meta": {
      "title": "Detailer 1 (person yolo8)"
    }
  },
  "56": {
    "inputs": {
      "model_name": "segm/person_yolov8m-seg.pt"
    },
    "class_type": "UltralyticsDetectorProvider",
    "_meta": {
      "title": "UltralyticsDetectorProvider"
    }
  },
  "58": {
    "inputs": {
      "boolean": "%use_person_detailer%",
      "on_true": [
        "55",
        0
      ],
      "on_false": [
        "53",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Use Detailer 1"
    }
  },
  "60": {
    "inputs": {
      "model": "%birefnet_model%",
      "mask_blur": 0,
      "mask_offset": 0,
      "invert_output": false,
      "refine_foreground": true,
      "background": "Alpha",
      "background_color": "#222222",
      "image": [
        "65",
        0
      ]
    },
    "class_type": "BiRefNetRMBG",
    "_meta": {
      "title": "BiRefNet Remove Background (RMBG)"
    }
  },
  "61": {
    "inputs": {
      "boolean": "%remove_bg%",
      "on_true": [
        "60",
        0
      ],
      "on_false": [
        "58",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Remove Background"
    }
  },
  "62": {
    "inputs": {
      "filename_prefix": "ComfyUI",
      "filename_keys": "",
      "foldername_prefix": "",
      "foldername_keys": "",
      "delimiter": "-",
      "save_job_data": "disabled",
      "job_data_per_image": false,
      "job_custom_text": "",
      "save_metadata": false,
      "counter_digits": 4,
      "counter_position": "last",
      "one_counter_per_folder": true,
      "image_preview": true,
      "output_ext": ".avif",
      "quality": 99,
      "images": [
        "61",
        0
      ]
    },
    "class_type": "SaveImageExtended",
    "_meta": {
      "title": "Save Image Extended"
    }
  },
  "65": {
    "inputs": {
      "hue": "%hue%",
      "saturation": "%saturation%",
      "light": "%light%",
      "light_type": "value",
      "image": [
        "80",
        0
      ]
    },
    "class_type": "HueSaturationLightLevels",
    "_meta": {
      "title": "Hue Saturation Light Levels"
    }
  },
  "67": {
    "inputs": {
      "clip_name": "qwen_2.5_vl_7b_fp8_scaled.safetensors",
      "type": "qwen_image",
      "device": "default"
    },
    "class_type": "CLIPLoader",
    "_meta": {
      "title": "Load CLIP"
    }
  },
  "68": {
    "inputs": {
      "unet_name": "qwen_image_fp8_e4m3fn.safetensors",
      "weight_dtype": "default"
    },
    "class_type": "UNETLoader",
    "_meta": {
      "title": "Load Diffusion Model"
    }
  },
  "69": {
    "inputs": {
      "samples": [
        "71",
        0
      ],
      "vae": [
        "76",
        0
      ]
    },
    "class_type": "VAEDecode",
    "_meta": {
      "title": "VAE Decode"
    }
  },
  "71": {
    "inputs": {
      "seed": "%qwen_seed%",
      "steps": [
        "70:79",
        0
      ],
      "cfg": 1,
      "sampler_name": "%qwen_sampler%",
      "scheduler": "%qwen_scheduler%",
      "denoise": 1,
      "model": [
        "70:76",
        0
      ],
      "positive": [
        "74",
        0
      ],
      "negative": [
        "75",
        0
      ],
      "latent_image": [
        "73",
        0
      ]
    },
    "class_type": "KSampler",
    "_meta": {
      "title": "KSampler"
    }
  },
  "72": {
    "inputs": {
      "shift": 3.1,
      "model": [
        "68",
        0
      ]
    },
    "class_type": "ModelSamplingAuraFlow",
    "_meta": {
      "title": "ModelSamplingAuraFlow"
    }
  },
  "73": {
    "inputs": {
      "width": "%qwen_width%",
      "height": "%qwen_height%",
      "batch_size": 1
    },
    "class_type": "EmptySD3LatentImage",
    "_meta": {
      "title": "EmptySD3LatentImage"
    }
  },
  "74": {
    "inputs": {
      "text": "%qwen_prompt%",
      "clip": [
        "67",
        0
      ]
    },
    "class_type": "CLIPTextEncode",
    "_meta": {
      "title": "Qwen Prompt"
    }
  },
  "75": {
    "inputs": {
      "conditioning": [
        "74",
        0
      ]
    },
    "class_type": "ConditioningZeroOut",
    "_meta": {
      "title": "ConditioningZeroOut"
    }
  },
  "76": {
    "inputs": {
      "vae_name": "qwen_image_vae.safetensors"
    },
    "class_type": "VAELoader",
    "_meta": {
      "title": "Load VAE"
    }
  },
  "77": {
    "inputs": {
      "boolean": "%use_qwen_img2img%",
      "on_true": [
        "88",
        0
      ],
      "on_false": [
        "4",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Use Qwen img2img"
    }
  },
  "78": {
    "inputs": {
      "guide_size": 512,
      "guide_size_for": true,
      "max_size": 1024,
      "seed": "%detailer_2_seed%",
      "steps": "%detailer_2_steps%",
      "cfg": "%detailer_2_cfg%",
      "sampler_name": "%detailer_2_sampler%",
      "scheduler": "%detailer_2_scheduler%",
      "denoise": "%detailer_2_denoise%",
      "feather": 5,
      "noise_mask": true,
      "force_inpaint": true,
      "bbox_threshold": 0.5,
      "bbox_dilation": 10,
      "bbox_crop_factor": 3,
      "sam_detection_hint": "center-1",
      "sam_dilation": 0,
      "sam_threshold": 0.93,
      "sam_bbox_expansion": 0,
      "sam_mask_hint_threshold": 0.7,
      "sam_mask_hint_use_negative": "False",
      "drop_size": 10,
      "wildcard": "",
      "cycle": 1,
      "inpaint_model": false,
      "noise_mask_feather": 20,
      "tiled_encode": false,
      "tiled_decode": false,
      "image": [
        "58",
        0
      ],
      "model": [
        "26:25",
        0
      ],
      "clip": [
        "28",
        1
      ],
      "vae": [
        "82",
        0
      ],
      "positive": [
        "91",
        0
      ],
      "negative": [
        "41",
        0
      ],
      "bbox_detector": [
        "79",
        0
      ]
    },
    "class_type": "FaceDetailer",
    "_meta": {
      "title": "Detailer 2 (face yolo8)"
    }
  },
  "79": {
    "inputs": {
      "model_name": "bbox/face_yolov8m.pt"
    },
    "class_type": "UltralyticsDetectorProvider",
    "_meta": {
      "title": "UltralyticsDetectorProvider"
    }
  },
  "80": {
    "inputs": {
      "boolean": "%use_face_detailer%",
      "on_true": [
        "78",
        0
      ],
      "on_false": [
        "58",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Use Detailer 2"
    }
  },
  "81": {
    "inputs": {
      "vae_name": "%vae_name%"
    },
    "class_type": "VAELoader",
    "_meta": {
      "title": "Load VAE"
    }
  },
  "82": {
    "inputs": {
      "boolean": [
        "87:85",
        0
      ],
      "on_true": [
        "2",
        2
      ],
      "on_false": [
        "81",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "VAE Switch"
    }
  },
  "88": {
    "inputs": {
      "pixels": [
        "69",
        0
      ],
      "vae": [
        "82",
        0
      ]
    },
    "class_type": "VAEEncode",
    "_meta": {
      "title": "VAE Encode"
    }
  },
  "89": {
    "inputs": {
      "text": "%face_prompt%",
      "clip": [
        "28",
        1
      ]
    },
    "class_type": "CLIPTextEncode",
    "_meta": {
      "title": "Face Detailer Prompt"
    }
  },
  "90": {
    "inputs": {
      "string": [
        "2",
        3
      ],
      "substring": "rouwei",
      "case_sensitive": true
    },
    "class_type": "StringContains",
    "_meta": {
      "title": "Contains"
    }
  },
  "91": {
    "inputs": {
      "boolean": [
        "90",
        0
      ],
      "on_true": [
        "92",
        0
      ],
      "on_false": [
        "89",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "rouwei sw"
    }
  },
  "92": {
    "inputs": {
      "conditioning1": [
        "5",
        0
      ],
      "conditioning2": [
        "89",
        0
      ]
    },
    "class_type": "ImpactConcatConditionings",
    "_meta": {
      "title": "Concat Conditionings"
    }
  },
  "87:83": {
    "inputs": {
      "string": [
        "2",
        3
      ],
      "substring": "RectifiedFlow",
      "case_sensitive": true
    },
    "class_type": "StringContains",
    "_meta": {
      "title": "Contains"
    }
  },
  "87:85": {
    "inputs": {
      "boolean_a": "%use_baked_vae%",
      "boolean_b": [
        "87:83",
        0
      ]
    },
    "class_type": "Logic Comparison OR",
    "_meta": {
      "title": "Logic Comparison OR"
    }
  },
  "70:78": {
    "inputs": {
      "lora_name": "Qwen-Image-Lightning-8steps-V2.0-bf16.safetensors",
      "strength_model": 1,
      "model": [
        "72",
        0
      ]
    },
    "class_type": "LoraLoaderModelOnly",
    "_meta": {
      "title": "8SLoRA"
    }
  },
  "70:77": {
    "inputs": {
      "lora_name": "Qwen-Image-Lightning-4steps-V2.0-bf16.safetensors",
      "strength_model": 1,
      "model": [
        "72",
        0
      ]
    },
    "class_type": "LoraLoaderModelOnly",
    "_meta": {
      "title": "4SLoRA"
    }
  },
  "70:81": {
    "inputs": {
      "value": 8
    },
    "class_type": "PrimitiveInt",
    "_meta": {
      "title": "8"
    }
  },
  "70:80": {
    "inputs": {
      "value": 4
    },
    "class_type": "PrimitiveInt",
    "_meta": {
      "title": "4"
    }
  },
  "70:74": {
    "inputs": {
      "value": "%qwen_use_8_steps%"
    },
    "class_type": "PrimitiveBoolean",
    "_meta": {
      "title": "(True is 8 Steps)"
    }
  },
  "70:76": {
    "inputs": {
      "boolean": [
        "70:74",
        0
      ],
      "on_true": [
        "70:78",
        0
      ],
      "on_false": [
        "70:77",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Switch"
    }
  },
  "70:79": {
    "inputs": {
      "boolean": [
        "70:74",
        0
      ],
      "on_true": [
        "70:81",
        0
      ],
      "on_false": [
        "70:80",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "If else"
    }
  },
  "15:49": {
    "inputs": {
      "shift": 2.5,
      "model": [
        "28",
        0
      ]
    },
    "class_type": "ModelSamplingSD3",
    "_meta": {
      "title": "ModelSamplingSD3"
    }
  },
  "15:73": {
    "inputs": {
      "boolean": [
        "15:72",
        0
      ],
      "on_true": [
        "15:49",
        0
      ],
      "on_false": [
        "28",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "If else"
    }
  },
  "15:72": {
    "inputs": {
      "string": [
        "2",
        3
      ],
      "substring": "RectifiedFlow",
      "case_sensitive": true
    },
    "class_type": "StringContains",
    "_meta": {
      "title": "Contains"
    }
  },
  "26:16": {
    "inputs": {
      "model": [
        "15:73",
        0
      ]
    },
    "class_type": "Mahiro",
    "_meta": {
      "title": "Mahiro"
    }
  },
  "26:19": {
    "inputs": {
      "scaling_factor": "%epsilon_scaling_factor%",
      "model": [
        "26:20",
        0
      ]
    },
    "class_type": "Epsilon Scaling",
    "_meta": {
      "title": "Epsilon Scaling"
    }
  },
  "26:17": {
    "inputs": {
      "eta": 1,
      "norm_threshold": 20,
      "momentum": 0,
      "model": [
        "26:21",
        0
      ]
    },
    "class_type": "APG",
    "_meta": {
      "title": "Adaptive Projected Guidance"
    }
  },
  "26:18": {
    "inputs": {
      "scale": 2,
      "model": [
        "26:24",
        0
      ]
    },
    "class_type": "PerturbedAttentionGuidance",
    "_meta": {
      "title": "PerturbedAttentionGuidance"
    }
  },
  "26:24": {
    "inputs": {
      "boolean": "%enable_apg%",
      "on_true": [
        "26:17",
        0
      ],
      "on_false": [
        "26:21",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Enable APG"
    }
  },
  "26:21": {
    "inputs": {
      "boolean": [
        "26:23",
        0
      ],
      "on_true": [
        "26:19",
        0
      ],
      "on_false": [
        "26:20",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Enable Epsilon Scaling"
    }
  },
  "26:22": {
    "inputs": {
      "string": [
        "2",
        3
      ],
      "substring": "oneObsession",
      "case_sensitive": true
    },
    "class_type": "StringContains",
    "_meta": {
      "title": "Contains"
    }
  },
  "26:25": {
    "inputs": {
      "boolean": "%enable_pag%",
      "on_true": [
        "26:18",
        0
      ],
      "on_false": [
        "26:24",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Enable PAG"
    }
  },
  "26:20": {
    "inputs": {
      "boolean": "%enable_mahiro%",
      "on_true": [
        "26:16",
        0
      ],
      "on_false": [
        "15:73",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Enable Mahiro"
    }
  },
  "26:23": {
    "inputs": {
      "boolean_a": "%enable_epsilon_scaling%",
      "boolean_b": [
        "26:22",
        0
      ]
    },
    "class_type": "Logic Comparison AND",
    "_meta": {
      "title": "Logic Comparison AND"
    }
  },
  "48:47": {
    "inputs": {
      "string": [
        "2",
        3
      ],
      "substring": "oneObsession",
      "case_sensitive": true
    },
    "class_type": "StringContains",
    "_meta": {
      "title": "Contains"
    }
  },
  "48:46": {
    "inputs": {
      "boolean_a": "%enable_fsampler%",
      "boolean_b": [
        "48:47",
        0
      ]
    },
    "class_type": "Logic Comparison AND",
    "_meta": {
      "title": "AND FSampler"
    }
  },
  "48:45": {
    "inputs": {
      "boolean": [
        "48:46",
        0
      ],
      "on_true": [
        "44",
        0
      ],
      "on_false": [
        "43",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "IFF FSampler"
    }
  },
  "51:1": {
    "inputs": {
      "samples": [
        "48:45",
        0
      ],
      "vae": [
        "82",
        0
      ]
    },
    "class_type": "VAEDecode",
    "_meta": {
      "title": "VAE Decode"
    }
  },
  "51:2": {
    "inputs": {
      "upscale_model": "2x-AnimeSharpV4_RCAN.safetensors",
      "mode": "rescale",
      "rescale_factor": "%hiresfix_upscale_by%",
      "resize_width": 1024,
      "resampling_method": "lanczos",
      "supersample": "true",
      "rounding_modulus": 8,
      "image": [
        "51:1",
        0
      ]
    },
    "class_type": "CR Upscale Image",
    "_meta": {
      "title": "🔍 CR Upscale Image"
    }
  },
  "51:3": {
    "inputs": {
      "pixels": [
        "51:2",
        0
      ],
      "vae": [
        "82",
        0
      ]
    },
    "class_type": "VAEEncode",
    "_meta": {
      "title": "VAE Encode"
    }
  }
}</script>

<script id="qwen-template" type="application/json">
{
  "1": {"inputs":{"unet_name":"qwen_image_fp8_e4m3fn.safetensors","weight_dtype":"default"},"class_type":"UNETLoader","_meta":{"title":"Load Diffusion Model"}},
  "2": {"inputs":{"clip_name":"qwen_2.5_vl_7b.safetensors","type":"qwen_image","device":"default"},"class_type":"CLIPLoader","_meta":{"title":"Load CLIP"}},
  "3": {"inputs":{"vae_name":"qwen_image_vae.safetensors"},"class_type":"VAELoader","_meta":{"title":"Load VAE"}},
  "5": {"inputs":{"value":"%use_low_step%"},"class_type":"PrimitiveBoolean","_meta":{"title":"Low Step"}},
  "6": {"inputs":{"text":"%prompt%","clip":["2",0]},"class_type":"CLIPTextEncode","_meta":{"title":"CLIP Text Encode (Positive Prompt)"}},
  "7": {"inputs":{"text":"%negative_prompt%","clip":["2",0]},"class_type":"CLIPTextEncode","_meta":{"title":"CLIP Text Encode (Negative Prompt)"}},
  "8": {"inputs":{"width":"%width%","height":"%height%","batch_size":1},"class_type":"EmptySD3LatentImage","_meta":{"title":"EmptySD3LatentImage"}},
  "9": {"inputs":{"seed":"%seed%","steps":"%steps%","cfg":["20",0],"sampler_name":"%sampler%","scheduler":"%scheduler%","denoise":1,"model":["10",0],"positive":["6",0],"negative":["14",0],"latent_image":["8",0]},"class_type":"KSampler","_meta":{"title":"KSampler"}},
  "10": {"inputs":{"shift":"%model_shift%","model":["12",0]},"class_type":"ModelSamplingAuraFlow","_meta":{"title":"ModelSamplingAuraFlow"}},
  "11": {"inputs":{"lora_name":"%low_step_lora%","strength_model":1,"model":["1",0]},"class_type":"LoraLoaderModelOnly","_meta":{"title":"LoraLoaderModelOnly"}},
  "12": {"inputs":{"boolean":["5",0],"on_true":["11",0],"on_false":["1",0]},"class_type":"easy ifElse","_meta":{"title":"If else"}},
  "13": {"inputs":{"conditioning":["6",0]},"class_type":"ConditioningZeroOut","_meta":{"title":"ConditioningZeroOut"}},
  "14": {"inputs":{"boolean":["5",0],"on_true":["13",0],"on_false":["7",0]},"class_type":"easy ifElse","_meta":{"title":"If else"}},
  "15": {"inputs":{"samples":["9",0],"vae":["3",0]},"class_type":"VAEDecode","_meta":{"title":"VAE Decode"}},
  "16": {"inputs":{"filename_prefix":"Qwen","filename_keys":"","foldername_prefix":"","foldername_keys":"","delimiter":"-","save_job_data":"disabled","job_data_per_image":false,"job_custom_text":"","save_metadata":false,"counter_digits":4,"counter_position":"last","one_counter_per_folder":true,"image_preview":true,"output_ext":".avif","quality":99,"images":["15",0]},"class_type":"SaveImageExtended","_meta":{"title":"\ud83d\udcbe Save Image Extended"}},
  "20": {"inputs":{"boolean":["5",0],"on_true":["21",0],"on_false":["22",0]},"class_type":"easy ifElse","_meta":{"title":"If else"}},
  "21": {"inputs":{"value":1},"class_type":"PrimitiveFloat","_meta":{"title":"LSCFG"}},
  "22": {"inputs":{"value":"%cfg%"},"class_type":"PrimitiveFloat","_meta":{"title":"Standard CFG"}}
}
</script>

<script id="regional-workflow-template" type="application/json">
{
  "8": {
    "inputs": {
      "ckpt_name": "%model%"
    },
    "class_type": "CheckpointLoaderSimple",
    "_meta": {
      "title": "Load Checkpoint"
    }
  },
  "9": {
    "inputs": {
      "text": "%global_prompt%",
      "clip": [
        "8",
        1
      ]
    },
    "class_type": "CLIPTextEncode",
    "_meta": {
      "title": "Global Prompt"
    }
  },
  "12": {
    "inputs": {
      "seed": "%seed%",
      "steps": "%steps%",
      "cfg": "%cfg%",
      "sampler_name": "%sampler%",
      "scheduler": "%scheduler%",
      "denoise": 1,
      "model": [
        "29:3",
        0
      ],
      "positive": [
        "36",
        0
      ],
      "negative": [
        "33",
        0
      ],
      "latent_image": [
        "14",
        0
      ]
    },
    "class_type": "KSampler",
    "_meta": {
      "title": "KSampler"
    }
  },
  "13": {
    "inputs": {
      "conditioning": [
        "9",
        0
      ]
    },
    "class_type": "ConditioningZeroOut",
    "_meta": {
      "title": "ConditioningZeroOut"
    }
  },
  "14": {
    "inputs": {
      "width": [
        "15",
        0
      ],
      "height": [
        "16",
        0
      ],
      "batch_size": "%batch_size%"
    },
    "class_type": "EmptyLatentImage",
    "_meta": {
      "title": "Empty Latent Image"
    }
  },
  "15": {
    "inputs": {
      "value": "%width%"
    },
    "class_type": "PrimitiveInt",
    "_meta": {
      "title": "Width"
    }
  },
  "16": {
    "inputs": {
      "value": "%height%"
    },
    "class_type": "PrimitiveInt",
    "_meta": {
      "title": "Height"
    }
  },
  "18": {
    "inputs": {
      "x": "%mask_1_x%",
      "y": "%mask_1_y%",
      "width": "%mask_1_width%",
      "height": "%mask_1_height%",
      "image_width": [
        "15",
        0
      ],
      "image_height": [
        "16",
        0
      ],
      "blur_radius": 0
    },
    "class_type": "Mask Rect Area (Advanced)",
    "_meta": {
      "title": "Region 1 Mask"
    }
  },
  "19": {
    "inputs": {
      "x": "%mask_2_x%",
      "y": "%mask_2_y%",
      "width": "%mask_2_width%",
      "height": "%mask_2_height%",
      "image_width": [
        "15",
        0
      ],
      "image_height": [
        "16",
        0
      ],
      "blur_radius": 0
    },
    "class_type": "Mask Rect Area (Advanced)",
    "_meta": {
      "title": "Region 2 Mask"
    }
  },
  "22": {
    "inputs": {
      "samples": [
        "51",
        0
      ],
      "vae": [
        "8",
        2
      ]
    },
    "class_type": "VAEDecode",
    "_meta": {
      "title": "VAE Decode"
    }
  },
  "27": {
    "inputs": {
      "filename_prefix": "ComfyUI",
      "filename_keys": "",
      "foldername_prefix": "",
      "foldername_keys": "",
      "delimiter": "-",
      "save_job_data": "disabled",
      "job_data_per_image": false,
      "job_custom_text": "",
      "save_metadata": false,
      "counter_digits": 4,
      "counter_position": "last",
      "one_counter_per_folder": true,
      "image_preview": true,
      "output_ext": ".avif",
      "quality": 99,
      "images": [
        "54",
        0
      ]
    },
    "class_type": "SaveImageExtended",
    "_meta": {
      "title": "💾 Save Image Extended"
    }
  },
  "30": {
    "inputs": {
      "text": "%region_1_prompt%",
      "clip": [
        "8",
        1
      ]
    },
    "class_type": "CLIPTextEncode",
    "_meta": {
      "title": "Region 1 Prompt"
    }
  },
  "31": {
    "inputs": {
      "text": "%region_2_prompt%",
      "clip": [
        "8",
        1
      ]
    },
    "class_type": "CLIPTextEncode",
    "_meta": {
      "title": "Region 2 Prompt"
    }
  },
  "32": {
    "inputs": {
      "text": "%negative_prompt%",
      "clip": [
        "8",
        1
      ]
    },
    "class_type": "CLIPTextEncode",
    "_meta": {
      "title": "Negative Prompt"
    }
  },
  "33": {
    "inputs": {
      "boolean": "%zero_out_negative%",
      "on_true": [
        "13",
        0
      ],
      "on_false": [
        "32",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Zero Out Negative"
    }
  },
  "35": {
    "inputs": {
      "string": "%model%",
      "substring": "rouwei",
      "case_sensitive": true
    },
    "class_type": "StringContains",
    "_meta": {
      "title": "Contains"
    }
  },
  "36": {
    "inputs": {
      "boolean": [
        "35",
        0
      ],
      "on_true": [
        "38",
        0
      ],
      "on_false": [
        "9",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Use Rouwei Prefix"
    }
  },
  "38": {
    "inputs": {
      "conditioning1": [
        "39",
        0
      ],
      "conditioning2": [
        "9",
        0
      ]
    },
    "class_type": "ImpactConcatConditionings",
    "_meta": {
      "title": "Concat Conditionings"
    }
  },
  "39": {
    "inputs": {
      "text": "%rouwei_prefix%",
      "clip": [
        "8",
        1
      ]
    },
    "class_type": "CLIPTextEncode",
    "_meta": {
      "title": "Rouwei Prefix"
    }
  },
  "40": {
    "inputs": {
      "text": "%region_3_prompt%",
      "clip": [
        "8",
        1
      ]
    },
    "class_type": "CLIPTextEncode",
    "_meta": {
      "title": "Region 3 Prompt"
    }
  },
  "41": {
    "inputs": {
      "text": "%region_4_prompt%",
      "clip": [
        "8",
        1
      ]
    },
    "class_type": "CLIPTextEncode",
    "_meta": {
      "title": "Region 4 Prompt"
    }
  },
  "42": {
    "inputs": {
      "x": "%mask_3_x%",
      "y": "%mask_3_y%",
      "width": "%mask_3_width%",
      "height": "%mask_3_height%",
      "image_width": [
        "15",
        0
      ],
      "image_height": [
        "16",
        0
      ],
      "blur_radius": 0
    },
    "class_type": "Mask Rect Area (Advanced)",
    "_meta": {
      "title": "Region 3 Mask"
    }
  },
  "43": {
    "inputs": {
      "x": "%mask_4_x%",
      "y": "%mask_4_y%",
      "width": "%mask_4_width%",
      "height": "%mask_4_height%",
      "image_width": [
        "15",
        0
      ],
      "image_height": [
        "16",
        0
      ],
      "blur_radius": 0
    },
    "class_type": "Mask Rect Area (Advanced)",
    "_meta": {
      "title": "Region 3 Mask"
    }
  },
  "47": {
    "inputs": {
      "model": "BiRefNet_dynamic",
      "mask_blur": 0,
      "mask_offset": 0,
      "invert_output": false,
      "refine_foreground": false,
      "background": "Alpha",
      "background_color": "#222222",
      "image": [
        "22",
        0
      ]
    },
    "class_type": "BiRefNetRMBG",
    "_meta": {
      "title": "BiRefNet Remove Background (RMBG)"
    }
  },
  "51": {
    "inputs": {
      "boolean": "%hiresfix_enable%",
      "on_true": [
        "53",
        0
      ],
      "on_false": [
        "12",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Enable HiresFix"
    }
  },
  "52": {
    "inputs": {
      "upscale_method": "nearest-exact",
      "scale_by": "%hiresfix_scale_by%",
      "samples": [
        "12",
        0
      ]
    },
    "class_type": "LatentUpscaleBy",
    "_meta": {
      "title": "Upscale Latent By"
    }
  },
  "53": {
    "inputs": {
      "seed": "%hiresfix_seed%",
      "steps": "%hiresfix_steps%",
      "cfg": "%hiresfix_cfg%",
      "sampler_name": "%hiresfix_sampler%",
      "scheduler": "%hiresfix_scheduler%",
      "denoise": "%hiresfix_denoise%",
      "model": [
        "29:3",
        0
      ],
      "positive": [
        "36",
        0
      ],
      "negative": [
        "33",
        0
      ],
      "latent_image": [
        "52",
        0
      ]
    },
    "class_type": "KSampler",
    "_meta": {
      "title": "KSampler"
    }
  },
  "54": {
    "inputs": {
      "boolean": "%remove_bg%",
      "on_true": [
        "47",
        0
      ],
      "on_false": [
        "22",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Remove Background"
    }
  },
  "55": {
    "inputs": {
      "eta": 1,
      "norm_threshold": 20,
      "momentum": 0,
      "model": [
        "8",
        0
      ]
    },
    "class_type": "APG",
    "_meta": {
      "title": "Adaptive Projected Guidance"
    }
  },
  "56": {
    "inputs": {
      "boolean": "%enable_apg%",
      "on_true": [
        "55",
        0
      ],
      "on_false": [
        "8",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Enable APG"
    }
  },
  "29:7": {
    "inputs": {
      "a": 1,
      "b": [
        "29:6",
        0
      ],
      "operation": "subtract"
    },
    "class_type": "easy mathFloat",
    "_meta": {
      "title": "Math Float"
    }
  },
  "29:6": {
    "inputs": {
      "value": "%global_prompt_weight%"
    },
    "class_type": "PrimitiveFloat",
    "_meta": {
      "title": "Float"
    }
  },
  "29:2": {
    "inputs": {
      "region_1": [
        "29:1",
        0
      ],
      "region_2": [
        "29:29",
        0
      ],
      "region_3": [
        "29:28",
        0
      ],
      "region_4": [
        "29:32",
        0
      ]
    },
    "class_type": "AttentionCoupleRegions",
    "_meta": {
      "title": "Attention Couple Regions"
    }
  },
  "29:3": {
    "inputs": {
      "global_prompt_weight": [
        "29:6",
        0
      ],
      "width": [
        "15",
        0
      ],
      "height": [
        "16",
        0
      ],
      "model": [
        "56",
        0
      ],
      "base_prompt": [
        "36",
        0
      ],
      "regions": [
        "29:2",
        0
      ]
    },
    "class_type": "AttentionCouple",
    "_meta": {
      "title": "Attention Couple"
    }
  },
  "29:1": {
    "inputs": {
      "weight": [
        "29:7",
        0
      ],
      "cond": [
        "30",
        0
      ],
      "mask": [
        "18",
        0
      ]
    },
    "class_type": "AttentionCoupleRegion",
    "_meta": {
      "title": "Attention Couple Region"
    }
  },
  "29:29": {
    "inputs": {
      "switch": "%enable_region_2%",
      "on_true": [
        "29:4",
        0
      ]
    },
    "class_type": "BooleanSwitch",
    "_meta": {
      "title": "Enable Region 2"
    }
  },
  "29:28": {
    "inputs": {
      "switch": "%enable_region_3%",
      "on_true": [
        "29:30",
        0
      ]
    },
    "class_type": "BooleanSwitch",
    "_meta": {
      "title": "Enable Region 3"
    }
  },
  "29:32": {
    "inputs": {
      "switch": "%enable_region_4%",
      "on_true": [
        "29:31",
        0
      ]
    },
    "class_type": "BooleanSwitch",
    "_meta": {
      "title": "Enable Region 4"
    }
  },
  "29:30": {
    "inputs": {
      "weight": [
        "29:7",
        0
      ],
      "cond": [
        "40",
        0
      ],
      "mask": [
        "42",
        0
      ]
    },
    "class_type": "AttentionCoupleRegion",
    "_meta": {
      "title": "Attention Couple Region"
    }
  },
  "29:4": {
    "inputs": {
      "weight": [
        "29:7",
        0
      ],
      "cond": [
        "31",
        0
      ],
      "mask": [
        "19",
        0
      ]
    },
    "class_type": "AttentionCoupleRegion",
    "_meta": {
      "title": "Attention Couple Region"
    }
  },
  "29:31": {
    "inputs": {
      "weight": [
        "29:7",
        0
      ],
      "cond": [
        "41",
        0
      ],
      "mask": [
        "43",
        0
      ]
    },
    "class_type": "AttentionCoupleRegion",
    "_meta": {
      "title": "Attention Couple Region"
    }
  }
}
</script>

<script id="wan-template" type="application/json">
{
  "1": {
    "inputs": {
      "clip_name": "umt5_xxl_fp16.safetensors",
      "type": "wan",
      "device": "default"
    },
    "class_type": "CLIPLoader",
    "_meta": {
      "title": "Load CLIP"
    }
  },
  "2": {
    "inputs": {
      "vae_name": "wan_2.1_vae.safetensors"
    },
    "class_type": "VAELoader",
    "_meta": {
      "title": "Load VAE"
    }
  },
  "3": {
    "inputs": {
      "unet_name": "wan2.2_i2v_high_noise_14B_fp16.safetensors",
      "weight_dtype": "default"
    },
    "class_type": "UNETLoader",
    "_meta": {
      "title": "Load Diffusion Model"
    }
  },
  "4": {
    "inputs": {
      "unet_name": "wan2.2_i2v_low_noise_14B_fp16.safetensors",
      "weight_dtype": "default"
    },
    "class_type": "UNETLoader",
    "_meta": {
      "title": "Load Diffusion Model"
    }
  },
  "6": {
    "inputs": {
      "lora_name": "wan2.2_i2v_lightx2v_4steps_lora_v1_high_noise.safetensors",
      "strength_model": 1.0,
      "model": [
        "62",
        0
      ]
    },
    "class_type": "LoraLoaderModelOnly",
    "_meta": {
      "title": "lightx2v High"
    }
  },
  "7": {
    "inputs": {
      "lora_name": "wan2.2_i2v_lightx2v_4steps_lora_v1_low_noise.safetensors",
      "strength_model": 1.0,
      "model": [
        "63",
        0
      ]
    },
    "class_type": "LoraLoaderModelOnly",
    "_meta": {
      "title": "lightx2v Low"
    }
  },
  "38": {
    "inputs": {
      "lora_name": "NSFW-22-H-e8.safetensors",
      "strength_model": 1,
      "strength_clip": 1,
      "model": [
        "3",
        0
      ],
      "clip": [
        "1",
        0
      ]
    },
    "class_type": "LoraLoader",
    "_meta": {
      "title": "NSFW H"
    }
  },
  "39": {
    "inputs": {
      "value": "%is_nsfw%"
    },
    "class_type": "PrimitiveBoolean",
    "_meta": {
      "title": "Is NSFW"
    }
  },
  "42": {
    "inputs": {
      "lora_name": "NSFW-22-L-e8.safetensors",
      "strength_model": 1,
      "model": [
        "4",
        0
      ]
    },
    "class_type": "LoraLoaderModelOnly",
    "_meta": {
      "title": "NSFW L"
    }
  },
  "48": {
    "inputs": {
      "ckpt_name": "rife49.pth",
      "clear_cache_after_n_frames": 10,
      "multiplier": 2,
      "fast_mode": "%fast_interpolation%",
      "ensemble": true,
      "scale_factor": 1,
      "frames": [
        "76",
        0
      ]
    },
    "class_type": "RIFE VFI",
    "_meta": {
      "title": "RIFE VFI"
    }
  },
  "54": {
    "inputs": {
      "fps": [
        "52:51",
        0
      ],
      "images": [
        "80:77",
        0
      ]
    },
    "class_type": "CreateVideo",
    "_meta": {
      "title": "Create Video"
    }
  },
  "55": {
    "inputs": {
      "filename_prefix": "video/ComfyUI",
      "format": "mp4",
      "codec": "h264",
      "video": [
        "54",
        0
      ]
    },
    "class_type": "SaveVideo",
    "_meta": {
      "title": "Save Video"
    }
  },
  "60": {
    "inputs": {
      "url": "%img_url%",
      "cache": true
    },
    "class_type": "LoadImageByUrl //Browser",
    "_meta": {
      "title": "Load Image By URL"
    }
  },
  "61": {
    "inputs": {
      "boolean": [
        "39",
        0
      ],
      "on_true": [
        "38",
        1
      ],
      "on_false": [
        "1",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "NSFW Switch"
    }
  },
  "62": {
    "inputs": {
      "boolean": [
        "39",
        0
      ],
      "on_true": [
        "38",
        0
      ],
      "on_false": [
        "3",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Switch"
    }
  },
  "63": {
    "inputs": {
      "boolean": [
        "39",
        0
      ],
      "on_true": [
        "42",
        0
      ],
      "on_false": [
        "4",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Switch"
    }
  },
  "69": {
    "inputs": {
      "value": "%model_shift%"
    },
    "class_type": "PrimitiveFloat",
    "_meta": {
      "title": "Model Shift"
    }
  },
  "76": {
    "inputs": {
      "boolean": "%extend_video%",
      "on_true": [
        "65:30",
        0
      ],
      "on_false": [
        "24:16",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Extend Video"
    }
  },
  "83": {
    "inputs": {
      "value": "%alt_prompt_2nd_pass%"
    },
    "class_type": "PrimitiveBoolean",
    "_meta": {
      "title": "Use Different Prompt for Second Pass"
    }
  },
  "84": {
    "inputs": {
      "boolean": [
        "83",
        0
      ],
      "on_true": [
        "82:12",
        0
      ],
      "on_false": [
        "59:12",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Prompt sw"
    }
  },
  "85": {
    "inputs": {
      "boolean": [
        "83",
        0
      ],
      "on_true": [
        "82:13",
        0
      ],
      "on_false": [
        "59:13",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Prompt sw"
    }
  },
  "37:18": {
    "inputs": {
      "image": [
        "37:20",
        0
      ]
    },
    "class_type": "GetImageSizeAndCount",
    "_meta": {
      "title": "Get Image Size & Count"
    }
  },
  "37:20": {
    "inputs": {
      "upscale_method": "nearest-exact",
      "megapixels": "%megapixels%",
      "image": [
        "60",
        0
      ]
    },
    "class_type": "ImageScaleToTotalPixels",
    "_meta": {
      "title": "ImageScaleToTotalPixels"
    }
  },
  "37:19": {
    "inputs": {
      "width": [
        "37:18",
        1
      ],
      "height": [
        "37:18",
        2
      ],
      "upscale_method": "nearest-exact",
      "keep_proportion": "resize",
      "pad_color": "0, 0, 0",
      "crop_position": "center",
      "divisible_by": 16,
      "device": "gpu",
      "image": [
        "60",
        0
      ]
    },
    "class_type": "ImageResizeKJv2",
    "_meta": {
      "title": "Resize Image v2"
    }
  },
  "59:57": {
    "inputs": {
      "string_a": "nsfwsks",
      "string_b": [
        "59:58",
        0
      ],
      "delimiter": ", "
    },
    "class_type": "StringConcatenate",
    "_meta": {
      "title": "Concatenate"
    }
  },
  "59:12": {
    "inputs": {
      "text": [
        "59:59",
        0
      ],
      "clip": [
        "61",
        0
      ]
    },
    "class_type": "CLIPTextEncode",
    "_meta": {
      "title": "Text Encode"
    }
  },
  "59:59": {
    "inputs": {
      "boolean": [
        "39",
        0
      ],
      "on_true": [
        "59:57",
        0
      ],
      "on_false": [
        "59:58",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "If else"
    }
  },
  "59:13": {
    "inputs": {
      "conditioning": [
        "59:12",
        0
      ]
    },
    "class_type": "ConditioningZeroOut",
    "_meta": {
      "title": "Zero"
    }
  },
  "59:58": {
    "inputs": {
      "value": "%main_prompt%"
    },
    "class_type": "PrimitiveStringMultiline",
    "_meta": {
      "title": "Main Prompt"
    }
  },
  "82:57": {
    "inputs": {
      "string_a": "nsfwsks",
      "string_b": [
        "82:58",
        0
      ],
      "delimiter": ", "
    },
    "class_type": "StringConcatenate",
    "_meta": {
      "title": "Concatenate"
    }
  },
  "82:12": {
    "inputs": {
      "text": [
        "82:59",
        0
      ],
      "clip": [
        "61",
        0
      ]
    },
    "class_type": "CLIPTextEncode",
    "_meta": {
      "title": "Text Encode"
    }
  },
  "82:59": {
    "inputs": {
      "boolean": [
        "39",
        0
      ],
      "on_true": [
        "82:57",
        0
      ],
      "on_false": [
        "82:58",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "If else"
    }
  },
  "82:13": {
    "inputs": {
      "conditioning": [
        "82:12",
        0
      ]
    },
    "class_type": "ConditioningZeroOut",
    "_meta": {
      "title": "Zero"
    }
  },
  "82:58": {
    "inputs": {
      "value": "%second_prompt%"
    },
    "class_type": "PrimitiveStringMultiline",
    "_meta": {
      "title": "Main Prompt"
    }
  },
  "24:16": {
    "inputs": {
      "samples": [
        "24:9",
        0
      ],
      "vae": [
        "2",
        0
      ]
    },
    "class_type": "VAEDecode",
    "_meta": {
      "title": "VAE Decode"
    }
  },
  "24:5": {
    "inputs": {
      "shift": [
        "69",
        0
      ],
      "model": [
        "7",
        0
      ]
    },
    "class_type": "ModelSamplingSD3",
    "_meta": {
      "title": "ModelSamplingSD3"
    }
  },
  "24:22": {
    "inputs": {
      "op": "Div",
      "a": [
        "24:21",
        0
      ],
      "b": 2
    },
    "class_type": "CM_IntBinaryOperation",
    "_meta": {
      "title": "IntBinaryOperation"
    }
  },
  "24:21": {
    "inputs": {
      "value": "%steps%"
    },
    "class_type": "PrimitiveInt",
    "_meta": {
      "title": "Steps"
    }
  },
  "24:14": {
    "inputs": {
      "add_noise": "enable",
      "noise_seed": "%seed%",
      "steps": [
        "24:21",
        0
      ],
      "cfg": 1,
      "sampler_name": "%sampler_1%",
      "scheduler": "%scheduler_1%",
      "start_at_step": 0,
      "end_at_step": [
        "24:22",
        0
      ],
      "return_with_leftover_noise": "enable",
      "model": [
        "24:8",
        0
      ],
      "positive": [
        "24:11",
        0
      ],
      "negative": [
        "24:11",
        1
      ],
      "latent_image": [
        "24:11",
        2
      ]
    },
    "class_type": "KSamplerAdvanced",
    "_meta": {
      "title": "KSampler (High Noise)"
    }
  },
  "24:9": {
    "inputs": {
      "add_noise": "disable",
      "noise_seed": 0,
      "steps": [
        "24:21",
        0
      ],
      "cfg": 1,
      "sampler_name": "%sampler_2%",
      "scheduler": "%scheduler_2%",
      "start_at_step": [
        "24:22",
        0
      ],
      "end_at_step": [
        "24:21",
        0
      ],
      "return_with_leftover_noise": "disable",
      "model": [
        "24:5",
        0
      ],
      "positive": [
        "24:11",
        0
      ],
      "negative": [
        "24:11",
        1
      ],
      "latent_image": [
        "24:14",
        0
      ]
    },
    "class_type": "KSamplerAdvanced",
    "_meta": {
      "title": "KSampler (Low Noise)"
    }
  },
  "24:11": {
    "inputs": {
      "width": [
        "37:19",
        1
      ],
      "height": [
        "37:19",
        2
      ],
      "length": "%initial_length%",
      "batch_size": 1,
      "positive": [
        "59:12",
        0
      ],
      "negative": [
        "59:13",
        0
      ],
      "vae": [
        "2",
        0
      ],
      "start_image": [
        "37:19",
        0
      ]
    },
    "class_type": "WanImageToVideo",
    "_meta": {
      "title": "WanImageToVideo"
    }
  },
  "24:8": {
    "inputs": {
      "shift": [
        "69",
        0
      ],
      "model": [
        "6",
        0
      ]
    },
    "class_type": "ModelSamplingSD3",
    "_meta": {
      "title": "ModelSamplingSD3"
    }
  },
  "65:5": {
    "inputs": {
      "shift": [
        "69",
        0
      ],
      "model": [
        "7",
        0
      ]
    },
    "class_type": "ModelSamplingSD3",
    "_meta": {
      "title": "ModelSamplingSD3"
    }
  },
  "65:22": {
    "inputs": {
      "op": "Div",
      "a": [
        "65:21",
        0
      ],
      "b": 2
    },
    "class_type": "CM_IntBinaryOperation",
    "_meta": {
      "title": "IntBinaryOperation"
    }
  },
  "65:21": {
    "inputs": {
      "value": "%ext_steps%"
    },
    "class_type": "PrimitiveInt",
    "_meta": {
      "title": "Steps"
    }
  },
  "65:29": {
    "inputs": {
      "images": [
        "24:16",
        0
      ]
    },
    "class_type": "FinalFrameSelector",
    "_meta": {
      "title": "Final Frame Selector"
    }
  },
  "65:16": {
    "inputs": {
      "samples": [
        "65:9",
        0
      ],
      "vae": [
        "2",
        0
      ]
    },
    "class_type": "VAEDecode",
    "_meta": {
      "title": "VAE Decode"
    }
  },
  "65:30": {
    "inputs": {
      "Video_A": [
        "24:16",
        0
      ],
      "Video_B": [
        "65:16",
        0
      ]
    },
    "class_type": "VideoMerge",
    "_meta": {
      "title": "Video Merge"
    }
  },
  "65:8": {
    "inputs": {
      "shift": [
        "69",
        0
      ],
      "model": [
        "6",
        0
      ]
    },
    "class_type": "ModelSamplingSD3",
    "_meta": {
      "title": "ModelSamplingSD3"
    }
  },
  "65:11": {
    "inputs": {
      "width": [
        "37:19",
        1
      ],
      "height": [
        "37:19",
        2
      ],
      "length": "%ext_length%",
      "batch_size": 1,
      "positive": [
        "84",
        0
      ],
      "negative": [
        "85",
        0
      ],
      "vae": [
        "2",
        0
      ],
      "start_image": [
        "65:29",
        0
      ]
    },
    "class_type": "WanImageToVideo",
    "_meta": {
      "title": "WanImageToVideo"
    }
  },
  "65:14": {
    "inputs": {
      "add_noise": "enable",
      "noise_seed": "%ext_seed%",
      "steps": [
        "65:21",
        0
      ],
      "cfg": 1,
      "sampler_name": "%ext_sampler_1%",
      "scheduler": "%ext_scheduler_1%",
      "start_at_step": 0,
      "end_at_step": [
        "65:22",
        0
      ],
      "return_with_leftover_noise": "enable",
      "model": [
        "65:8",
        0
      ],
      "positive": [
        "65:11",
        0
      ],
      "negative": [
        "65:11",
        1
      ],
      "latent_image": [
        "65:11",
        2
      ]
    },
    "class_type": "KSamplerAdvanced",
    "_meta": {
      "title": "KSampler (High Noise)"
    }
  },
  "65:9": {
    "inputs": {
      "add_noise": "disable",
      "noise_seed": 0,
      "steps": [
        "65:21",
        0
      ],
      "cfg": 1,
      "sampler_name": "%ext_sampler_2%",
      "scheduler": "%ext_scheduler_2%",
      "start_at_step": [
        "65:22",
        0
      ],
      "end_at_step": [
        "65:21",
        0
      ],
      "return_with_leftover_noise": "disable",
      "model": [
        "65:5",
        0
      ],
      "positive": [
        "65:11",
        0
      ],
      "negative": [
        "65:11",
        1
      ],
      "latent_image": [
        "65:14",
        0
      ]
    },
    "class_type": "KSamplerAdvanced",
    "_meta": {
      "title": "KSampler (Low Noise)"
    }
  },
  "52:50": {
    "inputs": {
      "boolean": [
        "52:47",
        0
      ],
      "on_true": [
        "48",
        0
      ],
      "on_false": [
        "24:16",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "If else"
    }
  },
  "52:45": {
    "inputs": {
      "value": 24
    },
    "class_type": "PrimitiveInt",
    "_meta": {
      "title": "24"
    }
  },
  "52:46": {
    "inputs": {
      "value": 16
    },
    "class_type": "PrimitiveInt",
    "_meta": {
      "title": "16"
    }
  },
  "52:51": {
    "inputs": {
      "boolean": [
        "52:47",
        0
      ],
      "on_true": [
        "52:45",
        0
      ],
      "on_false": [
        "52:46",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "If else"
    }
  },
  "52:47": {
    "inputs": {
      "value": "%interpolate%"
    },
    "class_type": "PrimitiveBoolean",
    "_meta": {
      "title": "Interpolate Output"
    }
  },
  "80:77": {
    "inputs": {
      "boolean": "%ping-pong%",
      "on_true": [
        "80:79",
        0
      ],
      "on_false": [
        "52:50",
        0
      ]
    },
    "class_type": "easy ifElse",
    "_meta": {
      "title": "Ping-Pong Output"
    }
  },
  "80:79": {
    "inputs": {
      "Video_A": [
        "52:50",
        0
      ],
      "Video_B": [
        "80:80",
        0
      ]
    },
    "class_type": "VideoMerge",
    "_meta": {
      "title": "Video Merge"
    }
  },
  "80:80": {
    "inputs": {
      "selected_indexes": "2:0",
      "images": [
        "80:78",
        0
      ]
    },
    "class_type": "ImageSelector",
    "_meta": {
      "title": "ImageSelector"
    }
  },
  "80:78": {
    "inputs": {
      "Images": [
        "52:50",
        0
      ]
    },
    "class_type": "ReverseFrameSequence",
    "_meta": {
      "title": "Reverse Frame Sequence"
    }
  }
}
</script>

<script id="ace-template" type="application/json">
{
  "1": {
    "inputs": {
      "ckpt_name": "ace_step_v1_3.safetensors"
    },
    "class_type": "CheckpointLoaderSimple",
    "_meta": {
      "title": "Load Checkpoint"
    }
  },
  "3": {
    "inputs": {
      "seconds": "%length%",
      "batch_size": 1
    },
    "class_type": "EmptyAceStepLatentAudio",
    "_meta": {
      "title": "EmptyAceStepLatentAudio"
    }
  },
  "7": {
    "inputs": {
      "tags": "%tags%",
      "lyrics": "%structure%",
      "lyrics_strength": 0.99,
      "clip": [
        "1",
        1
      ]
    },
    "class_type": "TextEncodeAceStepAudio",
    "_meta": {
      "title": "TextEncodeAceStepAudio"
    }
  },
  "8": {
    "inputs": {
      "seed": "%seed%",
      "steps": "%steps%",
      "cfg": "%cfg%",
      "sampler_name": "%sampler%",
      "scheduler": "%scheduler%",
      "denoise": 1,
      "model": [
        "11",
        0
      ],
      "positive": [
        "7",
        0
      ],
      "negative": [
        "9",
        0
      ],
      "latent_image": [
        "3",
        0
      ]
    },
    "class_type": "KSampler",
    "_meta": {
      "title": "KSampler"
    }
  },
  "9": {
    "inputs": {
      "conditioning": [
        "7",
        0
      ]
    },
    "class_type": "ConditioningZeroOut",
    "_meta": {
      "title": "ConditioningZeroOut"
    }
  },
  "10": {
    "inputs": {
      "shift": 5,
      "model": [
        "1",
        0
      ]
    },
    "class_type": "ModelSamplingSD3",
    "_meta": {
      "title": "ModelSamplingSD3"
    }
  },
  "11": {
    "inputs": {
      "model": [
        "10",
        0
      ],
      "operation": [
        "12",
        0
      ]
    },
    "class_type": "LatentApplyOperationCFG",
    "_meta": {
      "title": "ApplyOperationCFG"
    }
  },
  "12": {
    "inputs": {
      "multiplier": 1
    },
    "class_type": "LatentOperationTonemapReinhard",
    "_meta": {
      "title": "LatentOperationTonemapReinhard"
    }
  },
  "13": {
    "inputs": {
      "samples": [
        "8",
        0
      ],
      "vae": [
        "1",
        2
      ]
    },
    "class_type": "VAEDecodeAudio",
    "_meta": {
      "title": "VAEDecodeAudio"
    }
  },
  "14": {
    "inputs": {
      "filename_prefix": "audio/ComfyUI",
      "quality": "%quality%",
      "audioUI": "",
      "audio": [
        "13",
        0
      ]
    },
    "class_type": "SaveAudioOpus",
    "_meta": {
      "title": "Save Audio (Opus)"
    }
  }
}
</script>



  <script>
    const ENDPOINT = 'https://api.runpod.ai/v2/vpr9pkvlr7n873/runsync';
    const STATUS_ENDPOINT = ENDPOINT.replace('/runsync', '/status');
    const ACE_ENDPOINT = 'https://api.runpod.ai/v2/e1hyz03h6llhvn/runsync';
    const ACE_STATUS_ENDPOINT = ACE_ENDPOINT.replace('/runsync', '/status');
    const WAN_ENDPOINT = ACE_ENDPOINT;
    const WAN_STATUS_ENDPOINT = ACE_STATUS_ENDPOINT;
    const ACE_BASE_ENDPOINT = ACE_ENDPOINT.replace(/\/runsync$/, '');
    const ACE_FILE_ENDPOINT = `${ACE_BASE_ENDPOINT}/file`;
    const ACE_FILES_ENDPOINT = `${ACE_BASE_ENDPOINT}/files`;
    const ACE_RUNS_ENDPOINT = `${ACE_BASE_ENDPOINT}/runs`;
    const ACE_RUN_ENDPOINT = `${ACE_BASE_ENDPOINT}/run`;
    const SAMPLERS = [
      'euler', 'euler_ancestral', 'euler_cfg_pp', 'euler_ancestral_cfg_pp',
      'heunpp2', 'lcm', 'dpmpp_2m', 'dpmpp_2m_cfg_pp', 'dpmpp_2s_ancestral',
      'dpmpp_sde', 'dpmpp_2s_ancestral_cfg_pp', 'dpmpp_2m_sde_heun',
      'res_multistep', 'res_multistep_cfg_pp', 'res_multistep_ancestral_cfg_pp',
      'res_2s_ode', 'sa_solver_pece', 'ipndm', 'deis', 'er_sde', 'seeds_2',
      'gradient_estimation', 'gradient_estimation_cfg_pp', 'uni_pc'
    ];
    const SCHEDULERS = ['normal', 'simple', 'sgm_uniform', 'karras', 'exponential', 'beta', 'zeta', 'linear_quadratic', 'kl_optimal'];
    const LORA_OPTIONS = [
      'Smooth_Booster_v3.safetensors',
      'Matte_Skin_Illustrious_v4.safetensors',
      'noobai_vp10_stabilizer_v0.280a_fp16.safetensors',
      'noobai_vpred_1_masterpieces.safetensors',
      'lolboja_v2.safetensors',
      'cunnyfunkystyle2.safetensors',
      'NoctFlatStyleNoobAIVpredV3.safetensors'
    ];
    const MAX_LORAS = 3;

    function genRandomSeed(){
      if(window.crypto && crypto.getRandomValues){
        const buf = new Uint32Array(1); crypto.getRandomValues(buf);
        return (buf[0] >>> 0) || 1;
      }
      return Math.floor(Math.random()*2147483647) + 1;
    }

    function populateSelect(sel, options, def){
      if(!sel) return;
      sel.innerHTML = options.map(o => `<option>${o}</option>`).join('');
      if(def) sel.value = def;
    }

    function formatDuration(ms){
      const minutes = Math.floor(ms / 60000);
      const seconds = Math.floor((ms % 60000) / 1000);
      const hundredths = Math.floor((ms % 1000) / 10);
      return `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}.${String(hundredths).padStart(2,'0')}`;
    }

    function makeTimer(el){
      let start = 0;
      let handle = null;
      function update(){
        if(!el) return;
        const diff = performance.now() - start;
        el.textContent = formatDuration(diff);
      }
      return {
        start(){
          start = performance.now();
          update();
          handle = setInterval(update, 30);
        },
        stop(){
          if(handle) clearInterval(handle);
          handle = null;
          update();
        }
      };
    }

    
      const qs = id => document.getElementById(id);
      const QWEN_SAMPLERS = ['euler', 'heunpp2', 'dpmpp_2m', 'dpmpp_sde', 'lcm'];
      const el = {
        apiKey: qs('apiKey'), checkpoint: qs('checkpoint'), prompt: qs('prompt'),
        rouweiWrap: qs('rouweiWrap'), rouweiPrefix: qs('rouweiPrefix'),
        width: qs('width'), height: qs('height'), seeleScaleWrap: qs('seeleScaleWrap'), seeleScale: qs('seeleScale'), seeleScaleHint: qs('seeleScaleHint'),
        batchSize: qs('batchSize'), batchSizeHint: qs('batchSizeHint'),
        useBakedVae: qs('useBakedVae'), vaeWrap: qs('vaeWrap'), vaeName: qs('vaeName'),
        lora1Enable: qs('lora1Enable'), lora1Name: qs('lora1Name'), lora1Strength: qs('lora1Strength'),
        lora2Enable: qs('lora2Enable'), lora2Name: qs('lora2Name'), lora2Strength: qs('lora2Strength'),
        lora3Enable: qs('lora3Enable'), lora3Name: qs('lora3Name'), lora3Strength: qs('lora3Strength'),
        enableMahiro: qs('enableMahiro'), enableEps: qs('enableEps'), epsilonFactor: qs('epsilonFactor'), epsilonWrap: qs('epsilonWrap'), enableApg: qs('enableApg'), enablePag: qs('enablePag'),
        zeroNegative: qs('zeroNegative'), negZeroRow: qs('negZeroRow'), negativePrompt: qs('negativePrompt'), negWrap: qs('negWrap'),
        seed: qs('seed'), seedHint: qs('seedHint'), steps: qs('steps'), cfg: qs('cfg'), cfgHint: qs('cfgHint'), sampler: qs('sampler'), scheduler: qs('scheduler'), denoise: qs('denoise'),
        enableFsampler: qs('enableFsampler'), fsamplerWrap: qs('fsamplerWrap'), skipMode: qs('skipMode'),
        hiresEnable: qs('hiresEnable'), hiresHint: qs('hiresHint'), hiresWrap: qs('hiresWrap'), hiresType: qs('hiresType'), hiresScale: qs('hiresScale'), hiresSteps: qs('hiresSteps'), hiresCfg: qs('hiresCfg'), hiresCfgHint: qs('hiresCfgHint'), hiresSampler: qs('hiresSampler'), hiresScheduler: qs('hiresScheduler'), hiresDenoise: qs('hiresDenoise'), hiresSeedCustom: qs('hiresSeedCustom'), hiresSeedWrap: qs('hiresSeedWrap'), hiresSeed: qs('hiresSeed'),
        usePersonDetailer: qs('usePersonDetailer'), detailer1Wrap: qs('detailer1Wrap'), detailer1Seed: qs('detailer1Seed'), detailer1Steps: qs('detailer1Steps'), detailer1Cfg: qs('detailer1Cfg'), detailer1CfgHint: qs('detailer1CfgHint'), detailer1Sampler: qs('detailer1Sampler'), detailer1Scheduler: qs('detailer1Scheduler'), detailer1Denoise: qs('detailer1Denoise'),
        useFaceDetailer: qs('useFaceDetailer'), detailer2Wrap: qs('detailer2Wrap'), detailer2Seed: qs('detailer2Seed'), detailer2Steps: qs('detailer2Steps'), detailer2Cfg: qs('detailer2Cfg'), detailer2CfgHint: qs('detailer2CfgHint'), detailer2Sampler: qs('detailer2Sampler'), detailer2Scheduler: qs('detailer2Scheduler'), detailer2Denoise: qs('detailer2Denoise'), facePrompt: qs('facePrompt'),
        hue: qs('hue'), saturation: qs('saturation'), light: qs('light'),
        useQwen: qs('useQwen'), qwenWrap: qs('qwenWrap'), qwenPrompt: qs('qwenPrompt'), qwenWidth: qs('qwenWidth'), qwenHeight: qs('qwenHeight'), qwenSeed: qs('qwenSeed'), qwenSampler: qs('qwenSampler'), qwenScheduler: qs('qwenScheduler'), qwen8Steps: qs('qwen8Steps'),
        removeBg: qs('removeBg'), birefnetModel: qs('birefnetModel'),
        runBtn: qs('runBtn'), curlBtn: qs('curlBtn'), resetBtn: qs('resetBtn'), clearBtn: qs('clearBtn'),
        status: qs('status'), timer: qs('timer'), gallery: qs('gallery'), debugReq: qs('debugReq'), debugResp: qs('debugResp'),
      };

      const timer = makeTimer(el.timer);
      const clampNumber = (value, min, max) => Math.min(max, Math.max(min, value));
      el.seedHintDefault = el.seedHint ? el.seedHint.textContent : '';

      function isRouweiSelected(){
        return !!(el.checkpoint && typeof el.checkpoint.value === 'string' && el.checkpoint.value.includes('rouwei'));
      }

      function isSeeleSelected(){
        return !!(el.checkpoint && el.checkpoint.value.toLowerCase().includes('seele'));
      }

      function isRfNoobSelected(){
        return !!(el.checkpoint && el.checkpoint.value.toLowerCase().includes('rectifiedflow'));
      }

      function isOneObsession(){
        return !!(el.checkpoint && el.checkpoint.value.toLowerCase().includes('oneobsession'));
      }

      function populateLoraSelect(sel){
        if(!sel) return;
        sel.innerHTML = LORA_OPTIONS.map(o => `<option>${o}</option>`).join('');
      }

      populateSelect(el.sampler, SAMPLERS, 'euler');
      populateSelect(el.scheduler, SCHEDULERS, 'normal');
      populateSelect(el.hiresSampler, SAMPLERS, 'euler');
      populateSelect(el.hiresScheduler, SCHEDULERS, 'normal');
      populateSelect(el.detailer1Sampler, SAMPLERS, 'euler');
      populateSelect(el.detailer1Scheduler, SCHEDULERS, 'normal');
      populateSelect(el.detailer2Sampler, SAMPLERS, 'euler');
      populateSelect(el.detailer2Scheduler, SCHEDULERS, 'normal');
      populateSelect(el.qwenSampler, QWEN_SAMPLERS, 'euler');
      populateSelect(el.qwenScheduler, SCHEDULERS, 'normal');
      [el.lora1Name, el.lora2Name, el.lora3Name].forEach(populateLoraSelect);

      function updateSeeleScaleVisibility(){
        const isSeele = isSeeleSelected();
        if(el.seeleScaleWrap) el.seeleScaleWrap.style.display = isSeele ? '' : 'none';
      }

      function updateRouweiState(){
        const rouwei = isRouweiSelected();
        if(el.rouweiWrap) el.rouweiWrap.style.display = rouwei ? '' : 'none';
        updateNegativeVisibility();
      }

      function updateNegativeVisibility(){
        const hideNeg = !!(el.zeroNegative && el.zeroNegative.checked);
        if(el.negWrap) el.negWrap.style.display = hideNeg ? 'none' : '';
      }

      function updateVaeState(){
        const rf = isRfNoobSelected();
        if(el.useBakedVae){
          if(rf){
            el.useBakedVae.checked = true;
            el.useBakedVae.disabled = true;
          } else {
            el.useBakedVae.disabled = false;
          }
        }
        if(el.vaeWrap) el.vaeWrap.style.display = el.useBakedVae && el.useBakedVae.checked ? 'none' : '';
      }

      function updateEpsilonVisibility(){
        if(!el.epsilonWrap) return;
        const show = isOneObsession();
        el.epsilonWrap.style.display = show ? '' : 'none';
        if(!show && el.enableEps) el.enableEps.checked = false;
      }

      function updateFsamplerVisibility(){
        if(!el.fsamplerWrap) return;
        const show = isOneObsession() && !(el.useQwen && el.useQwen.checked);
        el.fsamplerWrap.style.display = show ? '' : 'none';
        if(!show && el.enableFsampler) el.enableFsampler.checked = false;
      }

      function updateQwenVisibility(){
        if(!el.useQwen || !el.qwenWrap) return;
        el.qwenWrap.style.display = el.useQwen.checked ? '' : 'none';
        updateFsamplerVisibility();
      }

      function updateDetailerVisibility(){
        if(el.detailer1Wrap) el.detailer1Wrap.style.display = el.usePersonDetailer && el.usePersonDetailer.checked ? '' : 'none';
        if(el.detailer2Wrap) el.detailer2Wrap.style.display = el.useFaceDetailer && el.useFaceDetailer.checked ? '' : 'none';
      }

      function updateHiresVisibility(){
        const isSeele = isSeeleSelected();
        const scale = el.seeleScale ? parseFloat(el.seeleScale.value || '1') : 1;
        const w = clampNumber(parseInt(el.width?.value || '1024', 10) || 1024, 512, 2048);
        const h = clampNumber(parseInt(el.height?.value || '1024', 10) || 1024, 512, 2048);
        const scaledW = Math.round(w * (isSeele ? scale : 1));
        const scaledH = Math.round(h * (isSeele ? scale : 1));
        const overMegapixel = scaledW * scaledH > 1_250_000;
        const disable = (isSeele && scale > 1.25) || overMegapixel;
        if(el.hiresEnable){
          el.hiresEnable.disabled = disable;
          if(disable) el.hiresEnable.checked = false;
        }
        if(el.hiresWrap) el.hiresWrap.style.display = el.hiresEnable && el.hiresEnable.checked && !disable ? '' : 'none';
        if(el.hiresHint){
          el.hiresHint.textContent = disable ? 'HiresFix disabled for Seele scale or >1.25MP latents' : 'Enable HiresFix';
        }
        if(isSeele && el.seeleScaleHint){
          el.seeleScaleHint.textContent = `${scale.toFixed(2)}x (${scaledW}x${scaledH})`;
        }
      }

      function applyCfgRange(input, hint, sampler){
        if(!input) return;
        const samplerName = sampler || '';
        const rfBoost = isRfNoobSelected() ? 2.0 : 0;
        let min = 4.0, max = 8.0 + rfBoost, label = 'standard';
        if(samplerName.includes('cfg_pp')){
          min = 0.7; max = 2.0 + rfBoost; label = 'cfg_pp';
        } else if(samplerName.includes('dpm')){
          min = 1.3; max = 3.5 + rfBoost; label = 'DPM';
        }
        input.min = min; input.max = max; input.step = 0.1;
        let val = parseFloat(input.value || String((min+max)/2));
        if(!Number.isFinite(val)) val = (min+max)/2;
        val = clampNumber(val, min, max);
        input.value = val.toFixed(1);
        if(hint) hint.textContent = `Range ${min.toFixed(1)}–${max.toFixed(1)} (${label})`;
      }

      function updateCfgRanges(){
        applyCfgRange(el.cfg, el.cfgHint, el.sampler?.value);
        applyCfgRange(el.hiresCfg, el.hiresCfgHint, el.hiresSampler?.value);
        applyCfgRange(el.detailer1Cfg, el.detailer1CfgHint, el.detailer1Sampler?.value);
        applyCfgRange(el.detailer2Cfg, el.detailer2CfgHint, el.detailer2Sampler?.value);
      }

      function updateBatchSizeDisplay(){
        if(!el.batchSize) return 1;
        let raw = parseInt(el.batchSize.value || '1', 10);
        if(!Number.isFinite(raw)) raw = 1;
        raw = clampNumber(raw, 1, 4);
        el.batchSize.value = raw;
        if(el.batchSizeHint){
          el.batchSizeHint.textContent = `${raw} image${raw>1?'s':''} per run`;
        }
        return raw;
      }

      function clampStrength(v){
        let val = parseFloat(v);
        if(!Number.isFinite(val)) val = 0.6;
        return Math.min(1, Math.max(0, Math.round(val*100)/100));
      }

      function snapTo16(v){
        const val = Math.max(16, Math.floor(v));
        return val - (val % 16);
      }

      function resolveSeed(input, hint){
        let seed = parseInt((input && input.value) || '-1', 10);
        if(seed === -1){
          seed = genRandomSeed();
          if(hint) hint.textContent = `Random seed: ${seed}`;
        } else if(hint){
          hint.textContent = hint === el.seedHint ? el.seedHintDefault : hint.textContent;
        }
        return seed;
      }

      if(el.useQwen) el.useQwen.addEventListener('change', updateQwenVisibility);
      if(el.zeroNegative) el.zeroNegative.addEventListener('change', updateNegativeVisibility);
      if(el.checkpoint) el.checkpoint.addEventListener('change', () => { updateRouweiState(); updateSeeleScaleVisibility(); updateVaeState(); updateEpsilonVisibility(); updateFsamplerVisibility(); updateCfgRanges(); updateHiresVisibility(); });
      if(el.seeleScale) el.seeleScale.addEventListener('input', updateHiresVisibility);
      if(el.width) el.width.addEventListener('input', updateHiresVisibility);
      if(el.height) el.height.addEventListener('input', updateHiresVisibility);
      if(el.batchSize) el.batchSize.addEventListener('input', updateBatchSizeDisplay);
      if(el.useBakedVae) el.useBakedVae.addEventListener('change', updateVaeState);
      if(el.enableFsampler) el.enableFsampler.addEventListener('change', updateFsamplerVisibility);
      if(el.usePersonDetailer) el.usePersonDetailer.addEventListener('change', updateDetailerVisibility);
      if(el.useFaceDetailer) el.useFaceDetailer.addEventListener('change', updateDetailerVisibility);
      if(el.hiresEnable) el.hiresEnable.addEventListener('change', updateHiresVisibility);
      if(el.hiresSeedCustom) el.hiresSeedCustom.addEventListener('change', () => { if(el.hiresSeedWrap) el.hiresSeedWrap.style.display = el.hiresSeedCustom.checked ? '' : 'none'; });
      if(el.sampler) el.sampler.addEventListener('change', updateCfgRanges);
      if(el.hiresSampler) el.hiresSampler.addEventListener('change', updateCfgRanges);
      if(el.detailer1Sampler) el.detailer1Sampler.addEventListener('change', updateCfgRanges);
      if(el.detailer2Sampler) el.detailer2Sampler.addEventListener('change', updateCfgRanges);

      updateBatchSizeDisplay();
      updateRouweiState();
      updateSeeleScaleVisibility();
      updateNegativeVisibility();
      updateVaeState();
      updateEpsilonVisibility();
      updateFsamplerVisibility();
      updateQwenVisibility();
      updateDetailerVisibility();
      updateCfgRanges();
      updateHiresVisibility();

      function getWorkflowTemplate(){
        const raw = document.getElementById('workflow-template').textContent.trim();
        return JSON.parse(raw);
      }

      function deepReplacePlaceholders(obj, map){
        if (obj === null || obj === undefined) return obj;
        if (typeof obj === 'string'){
          const m = obj.match(/^%([a-zA-Z0-9_-]+)%$/);
          if (m){
            const key = m[1];
            if (!(key in map)) throw new Error(`Missing placeholder: ${key}`);
            return map[key];
          }
          return obj;
        } else if (Array.isArray(obj)){
          return obj.map(v => deepReplacePlaceholders(v, map));
        } else if (typeof obj === 'object'){
          const out = Array.isArray(obj) ? [] : {};
          for (const k of Object.keys(obj)) out[k] = deepReplacePlaceholders(obj[k], map);
          return out;
        }
        return obj;
      }

      function buildPlaceholderMap(){
        const isSeele = isSeeleSelected();
        const rfNoob = isRfNoobSelected();
        const scale = parseFloat(el.seeleScale?.value || '1');
        const baseW = clampNumber(parseInt(el.width?.value || '1024', 10) || 1024, 512, 2048);
        const baseH = clampNumber(parseInt(el.height?.value || '1024', 10) || 1024, 512, 2048);
        const finalW = Math.round(baseW * (isSeele ? scale : 1));
        const finalH = Math.round(baseH * (isSeele ? scale : 1));
        const seedVal = resolveSeed(el.seed, el.seedHint);
        const stepsVal = clampNumber(parseInt(el.steps?.value || '25', 10) || 25, 15, 35);
        const cfgVal = parseFloat(el.cfg?.value || '5.0');
        const hiresAllowed = !(isSeele && scale > 1.25) && finalW * finalH <= 1_250_000;
        const hiresEnabled = hiresAllowed && el.hiresEnable && el.hiresEnable.checked;
        const hiresSeed = (el.hiresSeedCustom && el.hiresSeedCustom.checked) ? resolveSeed(el.hiresSeed) : seedVal;
        const detailer1Seed = el.usePersonDetailer && el.usePersonDetailer.checked ? resolveSeed(el.detailer1Seed) : seedVal;
        const detailer2Seed = el.useFaceDetailer && el.useFaceDetailer.checked ? resolveSeed(el.detailer2Seed) : seedVal;
        const fsamplerActive = el.fsamplerWrap && el.fsamplerWrap.style.display !== 'none' ? !!(el.enableFsampler && el.enableFsampler.checked) : false;
        const loras = [
          { enable: !!(el.lora1Enable && el.lora1Enable.checked), name: el.lora1Name?.value || '', strength: clampStrength(el.lora1Strength?.value) },
          { enable: !!(el.lora2Enable && el.lora2Enable.checked), name: el.lora2Name?.value || '', strength: clampStrength(el.lora2Strength?.value) },
          { enable: !!(el.lora3Enable && el.lora3Enable.checked), name: el.lora3Name?.value || '', strength: clampStrength(el.lora3Strength?.value) },
        ];
        const useQwen = !!(el.useQwen && el.useQwen.checked);
        return {
          checkpoint_name: el.checkpoint?.value || '',
          prompt: el.prompt?.value || '',
          width: finalW,
          height: finalH,
          batch_size: updateBatchSizeDisplay(),
          rouwei_prefix: el.rouweiPrefix?.value || '',
          use_baked_vae: rfNoob ? true : !!(el.useBakedVae && el.useBakedVae.checked),
          vae_name: el.vaeName?.value || '',
          lora_1_enable: loras[0].enable,
          lora_1_name: loras[0].name,
          lora_1_strength: loras[0].strength,
          lora_2_enable: loras[1].enable,
          lora_2_name: loras[1].name,
          lora_2_strength: loras[1].strength,
          lora_3_enable: loras[2].enable,
          lora_3_name: loras[2].name,
          lora_3_strength: loras[2].strength,
          enable_mahiro: !!(el.enableMahiro && el.enableMahiro.checked),
          enable_epsilon_scaling: isOneObsession() ? !!(el.enableEps && el.enableEps.checked) : false,
          epsilon_scaling_factor: parseFloat(el.epsilonFactor?.value || '1.005'),
          enable_apg: !!(el.enableApg && el.enableApg.checked),
          enable_pag: !!(el.enablePag && el.enablePag.checked),
          zero_out_negative: !!(el.zeroNegative && el.zeroNegative.checked),
          negative_prompt: (!!(el.zeroNegative && el.zeroNegative.checked)) ? '' : (el.negativePrompt?.value || ''),
          seed: seedVal,
          steps: stepsVal,
          cfg: parseFloat(cfgVal.toFixed(1)),
          sampler: el.sampler?.value || '',
          fsampler_sampler: fsamplerActive ? (el.sampler?.value || 'euler') : 'euler',
          scheduler: el.scheduler?.value || '',
          denoise: clampNumber(parseFloat(el.denoise?.value || '1'), 0, 1),
          enable_fsampler: fsamplerActive,
          skip_mode: el.skipMode?.value || 'h2/s4',
          hiresfix_enable: hiresEnabled,
          hiresfix_type: !!(el.hiresType && el.hiresType.checked),
          hiresfix_upscale_by: clampNumber(parseFloat(el.hiresScale?.value || '1.5'), 1, 2),
          hiresfix_seed: hiresSeed,
          hiresfix_steps: clampNumber(parseInt(el.hiresSteps?.value || '15', 10) || 15, 10, 20),
          hiresfix_cfg: parseFloat(parseFloat(el.hiresCfg?.value || '5.0').toFixed(1)),
          hiresfix_sampler: el.hiresSampler?.value || '',
          hiresfix_scheduler: el.hiresScheduler?.value || '',
          hiresfix_denoise: clampNumber(parseFloat(el.hiresDenoise?.value || '0.56'), 0, 1),
          use_person_detailer: !!(el.usePersonDetailer && el.usePersonDetailer.checked),
          use_face_detailer: !!(el.useFaceDetailer && el.useFaceDetailer.checked),
          detailer_1_seed: detailer1Seed,
          detailer_1_steps: clampNumber(parseInt(el.detailer1Steps?.value || '20', 10) || 20, 10, 30),
          detailer_1_cfg: parseFloat(parseFloat(el.detailer1Cfg?.value || '5.0').toFixed(1)),
          detailer_1_sampler: el.detailer1Sampler?.value || '',
          detailer_1_scheduler: el.detailer1Scheduler?.value || '',
          detailer_1_denoise: clampNumber(parseFloat(el.detailer1Denoise?.value || '0.5'), 0, 1),
          detailer_2_seed: detailer2Seed,
          detailer_2_steps: clampNumber(parseInt(el.detailer2Steps?.value || '20', 10) || 20, 10, 30),
          detailer_2_cfg: parseFloat(parseFloat(el.detailer2Cfg?.value || '5.0').toFixed(1)),
          detailer_2_sampler: el.detailer2Sampler?.value || '',
          detailer_2_scheduler: el.detailer2Scheduler?.value || '',
          detailer_2_denoise: clampNumber(parseFloat(el.detailer2Denoise?.value || '0.5'), 0, 1),
          face_prompt: el.useFaceDetailer && el.useFaceDetailer.checked ? (el.facePrompt?.value || el.prompt?.value || '') : '',
          hue: parseInt(el.hue?.value || '0', 10),
          saturation: parseInt(el.saturation?.value || '0', 10),
          light: parseInt(el.light?.value || '0', 10),
          use_qwen_img2img: useQwen,
          qwen_prompt: el.qwenPrompt?.value || '',
          qwen_width: snapTo16(clampNumber(parseInt(el.qwenWidth?.value || '1024', 10) || 1024, 64, 2048)),
          qwen_height: snapTo16(clampNumber(parseInt(el.qwenHeight?.value || '1024', 10) || 1024, 64, 2048)),
          qwen_seed: useQwen ? resolveSeed(el.qwenSeed) : seedVal,
          qwen_sampler: el.qwenSampler?.value || '',
          qwen_scheduler: el.qwenScheduler?.value || '',
          qwen_use_8_steps: !!(el.qwen8Steps && el.qwen8Steps.checked),
          remove_bg: !!(el.removeBg && el.removeBg.checked),
          birefnet_model: el.birefnetModel?.value || '',
        };
      }

      function buildPayload(){
        const template = getWorkflowTemplate();
        const map = buildPlaceholderMap();
        const resolved = deepReplacePlaceholders(template, map);
        return { input: { workflow: resolved } };
      }

      function makeCurl(payload){
        const key = el.apiKey.value.trim() || '<api_key>';
        return [
          'curl -sX POST',
          `  -H "Authorization: Bearer ${key}"`,
          '  -H "Content-Type: application/json"',
          `  -d '${JSON.stringify(payload)}'`,
          `  ${ENDPOINT}`
        ].join(' \\\n');
      }

      async function pollStatus(key, id, debugEl, statusEndpoint = STATUS_ENDPOINT){
        let attempt = 0;
        while(true){
          attempt++;
          const resp = await fetch(`${statusEndpoint}/${id}`, {
            headers: { 'Authorization': `Bearer ${key}` }
          });
          const data = await resp.json();
          if(debugEl) debugEl.textContent = JSON.stringify(data, null, 2);
          if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
          if(data.status === 'COMPLETED') return data;
          if(data.status === 'FAILED' || data.status === 'CANCELLED') throw new Error(`Job status: ${data.status}`);
          const delay = Number(data.delayTime) || Math.min(1000 * attempt, 5000);
          await new Promise(r => setTimeout(r, delay));
        }
      }

      function setBusy(b){
        el.runBtn.disabled = b;
        el.status.textContent = b? 'Running…' : 'Idle';
        if(el.timer){ b ? timer.start() : timer.stop(); }
      }

      if(el.resetBtn) el.resetBtn.addEventListener('click', () => {
        if(el.prompt) el.prompt.value = '';
        if(el.negativePrompt) el.negativePrompt.value = '';
        if(el.zeroNegative) el.zeroNegative.checked = false;
        if(el.rouweiPrefix) el.rouweiPrefix.value = '';
        if(el.width) el.width.value = 1024;
        if(el.height) el.height.value = 1024;
        if(el.seeleScale) el.seeleScale.value = 1.0;
        updateBatchSizeDisplay();
        if(el.useBakedVae){ el.useBakedVae.checked = true; el.useBakedVae.disabled = isRfNoobSelected(); }
        if(el.vaeName) el.vaeName.value = 'sdxl-vae-anime-alpha-67500.safetensors';
        if(el.lora1Enable) el.lora1Enable.checked = false;
        if(el.lora2Enable) el.lora2Enable.checked = false;
        if(el.lora3Enable) el.lora3Enable.checked = false;
        if(el.lora1Strength) el.lora1Strength.value = 0.60;
        if(el.lora2Strength) el.lora2Strength.value = 0.60;
        if(el.lora3Strength) el.lora3Strength.value = 0.60;
        if(el.enableMahiro) el.enableMahiro.checked = true;
        if(el.enableApg) el.enableApg.checked = true;
        if(el.enablePag) el.enablePag.checked = false;
        if(el.enableEps) el.enableEps.checked = false;
        if(el.epsilonFactor) el.epsilonFactor.value = 1.005;
        if(el.seed){ el.seed.value = -1; if(el.seedHint) el.seedHint.textContent = el.seedHintDefault; }
        if(el.steps) el.steps.value = 25;
        if(el.cfg) el.cfg.value = 5.0;
        if(el.sampler) el.sampler.value = 'euler';
        if(el.scheduler) el.scheduler.value = 'normal';
        if(el.denoise) el.denoise.value = 1.0;
        if(el.enableFsampler) el.enableFsampler.checked = false;
        if(el.skipMode) el.skipMode.value = 'h2/s4';
        if(el.hiresEnable) el.hiresEnable.checked = false;
        if(el.hiresType) el.hiresType.checked = false;
        if(el.hiresScale) el.hiresScale.value = 1.50;
        if(el.hiresSteps) el.hiresSteps.value = 15;
        if(el.hiresCfg) el.hiresCfg.value = 5.0;
        if(el.hiresSampler) el.hiresSampler.value = 'euler';
        if(el.hiresScheduler) el.hiresScheduler.value = 'normal';
        if(el.hiresDenoise) el.hiresDenoise.value = 0.56;
        if(el.hiresSeedCustom) el.hiresSeedCustom.checked = false;
        if(el.hiresSeedWrap) el.hiresSeedWrap.style.display = 'none';
        if(el.hiresSeed) el.hiresSeed.value = -1;
        if(el.usePersonDetailer) el.usePersonDetailer.checked = false;
        if(el.useFaceDetailer) el.useFaceDetailer.checked = false;
        if(el.detailer1Seed) el.detailer1Seed.value = -1;
        if(el.detailer2Seed) el.detailer2Seed.value = -1;
        if(el.detailer1Steps) el.detailer1Steps.value = 20;
        if(el.detailer2Steps) el.detailer2Steps.value = 20;
        if(el.detailer1Cfg) el.detailer1Cfg.value = 5.0;
        if(el.detailer2Cfg) el.detailer2Cfg.value = 5.0;
        if(el.detailer1Sampler) el.detailer1Sampler.value = 'euler';
        if(el.detailer2Sampler) el.detailer2Sampler.value = 'euler';
        if(el.detailer1Scheduler) el.detailer1Scheduler.value = 'normal';
        if(el.detailer2Scheduler) el.detailer2Scheduler.value = 'normal';
        if(el.detailer1Denoise) el.detailer1Denoise.value = 0.5;
        if(el.detailer2Denoise) el.detailer2Denoise.value = 0.5;
        if(el.facePrompt) el.facePrompt.value = '';
        if(el.hue) el.hue.value = 0;
        if(el.saturation) el.saturation.value = 0;
        if(el.light) el.light.value = 0;
        if(el.useQwen) el.useQwen.checked = false;
        if(el.qwenPrompt) el.qwenPrompt.value = '';
        if(el.qwenWidth) el.qwenWidth.value = 1024;
        if(el.qwenHeight) el.qwenHeight.value = 1024;
        if(el.qwenSeed) el.qwenSeed.value = -1;
        if(el.qwenSampler) el.qwenSampler.value = 'euler';
        if(el.qwenScheduler) el.qwenScheduler.value = 'normal';
        if(el.qwen8Steps) el.qwen8Steps.checked = true;
        if(el.removeBg) el.removeBg.checked = false;
        if(el.birefnetModel) el.birefnetModel.value = 'BiRefNet_toonout';
        updateSeeleScaleVisibility();
        updateRouweiState();
        updateNegativeVisibility();
        updateVaeState();
        updateEpsilonVisibility();
        updateFsamplerVisibility();
        updateQwenVisibility();
        updateDetailerVisibility();
        updateCfgRanges();
        updateHiresVisibility();
        el.status.textContent = 'Reset to defaults';
      });

      el.clearBtn.addEventListener('click', () => { el.gallery.innerHTML = ''; el.status.textContent = 'Gallery cleared'; });

      async function run(){
        const key = el.apiKey.value.trim();
        if (!key){ el.status.textContent = 'API key required'; return; }
        if(isRouweiSelected() && (!el.rouweiPrefix || !el.rouweiPrefix.value.trim())){
          el.status.innerHTML = '<span class="error">Rouwei prefix required when using rouwei_v080Vpred.safetensors</span>';
          return;
        }
        try{
          setBusy(true);
          const payload = buildPayload();
          el.debugReq.textContent = JSON.stringify(payload, null, 2);
          const resp = await fetch(ENDPOINT, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${key}`, 'Content-Type':'application/json' },
            body: JSON.stringify(payload)
          });
          let data = await resp.json();

          if (el.debugResp) el.debugResp.textContent = JSON.stringify(data, null, 2);

          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          if (data.status !== 'COMPLETED'){
            if(data.id){
              el.status.textContent = 'Waiting for job...';
              data = await pollStatus(key, data.id, el.debugResp);
            } else {
              throw new Error(`Job status: ${data.status}`);
            }
          }
          if (!data.output || !Array.isArray(data.output.images) || data.output.images.length === 0) throw new Error('No images in response');

          for (const item of data.output.images){
            if (item.type === 'base64' && item.data){
              const imgUrl = `data:image/avif;base64,${item.data}`;
              addShot(imgUrl, item.filename || 'image.avif');
            } else if (item.type === 's3_url' && item.data){
              addShot(item.data, item.filename || 'image.avif');
            }
          }
          el.status.textContent = `Completed in ${data.executionTime ?? '?'} ms`;
        } catch(err){
          console.error(err);
          el.status.innerHTML = `<span class="error">Error: ${err.message}</span>`;
        } finally{ setBusy(false); }
      }

      function addShot(url, name){
        const wrap = document.createElement('div');
        wrap.className = 'shot';
        const header = document.createElement('div'); header.className = 'header';
        header.innerHTML = `<header><span class="mono" title="${name}">${name}</span><a class="btn" href="${url}" download>Download</a></header>`;
        wrap.appendChild(header);
        const img = new Image(); img.loading = 'lazy'; img.src = url; img.addEventListener('click', ()=>openLightbox(url)); wrap.appendChild(img);
        el.gallery.prepend(wrap);
      }

      el.runBtn.addEventListener('click', (e)=>{ e.preventDefault(); run(); });

      el.curlBtn.addEventListener('click', ()=>{
        const payload = buildPayload();
        const text = makeCurl(payload);
        navigator.clipboard.writeText(text).then(()=>{ el.status.textContent = 'cURL copied'; });
      });

      function getAceTemplate(){
        const el = document.getElementById('ace-template');
        if(!el) throw new Error('ACE template missing');
        return JSON.parse(el.textContent.trim());
      }

// --- Regional Prompter helpers ---
    const rp = {
      apiKey: document.getElementById('apiKey'),
      model: document.getElementById('rp-model'),
      globalPrompt: document.getElementById('rp-globalPrompt'),
      negZero: document.getElementById('rp-negZero'),
      negZeroRow: document.getElementById('rp-negZeroRow'),
      negWrap: document.getElementById('rp-negWrap'),
      negative: document.getElementById('rp-negative'),
      rouweiWrap: document.getElementById('rp-rouweiWrap'),
      rouweiPrefix: document.getElementById('rp-rouweiPrefix'),
      dims: document.getElementById('rp-dims'),
      customDimsWrap: document.getElementById('rp-customDimsWrap'),
      customWidth: document.getElementById('rp-customWidth'),
      customHeight: document.getElementById('rp-customHeight'),
      batchSize: document.getElementById('rp-batchSize'),
      batchSizeHint: document.getElementById('rp-batchSizeHint'),
      rmbg: document.getElementById('rp-rmbg'),
      apgToggle: document.getElementById('rp-apgToggle'),
      globalWeight: document.getElementById('rp-globalWeight'),
      maskEditor: document.getElementById('rp-maskEditor'),
      maskInner: null,
      regionList: document.getElementById('rp-regionList'),
      addRegion: document.getElementById('rp-addRegion'),
      seed: document.getElementById('rp-seed'),
      seedHint: document.getElementById('rp-seedHint'),
      steps: document.getElementById('rp-steps'),
      cfg: document.getElementById('rp-cfg'),
      cfgHint: document.getElementById('rp-cfgHint'),
      sampler: document.getElementById('rp-sampler'),
      scheduler: document.getElementById('rp-scheduler'),
      hiresToggle: document.getElementById('rp-hiresToggle'),
      hiresWrap: document.getElementById('rp-hiresWrap'),
      hiresScale: document.getElementById('rp-hiresScale'),
      hiresSteps: document.getElementById('rp-hiresSteps'),
      hiresCfg: document.getElementById('rp-hiresCfg'),
      hiresCfgHint: document.getElementById('rp-hiresCfgHint'),
      hiresDenoise: document.getElementById('rp-hiresDenoise'),
      hiresSampler: document.getElementById('rp-hiresSampler'),
      hiresScheduler: document.getElementById('rp-hiresScheduler'),
      hiresSeedCustom: document.getElementById('rp-hiresSeedCustom'),
      hiresSeedWrap: document.getElementById('rp-hiresSeedWrap'),
      hiresSeed: document.getElementById('rp-hiresSeed'),
      runBtn: document.getElementById('rp-runBtn'),
      curlBtn: document.getElementById('rp-curlBtn'),
      resetBtn: document.getElementById('rp-resetBtn'),
      clearBtn: document.getElementById('rp-clearBtn'),
      status: document.getElementById('rp-status'),
      timer: document.getElementById('rp-timer'),
      gallery: document.getElementById('rp-gallery'),
      debugReq: document.getElementById('rp-debugReq'),
      debugResp: document.getElementById('rp-debugResp'),
    };
    if (rp.maskEditor) rp.maskInner = rp.maskEditor.querySelector('.mask-editor-inner');
    rp.seedHintDefault = rp.seedHint ? rp.seedHint.textContent : '';
    const rpTimer = makeTimer(rp.timer);

    const REGION_META = [
      { id: 1, name: 'Region 1', color: '#ff4d4d', fill: 'rgba(255,77,77,0.28)' },
      { id: 2, name: 'Region 2', color: '#4d7bff', fill: 'rgba(77,123,255,0.28)' },
      { id: 3, name: 'Region 3', color: '#4dff7b', fill: 'rgba(77,255,123,0.28)' },
      { id: 4, name: 'Region 4', color: '#ffd84d', fill: 'rgba(255,216,77,0.32)' },
    ];

    const rpRegions = REGION_META.map(meta => ({
      id: meta.id,
      meta,
      active: meta.id <= 2,
      enabled: meta.id <= 2,
      prompt: '',
      mask: { x: 0, y: 0, width: 1, height: 1 },
    }));

    let rpSelectedRegionId = 1;
    let rpImageWidth = 1024;
    let rpImageHeight = 1024;
    let rpLastPresetDims = '1024x1024';
    let rpCustomDimsDirty = false;
    let rpEditorRect = { width: 1, height: 1 };
    let rpPendingPositionUpdate = false;
    const rpRegionElements = new Map();
    const rpRegionForms = new Map();
    let rpDragState = null;

    function rpIsRouweiSelected(){
      return !!(rp.model && rp.model.value && rp.model.value.includes('rouwei'));
    }

    function updateRpRouweiState(){
      const isRouwei = rpIsRouweiSelected();
      if (rp.rouweiWrap) rp.rouweiWrap.style.display = isRouwei ? '' : 'none';
      if (rp.negZero){
        if (isRouwei){
          rp.negZero.checked = false;
          rp.negZero.disabled = true;
        } else {
          rp.negZero.disabled = false;
        }
      }
      updateRpNegativeVisibility();
    }

    function updateRpNegativeVisibility(){
      if (!rp.negWrap) return;
      const show = !rpIsRouweiSelected() && !(rp.negZero && rp.negZero.checked);
      rp.negWrap.style.display = show ? '' : 'none';
    }

    function updateRpBatchSizeDisplay(){
      if (!rp.batchSize) return 1;
      let raw = parseInt(rp.batchSize.value || '1', 10);
      if (!Number.isFinite(raw)) raw = 1;
      raw = clampNumber(raw, 1, 4);
      rp.batchSize.value = raw;
      if (rp.batchSizeHint){
        rp.batchSizeHint.textContent = `${raw} image${raw === 1 ? '' : 's'} per run`;
      }
      return raw;
    }

    function updateRpCustomDimsVisibility(){
      if (!rp.customDimsWrap || !rp.dims) return;
      const isCustom = rp.dims.value === 'custom';
      rp.customDimsWrap.style.display = isCustom ? '' : 'none';
    }

    function defaultRegionMask(meta){
      const halfW = Math.max(1, Math.round(rpImageWidth / 2));
      const halfH = Math.max(1, Math.round(rpImageHeight / 2));
      if (meta.id === 1) return { x: 0, y: 0, width: halfW, height: halfH };
      if (meta.id === 2) return { x: Math.max(rpImageWidth - halfW, 0), y: 0, width: halfW, height: halfH };
      if (meta.id === 3) return { x: 0, y: Math.max(rpImageHeight - halfH, 0), width: halfW, height: halfH };
      if (meta.id === 4) return { x: Math.max(rpImageWidth - halfW, 0), y: Math.max(rpImageHeight - halfH, 0), width: halfW, height: halfH };
      return { x: 0, y: 0, width: halfW, height: halfH };
    }

    function clampRegionRect(rect){
      let { x, y, width, height } = rect || {};
      const maxW = Math.max(rpImageWidth, 1);
      const maxH = Math.max(rpImageHeight, 1);
      if (!Number.isFinite(x)) x = 0;
      if (!Number.isFinite(y)) y = 0;
      if (!Number.isFinite(width)) width = maxW;
      if (!Number.isFinite(height)) height = maxH;
      x = Math.round(x);
      y = Math.round(y);
      width = Math.round(width);
      height = Math.round(height);
      if (width < 1) width = 1;
      if (height < 1) height = 1;
      if (x < 0){
        width += x;
        x = 0;
      }
      if (y < 0){
        height += y;
        y = 0;
      }
      if (width < 1) width = 1;
      if (height < 1) height = 1;
      if (width > maxW) width = maxW;
      if (height > maxH) height = maxH;
      if (x > maxW - 1) x = maxW - 1;
      if (y > maxH - 1) y = maxH - 1;
      if (x + width > maxW) x = maxW - width;
      if (y + height > maxH) y = maxH - height;
      x = clampNumber(x, 0, Math.max(maxW - 1, 0));
      y = clampNumber(y, 0, Math.max(maxH - 1, 0));
      width = clampNumber(width, 1, maxW);
      height = clampNumber(height, 1, maxH);
      return { x, y, width, height };
    }

    function rectanglesOverlap(a, b){
      return a.x < b.x + b.width && a.x + a.width > b.x && a.y < b.y + b.height && a.y + a.height > b.y;
    }

    function hasRegionOverlap(rect, ignore){
      for (const region of rpRegions){
        if (!region.active) continue;
        if (ignore && region.id === ignore.id) continue;
        if (rectanglesOverlap(rect, region.mask)) return true;
      }
      return false;
    }

    function ensureRpDimensions(){
      let width = 1024;
      let height = 1024;
      if (rp.dims){
        if (rp.dims.value === 'custom'){
          const customW = parseInt(rp.customWidth && rp.customWidth.value || '1024', 10);
          const customH = parseInt(rp.customHeight && rp.customHeight.value || '1024', 10);
          if (Number.isFinite(customW)) width = clampNumber(customW, 512, 2048);
          if (Number.isFinite(customH)) height = clampNumber(customH, 512, 2048);
        } else if (rp.dims.value){
          const parts = rp.dims.value.split('x');
          const parsedW = parseInt(parts[0], 10);
          const parsedH = parseInt(parts[1], 10);
          if (!Number.isNaN(parsedW)) width = parsedW;
          if (!Number.isNaN(parsedH)) height = parsedH;
        }
      }
      width = clampNumber(width, 512, 2048);
      height = clampNumber(height, 512, 2048);
      const prevWidth = rpImageWidth;
      const prevHeight = rpImageHeight;
      rpImageWidth = width;
      rpImageHeight = height;
      if (prevWidth !== width || prevHeight !== height){
        rescaleRpRegions(prevWidth, prevHeight);
        updateMaskEditorSize();
        renderRegionalUi();
      } else {
        updateMaskEditorSize();
      }
    }

    function rescaleRpRegions(prevWidth, prevHeight){
      if (!prevWidth || !prevHeight){
        rpRegions.forEach(region => {
          region.mask = clampRegionRect(defaultRegionMask(region.meta));
        });
        return;
      }
      const scaleX = rpImageWidth / prevWidth;
      const scaleY = rpImageHeight / prevHeight;
      rpRegions.forEach(region => {
        if (region.active){
          region.mask = clampRegionRect({
            x: Math.round(region.mask.x * scaleX),
            y: Math.round(region.mask.y * scaleY),
            width: Math.round(region.mask.width * scaleX),
            height: Math.round(region.mask.height * scaleY),
          });
        } else {
          region.mask = clampRegionRect(defaultRegionMask(region.meta));
        }
      });
    }

    function resetRpRegions(){
      rpRegions.forEach(region => {
        region.active = region.meta.id <= 2;
        region.enabled = region.meta.id <= 2;
        region.prompt = '';
        region.mask = clampRegionRect(defaultRegionMask(region.meta));
      });
      rpSelectedRegionId = 1;
    }

    function findAvailableRect(meta){
      let candidate = clampRegionRect(defaultRegionMask(meta));
      if (!hasRegionOverlap(candidate)) return candidate;
      const step = Math.max(1, Math.round(Math.min(rpImageWidth, rpImageHeight) / 6));
      for (let size = 1; size >= 0.4; size -= 0.1){
        const width = clampNumber(Math.round(candidate.width * size), 1, rpImageWidth);
        const height = clampNumber(Math.round(candidate.height * size), 1, rpImageHeight);
        for (let y = 0; y <= rpImageHeight - height; y += step){
          for (let x = 0; x <= rpImageWidth - width; x += step){
            const testRect = clampRegionRect({ x, y, width, height });
            if (!hasRegionOverlap(testRect)) return testRect;
          }
        }
      }
      for (let y = 0; y < rpImageHeight; y++){
        for (let x = 0; x < rpImageWidth; x++){
          const testRect = clampRegionRect({ x, y, width: 1, height: 1 });
          if (!hasRegionOverlap(testRect)) return testRect;
        }
      }
      return null;
    }

    function updateMaskEditorSize(){
      if (!rp.maskEditor) return;
      rp.maskEditor.style.setProperty('--editor-width', String(Math.max(rpImageWidth, 1)));
      rp.maskEditor.style.setProperty('--editor-height', String(Math.max(rpImageHeight, 1)));
      queueRegionPositionUpdate();
    }

    function renderRegionMaskLayer(){
      if (!rp.maskInner) return;
      const activeIds = new Set();
      for (const region of rpRegions){
        if (!region.active) continue;
        activeIds.add(region.id);
        ensureRegionElement(region);
        updateRegionElementAppearance(region);
      }
      for (const [id, el] of rpRegionElements){
        if (!activeIds.has(id)){
          el.remove();
          rpRegionElements.delete(id);
        }
      }
    }

    function ensureRegionElement(region){
      if (!rp.maskInner) return null;
      let el = rpRegionElements.get(region.id);
      if (!el){
        el = document.createElement('div');
        el.className = 'mask-region';
        el.dataset.region = String(region.id);
        el.style.backgroundColor = region.meta.fill;
        el.style.borderColor = region.meta.color;
        el.addEventListener('pointerdown', ev => startRegionDrag(region, 'move', null, ev));
        ['nw', 'ne', 'sw', 'se'].forEach(handle => {
          const h = document.createElement('div');
          h.className = 'mask-handle';
          h.dataset.handle = handle;
          h.addEventListener('pointerdown', ev => {
            ev.stopPropagation();
            startRegionDrag(region, 'resize', handle, ev);
          });
          el.appendChild(h);
        });
        rp.maskInner.appendChild(el);
        rpRegionElements.set(region.id, el);
      }
      return el;
    }

    function startRegionDrag(region, mode, handle, event){
      if (!rp.maskInner) return;
      event.preventDefault();
      selectRegion(region.id);
      rpDragState = {
        region,
        mode,
        handle,
        startRect: { ...region.mask },
        startClientX: event.clientX,
        startClientY: event.clientY,
        captureTarget: event.currentTarget,
      };
      if (event.currentTarget && event.currentTarget.setPointerCapture){
        try{ event.currentTarget.setPointerCapture(event.pointerId); } catch(err){}
      }
      window.addEventListener('pointermove', onRegionPointerMove);
      window.addEventListener('pointerup', endRegionDrag, { once: true });
    }

    function onRegionPointerMove(event){
      if (!rpDragState) return;
      const scale = getEditorScale();
      if (!Number.isFinite(scale.x) || !Number.isFinite(scale.y) || scale.x === 0 || scale.y === 0) return;
      const dx = Math.round((event.clientX - rpDragState.startClientX) / scale.x);
      const dy = Math.round((event.clientY - rpDragState.startClientY) / scale.y);
      const region = rpDragState.region;
      if (!region) return;
      const next = { ...rpDragState.startRect };
      if (rpDragState.mode === 'move'){
        next.x = rpDragState.startRect.x + dx;
        next.y = rpDragState.startRect.y + dy;
      } else {
        switch (rpDragState.handle){
          case 'nw':
            next.x = rpDragState.startRect.x + dx;
            next.y = rpDragState.startRect.y + dy;
            next.width = rpDragState.startRect.width - dx;
            next.height = rpDragState.startRect.height - dy;
            break;
          case 'ne':
            next.y = rpDragState.startRect.y + dy;
            next.width = rpDragState.startRect.width + dx;
            next.height = rpDragState.startRect.height - dy;
            break;
          case 'sw':
            next.x = rpDragState.startRect.x + dx;
            next.width = rpDragState.startRect.width - dx;
            next.height = rpDragState.startRect.height + dy;
            break;
          case 'se':
          default:
            next.width = rpDragState.startRect.width + dx;
            next.height = rpDragState.startRect.height + dy;
            break;
        }
      }
      if (applyRegionRect(region, next)){
        queueRegionPositionUpdate();
      }
    }

    function endRegionDrag(event){
      window.removeEventListener('pointermove', onRegionPointerMove);
      if (rpDragState && rpDragState.captureTarget && rpDragState.captureTarget.releasePointerCapture){
        try{ rpDragState.captureTarget.releasePointerCapture(event.pointerId); } catch(err){}
      }
      const region = rpDragState ? rpDragState.region : null;
      rpDragState = null;
      if (region){
        updateRegionInputs(region);
        queueRegionPositionUpdate();
      }
    }

    function getEditorScale(){
      const width = Math.max(rpImageWidth, 1);
      const height = Math.max(rpImageHeight, 1);
      const fallbackW = rp.maskEditor ? rp.maskEditor.clientWidth : 1;
      const fallbackH = rp.maskEditor ? rp.maskEditor.clientHeight : 1;
      const w = rpEditorRect.width || fallbackW || 1;
      const h = rpEditorRect.height || fallbackH || 1;
      return { x: w / width, y: h / height };
    }

    function refreshEditorRect(){
      if (!rp.maskInner) return;
      const rect = rp.maskInner.getBoundingClientRect();
      if (rect.width > 0 && rect.height > 0){
        rpEditorRect = { width: rect.width, height: rect.height };
      }
    }

    function updateRegionElementAppearance(region){
      const el = rpRegionElements.get(region.id);
      if (!el) return;
      const scale = getEditorScale();
      if (!Number.isFinite(scale.x) || !Number.isFinite(scale.y) || scale.x === 0 || scale.y === 0) return;
      el.style.left = `${region.mask.x * scale.x}px`;
      el.style.top = `${region.mask.y * scale.y}px`;
      el.style.width = `${Math.max(region.mask.width * scale.x, 4)}px`;
      el.style.height = `${Math.max(region.mask.height * scale.y, 4)}px`;
      el.classList.toggle('disabled', !region.enabled);
      el.classList.toggle('selected', region.id === rpSelectedRegionId);
    }

    function updateAllRegionPositions(){
      refreshEditorRect();
      for (const region of rpRegions){
        if (!region.active) continue;
        updateRegionElementAppearance(region);
      }
    }

    function queueRegionPositionUpdate(){
      if (rpPendingPositionUpdate) return;
      rpPendingPositionUpdate = true;
      requestAnimationFrame(() => {
        rpPendingPositionUpdate = false;
        updateAllRegionPositions();
      });
    }

    function selectRegion(id){
      const region = rpRegions.find(r => r.id === id && r.active);
      if (!region) return;
      rpSelectedRegionId = id;
      updateAllRegionPositions();
      rpRegionForms.forEach((form, regionId) => {
        if (!form.entry) return;
        form.entry.classList.toggle('selected', regionId === id);
      });
    }

    function updateRegionFormBounds(){
      rpRegionForms.forEach(form => {
        if (!form.inputs) return;
        if (form.inputs.x) form.inputs.x.max = Math.max(rpImageWidth - 1, 0);
        if (form.inputs.y) form.inputs.y.max = Math.max(rpImageHeight - 1, 0);
        if (form.inputs.width) form.inputs.width.max = Math.max(rpImageWidth, 1);
        if (form.inputs.height) form.inputs.height.max = Math.max(rpImageHeight, 1);
      });
    }

    function updateRegionInputs(region){
      const form = rpRegionForms.get(region.id);
      if (!form || !form.inputs) return;
      form.inputs.x.value = region.mask.x;
      form.inputs.y.value = region.mask.y;
      form.inputs.width.value = region.mask.width;
      form.inputs.height.value = region.mask.height;
      updateRegionEntryState(region);
    }

    function updateRegionEntryState(region){
      const form = rpRegionForms.get(region.id);
      if (!form) return;
      if (form.entry) form.entry.classList.toggle('disabled', !region.enabled);
      if (form.entry) form.entry.classList.toggle('selected', region.id === rpSelectedRegionId);
      if (form.toggle) form.toggle.checked = !!region.enabled;
    }

    function renderRegionList(){
      if (!rp.regionList) return;
      rp.regionList.innerHTML = '';
      rpRegionForms.clear();
      for (const region of rpRegions){
        if (!region.active) continue;
        const entry = document.createElement('div');
        entry.className = 'region-entry';
        entry.dataset.region = String(region.id);
        const top = document.createElement('div');
        top.className = 'region-entry-top';
        const chip = document.createElement('div');
        chip.className = 'region-chip';
        chip.innerHTML = `<span class="swatch" style="background:${region.meta.color}"></span>${region.meta.name}`;
        top.appendChild(chip);
        let toggleInput = null;
        if (region.id > 1){
          const removeBtn = document.createElement('button');
          removeBtn.className = 'region-remove';
          removeBtn.type = 'button';
          removeBtn.innerHTML = '&times;';
          removeBtn.addEventListener('click', ev => {
            ev.preventDefault();
            ev.stopPropagation();
            removeRegion(region.id);
          });
          top.appendChild(removeBtn);
        }
        entry.appendChild(top);
        if (region.id > 1){
          const toggleWrap = document.createElement('div');
          toggleWrap.style.display = 'flex';
          toggleWrap.style.alignItems = 'center';
          toggleWrap.style.justifyContent = 'space-between';
          toggleWrap.style.marginTop = '8px';
          const toggleLabel = document.createElement('label');
          toggleLabel.className = 'switch';
          toggleInput = document.createElement('input');
          toggleInput.type = 'checkbox';
          toggleInput.checked = !!region.enabled;
          toggleLabel.appendChild(toggleInput);
          const track = document.createElement('span');
          track.className = 'track';
          const thumb = document.createElement('span');
          thumb.className = 'thumb';
          track.appendChild(thumb);
          toggleLabel.appendChild(track);
          toggleWrap.appendChild(toggleLabel);
          const toggleHint = document.createElement('span');
          toggleHint.className = 'hint';
          toggleHint.textContent = 'Enable region';
          toggleWrap.appendChild(toggleHint);
          toggleInput.addEventListener('change', () => {
            region.enabled = !!toggleInput.checked;
            updateRegionEntryState(region);
            updateRegionElementAppearance(region);
          });
          entry.appendChild(toggleWrap);
        }
        const promptLabel = document.createElement('label');
        promptLabel.textContent = 'Prompt';
        promptLabel.setAttribute('for', `rp-region${region.id}-prompt`);
        promptLabel.style.marginTop = '10px';
        entry.appendChild(promptLabel);
        const promptInput = document.createElement('textarea');
        promptInput.id = `rp-region${region.id}-prompt`;
        promptInput.value = region.prompt;
        promptInput.placeholder = `Describe ${region.meta.name.toLowerCase()}...`;
        promptInput.addEventListener('input', () => { region.prompt = promptInput.value; });
        entry.appendChild(promptInput);
        const grid = document.createElement('div');
        grid.className = 'region-grid';
        const inputs = {};
        const coords = [
          { key: 'x', label: 'X', min: 0 },
          { key: 'y', label: 'Y', min: 0 },
          { key: 'width', label: 'Width', min: 1 },
          { key: 'height', label: 'Height', min: 1 },
        ];
        coords.forEach(coord => {
          const wrap = document.createElement('div');
          const coordLabel = document.createElement('label');
          coordLabel.textContent = coord.label;
          wrap.appendChild(coordLabel);
          const input = document.createElement('input');
          input.type = 'number';
          input.step = '1';
          input.min = String(coord.min);
          input.value = String(region.mask[coord.key]);
          wrap.appendChild(input);
          input.addEventListener('change', () => {
            const parsed = parseInt(input.value, 10);
            if (!Number.isFinite(parsed)){
              input.value = String(region.mask[coord.key]);
              return;
            }
            const next = { ...region.mask, [coord.key]: parsed };
            if (!applyRegionRect(region, next)){
              input.value = String(region.mask[coord.key]);
            }
          });
          grid.appendChild(wrap);
          inputs[coord.key] = input;
        });
        entry.appendChild(grid);
        entry.addEventListener('click', ev => {
          if (ev.target.closest('button,textarea,input,label')) return;
          selectRegion(region.id);
        });
        rp.regionList.appendChild(entry);
        rpRegionForms.set(region.id, { entry, inputs, prompt: promptInput, toggle: toggleInput });
        updateRegionEntryState(region);
      }
      updateRegionFormBounds();
      selectRegion(rpSelectedRegionId);
    }

    function renderRegionalUi(){
      renderRegionMaskLayer();
      renderRegionList();
      updateAddRegionState();
      queueRegionPositionUpdate();
    }

    function updateAddRegionState(){
      if (!rp.addRegion) return;
      const canAdd = rpRegions.some(region => !region.active);
      rp.addRegion.disabled = !canAdd;
    }

    function applyRegionRect(region, rect){
      const sanitized = clampRegionRect(rect);
      if (hasRegionOverlap(sanitized, region)) return false;
      region.mask = sanitized;
      updateRegionElementAppearance(region);
      updateRegionInputs(region);
      return true;
    }

    function addRegion(){
      const region = rpRegions.find(r => !r.active);
      if (!region) return;
      region.active = true;
      region.enabled = true;
      region.prompt = '';
      const rect = findAvailableRect(region.meta);
      if (!rect){
        region.active = false;
        region.enabled = false;
        if (rp.status) rp.status.textContent = 'No available space for another region';
        updateAddRegionState();
        return;
      }
      region.mask = rect;
      renderRegionalUi();
      selectRegion(region.id);
    }

    function removeRegion(id){
      const region = rpRegions.find(r => r.id === id);
      if (!region || region.id === 1) return;
      region.active = false;
      region.enabled = false;
      const el = rpRegionElements.get(region.id);
      if (el){
        el.remove();
        rpRegionElements.delete(region.id);
      }
      rpRegionForms.delete(region.id);
      if (rpSelectedRegionId === region.id){
        const firstActive = rpRegions.find(r => r.active);
        rpSelectedRegionId = firstActive ? firstActive.id : 1;
      }
      renderRegionalUi();
    }

    if (rp.maskEditor && typeof ResizeObserver !== 'undefined'){
      const observer = new ResizeObserver(() => queueRegionPositionUpdate());
      observer.observe(rp.maskEditor);
    }

    window.addEventListener('resize', () => queueRegionPositionUpdate());

    function setRpCfgRangeForSampler(sel, input, hint){
      if (!sel || !input || !hint) return;
      const isCfgPP = sel.value.includes('cfg_pp');
      if (isCfgPP){
        input.min = 0.5; input.max = 3.0; input.step = 0.1;
        if (+input.value < 0.5 || +input.value > 3.0) input.value = 1.0;
        hint.textContent = 'Range 0.5–3.0 (cfg_pp)';
      } else {
        input.min = 4.0; input.max = 6.0; input.step = 0.1;
        if (+input.value < 4.0 || +input.value > 6.0) input.value = 5.0;
        hint.textContent = 'Range 4.0–6.0 (non cfg_pp)';
      }
    }

    function getRegionalWorkflowTemplate(){
      const el = document.getElementById('regional-workflow-template');
      if (!el) throw new Error('Regional workflow template missing');
      return JSON.parse(el.textContent.trim());
    }

    function buildRegionalPlaceholderMap(){
      ensureRpDimensions();
      const width = rpImageWidth;
      const height = rpImageHeight;
      const batchSizeVal = updateRpBatchSizeDisplay();
      const rouweiSelected = rpIsRouweiSelected();
      const zeroToggle = rp.negZero ? !!rp.negZero.checked : false;
      const zeroOut = rouweiSelected ? false : zeroToggle;
      const hiresOn = !!(rp.hiresToggle && rp.hiresToggle.checked);
      let seedVal = parseInt((rp.seed && rp.seed.value) || '-1', 10);
      if (seedVal === -1){
        seedVal = genRandomSeed();
        if (rp.seedHint) rp.seedHint.textContent = `Random seed: ${seedVal}`;
      } else if (rp.seedHint){
        rp.seedHint.textContent = rp.seedHintDefault || 'Use -1 for random';
      }
      const useHiresSeed = rp.hiresSeedCustom && rp.hiresSeedCustom.checked;
      const hiresSeed = useHiresSeed && rp.hiresSeed ? parseInt(rp.hiresSeed.value || '-1', 10) : seedVal;
      const weightRaw = parseFloat((rp.globalWeight && rp.globalWeight.value) || '0.35');
      const globalWeight = clampNumber(Number.isFinite(weightRaw) ? weightRaw : 0.35, 0.01, 1);
      if (rp.globalWeight) rp.globalWeight.value = globalWeight.toFixed(2);
      const map = {
        model: rp.model ? rp.model.value : '',
        global_prompt: rp.globalPrompt ? rp.globalPrompt.value || '' : '',
        negative_prompt: rp.negative ? rp.negative.value || '' : '',
        zero_out_negative: zeroOut,
        rouwei_prefix: rp.rouweiPrefix ? rp.rouweiPrefix.value || '' : '',
        width,
        height,
        batch_size: batchSizeVal,
        seed: seedVal,
        steps: parseInt((rp.steps && rp.steps.value) || '25', 10),
        cfg: parseFloat((rp.cfg && rp.cfg.value) || '5.0'),
        sampler: rp.sampler ? rp.sampler.value : '',
        scheduler: rp.scheduler ? rp.scheduler.value : '',
        enable_apg: rp.apgToggle ? !!rp.apgToggle.checked : true,
        remove_bg: rp.rmbg ? !!rp.rmbg.checked : false,
        global_prompt_weight: Number(globalWeight.toFixed(2)),
        hiresfix_enable: hiresOn,
        hiresfix_scale_by: parseFloat((rp.hiresScale && rp.hiresScale.value) || '1.50'),
        hiresfix_seed: hiresSeed,
        hiresfix_steps: parseInt((rp.hiresSteps && rp.hiresSteps.value) || '20', 10),
        hiresfix_cfg: parseFloat((rp.hiresCfg && rp.hiresCfg.value) || '5.0'),
        hiresfix_sampler: rp.hiresSampler ? rp.hiresSampler.value : '',
        hiresfix_scheduler: rp.hiresScheduler ? rp.hiresScheduler.value : '',
        hiresfix_denoise: parseFloat((rp.hiresDenoise && rp.hiresDenoise.value) || '0.56'),
      };
      const getRegion = id => rpRegions.find(r => r.id === id);
      for (let i = 1; i <= 4; i++){
        const region = getRegion(i);
        const mask = region ? clampRegionRect(region.mask) : { x: 0, y: 0, width: 1, height: 1 };
        map[`mask_${i}_x`] = mask.x;
        map[`mask_${i}_y`] = mask.y;
        map[`mask_${i}_width`] = mask.width;
        map[`mask_${i}_height`] = mask.height;
        map[`region_${i}_prompt`] = region ? region.prompt || '' : '';
      }
      const region2 = getRegion(2);
      const region3 = getRegion(3);
      const region4 = getRegion(4);
      map.enable_region_2 = region2 ? (!!region2.active && !!region2.enabled) : false;
      map.enable_region_3 = region3 ? (!!region3.active && !!region3.enabled) : false;
      map.enable_region_4 = region4 ? (!!region4.active && !!region4.enabled) : false;
      return map;
    }

    function buildRegionalPayload(){
      const template = getRegionalWorkflowTemplate();
      const map = buildRegionalPlaceholderMap();
      const resolved = deepReplacePlaceholders(template, map);
      return { input: { workflow: resolved } };
    }

    function setRegionalBusy(flag){
      if (rp.runBtn) rp.runBtn.disabled = flag;
      if (rp.status) rp.status.textContent = flag ? 'Running…' : 'Idle';
      if (flag) rpTimer.start(); else rpTimer.stop();
    }

    function addRegionalShot(url, name){
      if (!rp.gallery) return;
      const wrap = document.createElement('div');
      wrap.className = 'shot';
      const header = document.createElement('div');
      header.className = 'header';
      header.innerHTML = `<header><span class="mono" title="${name}">${name}</span><a class="btn" href="${url}" download>Download</a></header>`;
      wrap.appendChild(header);
      const img = new Image();
      img.loading = 'lazy';
      img.src = url;
      img.addEventListener('click', () => openLightbox(url));
      wrap.appendChild(img);
      rp.gallery.prepend(wrap);
    }

    function makeRegionalCurl(payload){
      const key = rp.apiKey ? rp.apiKey.value.trim() : '';
      const actualKey = key || '<api_key>';
      return [
        'curl -sX POST',
        `  -H "Authorization: Bearer ${actualKey}"`,
        '  -H "Content-Type: application/json"',
        `  -d '${JSON.stringify(payload)}'`,
        `  ${ENDPOINT}`
      ].join(' \n');
    }

    async function runRegional(){
      const key = rp.apiKey ? rp.apiKey.value.trim() : '';
      if (!key){
        if (rp.status) rp.status.textContent = 'API key required';
        return;
      }
      updateRpRouweiState();
      if (rpIsRouweiSelected() && (!rp.rouweiPrefix || !rp.rouweiPrefix.value.trim())){
        if (rp.status) rp.status.innerHTML = '<span class="error">Rouwei prefix required when using rouwei_v080Vpred.safetensors</span>';
        return;
      }
      try{
        setRegionalBusy(true);
        const payload = buildRegionalPayload();
        if (rp.debugReq) rp.debugReq.textContent = JSON.stringify(payload, null, 2);
        const resp = await fetch(ENDPOINT, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        let data = await resp.json();
        if (rp.debugResp) rp.debugResp.textContent = JSON.stringify(data, null, 2);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        if (data.status !== 'COMPLETED'){
          if (data.id){
            if (rp.status) rp.status.textContent = 'Waiting for job...';
            data = await pollStatus(key, data.id, rp.debugResp);
          } else {
            throw new Error(`Job status: ${data.status}`);
          }
        }
        const images = data.output && Array.isArray(data.output.images) ? data.output.images : [];
        if (!images.length) throw new Error('No images in response');
        for (const item of images){
          if (item.type === 'base64' && item.data){
            addRegionalShot(`data:image/avif;base64,${item.data}`, item.filename || 'image.avif');
          } else if (item.type === 's3_url' && item.data){
            addRegionalShot(item.data, item.filename || 'image.avif');
          }
        }
        if (rp.status) rp.status.textContent = `Completed in ${data.executionTime ?? '?'} ms`;
      } catch(err){
        console.error(err);
        if (rp.status) rp.status.innerHTML = `<span class="error">Error: ${err.message}</span>`;
      } finally {
        setRegionalBusy(false);
      }
    }

    function resetRegionalDefaults(){
      if (rp.globalPrompt) rp.globalPrompt.value = '';
      if (rp.negZero) rp.negZero.checked = false;
      if (rp.negative) rp.negative.value = '';
      if (rp.rouweiPrefix) rp.rouweiPrefix.value = '';
      if (rp.dims) rp.dims.value = '1024x1024';
      rpLastPresetDims = '1024x1024';
      rpCustomDimsDirty = false;
      if (rp.customWidth) rp.customWidth.value = 1024;
      if (rp.customHeight) rp.customHeight.value = 1024;
      ensureRpDimensions();
      updateRpCustomDimsVisibility();
      if (rp.batchSize){ rp.batchSize.value = 1; updateRpBatchSizeDisplay(); }
      if (rp.rmbg) rp.rmbg.checked = false;
      if (rp.apgToggle) rp.apgToggle.checked = true;
      if (rp.globalWeight) rp.globalWeight.value = '0.35';
      resetRpRegions();
      renderRegionalUi();
      if (rp.seed) rp.seed.value = -1;
      if (rp.seedHint) rp.seedHint.textContent = rp.seedHintDefault || 'Use -1 for random';
      if (rp.steps) rp.steps.value = 25;
      if (rp.cfg) rp.cfg.value = 5.0;
      if (rp.sampler){ rp.sampler.value = 'euler'; setRpCfgRangeForSampler(rp.sampler, rp.cfg, rp.cfgHint); }
      if (rp.scheduler) rp.scheduler.value = 'normal';
      if (rp.hiresToggle){ rp.hiresToggle.checked = false; if (rp.hiresWrap) rp.hiresWrap.style.display = 'none'; }
      if (rp.hiresScale) rp.hiresScale.value = 1.50;
      if (rp.hiresSteps) rp.hiresSteps.value = 20;
      if (rp.hiresCfg){ rp.hiresCfg.value = 5.0; if (rp.hiresSampler) setRpCfgRangeForSampler(rp.hiresSampler, rp.hiresCfg, rp.hiresCfgHint); }
      if (rp.hiresDenoise) rp.hiresDenoise.value = 0.56;
      if (rp.hiresSampler) rp.hiresSampler.value = 'euler';
      if (rp.hiresScheduler) rp.hiresScheduler.value = 'normal';
      if (rp.hiresSeedCustom){ rp.hiresSeedCustom.checked = false; if (rp.hiresSeedWrap) rp.hiresSeedWrap.style.display = 'none'; }
      if (rp.hiresSeed) rp.hiresSeed.value = -1;
      updateRpRouweiState();
      if (rp.status) rp.status.textContent = 'Reset to defaults';
      queueRegionPositionUpdate();
    }

    if (rp.model) rp.model.addEventListener('change', updateRpRouweiState);
    if (rp.negZero) rp.negZero.addEventListener('change', updateRpNegativeVisibility);
    if (rp.dims) rp.dims.addEventListener('change', () => {
      if (rp.dims.value === 'custom'){
        if (!rpCustomDimsDirty && rpLastPresetDims){
          const [presetW, presetH] = rpLastPresetDims.split('x').map(n => parseInt(n, 10));
          if (rp.customWidth && Number.isFinite(presetW)) rp.customWidth.value = clampNumber(presetW, 512, 2048);
          if (rp.customHeight && Number.isFinite(presetH)) rp.customHeight.value = clampNumber(presetH, 512, 2048);
        }
      } else {
        rpLastPresetDims = rp.dims.value;
      }
      updateRpCustomDimsVisibility();
      ensureRpDimensions();
    });
    if (rp.customWidth) rp.customWidth.addEventListener('input', () => { rpCustomDimsDirty = true; ensureRpDimensions(); });
    if (rp.customHeight) rp.customHeight.addEventListener('input', () => { rpCustomDimsDirty = true; ensureRpDimensions(); });
    if (rp.batchSize) rp.batchSize.addEventListener('input', updateRpBatchSizeDisplay);
    if (rp.addRegion) rp.addRegion.addEventListener('click', () => addRegion());
    if (rp.hiresToggle) rp.hiresToggle.addEventListener('change', () => { if (rp.hiresWrap) rp.hiresWrap.style.display = rp.hiresToggle.checked ? '' : 'none'; });
    if (rp.hiresSeedCustom) rp.hiresSeedCustom.addEventListener('change', () => { if (rp.hiresSeedWrap) rp.hiresSeedWrap.style.display = rp.hiresSeedCustom.checked ? '' : 'none'; });
    if (rp.resetBtn) rp.resetBtn.addEventListener('click', () => resetRegionalDefaults());
    if (rp.clearBtn) rp.clearBtn.addEventListener('click', () => {
      if (rp.gallery) rp.gallery.innerHTML = '';
      if (rp.status) rp.status.textContent = 'Gallery cleared';
    });
    if (rp.runBtn) rp.runBtn.addEventListener('click', ev => { ev.preventDefault(); runRegional(); });
    if (rp.curlBtn) rp.curlBtn.addEventListener('click', () => {
      const payload = buildRegionalPayload();
      const text = makeRegionalCurl(payload);
      navigator.clipboard.writeText(text).then(() => { if (rp.status) rp.status.textContent = 'cURL copied'; });
    });

    populateSelect(rp.sampler, SAMPLERS, 'euler');
    populateSelect(rp.scheduler, SCHEDULERS, 'normal');
    populateSelect(rp.hiresSampler, SAMPLERS, 'euler');
    populateSelect(rp.hiresScheduler, SCHEDULERS, 'normal');
    if (rp.sampler) rp.sampler.addEventListener('change', () => setRpCfgRangeForSampler(rp.sampler, rp.cfg, rp.cfgHint));
    if (rp.hiresSampler) rp.hiresSampler.addEventListener('change', () => setRpCfgRangeForSampler(rp.hiresSampler, rp.hiresCfg, rp.hiresCfgHint));

    updateRpCustomDimsVisibility();
    updateRpBatchSizeDisplay();
    resetRegionalDefaults();

    // --- ACE-Step helpers ---
    const ace = id => document.getElementById(id);
    const acel = {
      apiKey: document.getElementById('apiKey'),
      tags: ace('ace-tags'),
      structure: ace('ace-structure'),
      minutes: ace('ace-minutes'),
      seconds: ace('ace-seconds'),
      seed: ace('ace-seed'), seedHint: ace('ace-seedHint'),
      steps: ace('ace-steps'), cfg: ace('ace-cfg'),
      sampler: ace('ace-sampler'), scheduler: ace('ace-scheduler'),
      quality: ace('ace-quality'),
      runBtn: ace('ace-run'), curlBtn: ace('ace-curl'), resetBtn: ace('ace-reset'), clearBtn: ace('ace-clear'),
      status: ace('ace-status'), timer: ace('ace-timer'), gallery: ace('ace-gallery'),
      debugReq: ace('ace-debugReq'), debugResp: ace('ace-debugResp'),
    };

    const acetimer = makeTimer(acel.timer);
    const aceBlobCleanups = [];

    if(acel.sampler) populateSelect(acel.sampler, SAMPLERS, 'res_multistep');
    if(acel.scheduler) populateSelect(acel.scheduler, SCHEDULERS, 'linear_quadratic');

    acel.seedHintDefault = acel.seedHint ? acel.seedHint.textContent : '';

    function clampSeconds(val){
      let s = parseFloat(val);
      if(!Number.isFinite(s)) s = 0;
      if(s < 0) s = 0;
      if(s > 59.999) s = 59.999;
      return s;
    }

    function parseAceDurationToSeconds(value){
      if(value === null || value === undefined) return null;
      if(typeof value === 'number'){ return Number.isFinite(value) && value > 0 ? value : null; }
      if(typeof value !== 'string') return null;
      const trimmed = value.trim();
      if(!trimmed) return null;
      if(/^\d+(?:\.\d+)?$/.test(trimmed)){ return parseFloat(trimmed); }
      const colonParts = trimmed.split(':');
      if(colonParts.length > 1){
        let total = 0;
        let multiplier = 1;
        while(colonParts.length){
          const part = colonParts.pop();
          if(part === undefined) break;
          const num = parseFloat(part);
          if(!Number.isFinite(num)) return null;
          total += num * multiplier;
          multiplier *= 60;
        }
        return total > 0 ? total : null;
      }
      const unitMatch = trimmed.match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|sec|secs|seconds|m|min|minutes|h|hr|hrs|hours)$/i);
      if(unitMatch){
        const magnitude = parseFloat(unitMatch[1]);
        if(!Number.isFinite(magnitude) || magnitude <= 0) return null;
        const unit = unitMatch[2].toLowerCase();
        if(unit === 'ms') return magnitude / 1000;
        if(unit === 's' || unit === 'sec' || unit === 'secs' || unit === 'seconds') return magnitude;
        if(unit === 'm' || unit === 'min' || unit === 'minutes') return magnitude * 60;
        if(unit === 'h' || unit === 'hr' || unit === 'hrs' || unit === 'hours') return magnitude * 3600;
      }
      const simpleMatch = trimmed.match(/^([0-9]+)m(?:\s*([0-9]+(?:\.[0-9]+)?)s)?$/i);
      if(simpleMatch){
        const minutes = parseFloat(simpleMatch[1]);
        const seconds = simpleMatch[2] ? parseFloat(simpleMatch[2]) : 0;
        if(Number.isFinite(minutes) && minutes >= 0 && Number.isFinite(seconds) && seconds >= 0){
          const total = minutes * 60 + seconds;
          return total > 0 ? total : null;
        }
      }
      return null;
    }

    function findAceDurationSeconds(obj, visited = new WeakSet()){
      if(!obj || typeof obj !== 'object') return null;
      if(visited.has(obj)) return null;
      visited.add(obj);
      const candidateKeys = [
        'duration', 'durationSeconds', 'duration_seconds', 'duration_sec', 'seconds', 'secs',
        'length', 'length_seconds', 'lengthSeconds', 'audio_seconds', 'audioSeconds',
        'total_seconds', 'time_seconds', 'time'
      ];
      for(const key of candidateKeys){
        if(Object.prototype.hasOwnProperty.call(obj, key)){
          const parsed = parseAceDurationToSeconds(obj[key]);
          if(parsed) return parsed;
        }
      }
      const nestedKeys = ['metadata', 'meta', 'info', 'details', 'extra', 'attributes', 'audioInfo', 'audio_info'];
      for(const key of nestedKeys){
        if(!Object.prototype.hasOwnProperty.call(obj, key)) continue;
        const value = obj[key];
        if(Array.isArray(value)){
          for(const item of value){
            const found = findAceDurationSeconds(item, visited);
            if(found) return found;
          }
        } else if(value && typeof value === 'object'){
          const found = findAceDurationSeconds(value, visited);
          if(found) return found;
        }
      }
      return null;
    }

    function formatAceClock(seconds){
      if(!Number.isFinite(seconds) || seconds <= 0) return null;
      const totalSeconds = Math.floor(seconds);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const secs = totalSeconds % 60;
      const secStr = String(secs).padStart(2, '0');
      if(hours > 0){
        return `${hours}:${String(minutes).padStart(2, '0')}:${secStr}`;
      }
      return `${minutes}:${secStr}`;
    }

    function formatAceSecondsValue(seconds){
      if(!Number.isFinite(seconds) || seconds <= 0) return null;
      let decimals = 0;
      if(seconds < 10) decimals = 2;
      else if(seconds < 100) decimals = 1;
      let str = seconds.toFixed(decimals);
      if(decimals > 0) str = str.replace(/\.0+$/, '').replace(/(\.\d*?)0+$/, '$1');
      return str;
    }

    function formatAceDurationLabel(seconds){
      if(!Number.isFinite(seconds) || seconds <= 0) return null;
      const clock = formatAceClock(seconds);
      const precise = formatAceSecondsValue(seconds);
      if(clock && precise) return `Length: ${clock} (${precise}s)`;
      if(clock) return `Length: ${clock}`;
      if(precise) return `Length: ${precise}s`;
      return null;
    }

    function guessAceFilenameFromUrl(url){
      try{
        const u = new URL(url);
        const parts = u.pathname.split('/').filter(Boolean);
        const name = parts.pop();
        if(name) return name;
      }catch(err){
        if(typeof url === 'string'){
          const tail = url.split('/').filter(Boolean).pop();
          if(tail) return tail;
        }
      }
      return 'audio.ogg';
    }

    function guessAceFilenameFromDataUri(uri){
      const match = /^data:audio\/([^;,]+)/i.exec(uri || '');
      if(match && match[1]){
        const ext = match[1].split('/').pop();
        if(ext) return `audio.${ext}`;
      }
      return 'audio.ogg';
    }

    function finalizeAceSource(src, context, fallbackDuration){
      if(!src) return src;
      let duration = null;
      if(Number.isFinite(fallbackDuration) && fallbackDuration > 0){
        duration = fallbackDuration;
      } else if(typeof context === 'number'){
        duration = context;
      } else if(context && typeof context === 'object'){
        duration = findAceDurationSeconds(context);
      }
      if(Number.isFinite(duration) && duration > 0) src.duration = duration;
      return src;
    }

    function parseContentDispositionFilename(header){
      if(!header) return null;
      const star = header.match(/filename\*=UTF-8''([^;]+)/i);
      if(star && star[1]){
        try{ return decodeURIComponent(star[1]); }
        catch(err){ return star[1]; }
      }
      const quoted = header.match(/filename="?([^";]+)"?/i);
      if(quoted && quoted[1]) return quoted[1];
      return null;
    }

    if(acel.seconds){
      acel.seconds.addEventListener('change', ()=>{
        const s = clampSeconds(acel.seconds.value || '0');
        acel.seconds.value = Number.isInteger(s) ? String(Math.trunc(s)) : s.toFixed(3);
      });
    }

    if(acel.minutes){
      acel.minutes.addEventListener('change', ()=>{
        let m = parseInt(acel.minutes.value || '0', 10);
        if(!Number.isFinite(m) || m < 0) m = 0;
        acel.minutes.value = m;
      });
    }

    function getAceLengthSeconds(){
      const minutes = Math.max(0, parseInt(acel.minutes && acel.minutes.value || '0', 10) || 0);
      const seconds = clampSeconds(acel.seconds && acel.seconds.value || '0');
      return Math.round((minutes * 60 + seconds) * 1000) / 1000;
    }

    function buildAcePlaceholderMap(){
      let seedVal = parseInt(acel.seed && acel.seed.value || '-1', 10);
      if(!Number.isFinite(seedVal)) seedVal = -1;
      if(seedVal === -1){
        seedVal = genRandomSeed();
        if(acel.seedHint) acel.seedHint.textContent = `Random seed: ${seedVal}`;
      } else if(acel.seedHint){
        acel.seedHint.textContent = acel.seedHintDefault;
      }
      const rawSteps = parseInt(acel.steps && (acel.steps.value || '50'), 10);
      const stepsVal = Number.isFinite(rawSteps) ? Math.min(75, Math.max(25, rawSteps)) : 50;
      const rawCfg = parseFloat(acel.cfg && (acel.cfg.value || '5.0'));
      const cfgVal = Number.isFinite(rawCfg) ? Math.max(1.0, rawCfg) : 5.0;
      return {
        tags: acel.tags && acel.tags.value || '',
        structure: acel.structure && acel.structure.value || '',
        length: getAceLengthSeconds(),
        seed: seedVal,
        steps: stepsVal,
        cfg: Number.isFinite(cfgVal) ? cfgVal : 5.0,
        sampler: acel.sampler && acel.sampler.value || 'res_multistep',
        scheduler: acel.scheduler && acel.scheduler.value || 'linear_quadratic',
        quality: acel.quality && acel.quality.value || '128k',
      };
    }

    function buildAcePayload(){
      const template = getAceTemplate();
      const map = buildAcePlaceholderMap();
      const resolved = deepReplacePlaceholders(template, map);
      return { input: { workflow: resolved } };
    }

    function makeAceCurl(payload){
      const key = (acel.apiKey && acel.apiKey.value || '').trim() || '<api_key>';
      return [
        'curl -sX POST',
        `  -H "Authorization: Bearer ${key}"`,
        '  -H "Content-Type: application/json"',
        `  -d '${JSON.stringify(payload)}'`,
        `  ${ACE_ENDPOINT}`
      ].join(' \n');
    }

    function setAceBusy(b){
      if(acel.runBtn) acel.runBtn.disabled = b;
      if(acel.status){
        if(b){
          acel.status.textContent = 'Running…';
        } else if(acel.status.textContent === 'Running…' || acel.status.textContent === 'Fetching audio files…'){
          acel.status.textContent = 'Idle';
        }
      }
      if(acel.timer){ b ? acetimer.start() : acetimer.stop(); }
    }

    function aceItemToSource(item){
      if(!item) return null;
      const audioPattern = /\.(?:ogg|opus|wav|mp3|m4a|flac)(?:\?.*)?$/i;
      if(typeof item === 'string'){
        const trimmed = item.trim();
        if(trimmed.startsWith('data:audio/')){
          return { kind: 'data', url: trimmed, filename: guessAceFilenameFromDataUri(trimmed) };
        }
        if(/^https?:/i.test(trimmed) && audioPattern.test(trimmed)){
          return { kind: 'url', url: trimmed, filename: guessAceFilenameFromUrl(trimmed) };
        }
        return null;
      }
      if(Array.isArray(item)){
        // Arrays are handled by extractAceAudios walker, but keep a fallback
        for(const entry of item){
          const found = aceItemToSource(entry);
          if(found) return found;
        }
        return null;
      }
      if(typeof item !== 'object') return null;

      const filename = item.filename || item.file_name || item.name || item.originalName || null;
      const typeRaw = item.type || item.kind || '';
      const contentTypeRaw = item.content_type || item.contentType || item.mime || '';
      const lowerType = typeof typeRaw === 'string' ? typeRaw.toLowerCase() : '';
      const lowerContentType = typeof contentTypeRaw === 'string' ? contentTypeRaw.toLowerCase() : '';
      const fallbackDuration = findAceDurationSeconds(item);

      if(lowerType === 'base64' && item.data){
        const mime = lowerContentType || 'audio/ogg';
        return finalizeAceSource({
          kind: 'data',
          url: `data:${mime};base64,${item.data}`,
          filename: filename || guessAceFilenameFromDataUri(`data:${mime}`)
        }, item, fallbackDuration);
      }

      const candidateKeys = ['url', 'data', 'path', 'location', 'signed_url', 'signedUrl', 'downloadUrl', 'download_url'];
      for(const key of candidateKeys){
        const value = item[key];
        if(typeof value !== 'string') continue;
        const trimmed = value.trim();
        if(trimmed.startsWith('data:audio/')){
          return finalizeAceSource({ kind: 'data', url: trimmed, filename: filename || guessAceFilenameFromDataUri(trimmed) }, item, fallbackDuration);
        }
        if(/^https?:/i.test(trimmed) && (audioPattern.test(trimmed) || lowerType.includes('audio') || lowerContentType.startsWith('audio'))){
          return finalizeAceSource({ kind: 'url', url: trimmed, filename: filename || guessAceFilenameFromUrl(trimmed) }, item, fallbackDuration);
        }
      }

      if((lowerType && lowerType.startsWith('audio')) || (lowerContentType && lowerContentType.startsWith('audio'))){
        if(item.data && typeof item.data === 'string'){
          if(item.data.startsWith('http')){
            return finalizeAceSource({ kind: 'url', url: item.data, filename: filename || guessAceFilenameFromUrl(item.data) }, item, fallbackDuration);
          }
          if(item.data.startsWith('data:audio/')){
            return finalizeAceSource({ kind: 'data', url: item.data, filename: filename || guessAceFilenameFromDataUri(item.data) }, item, fallbackDuration);
          }
          return finalizeAceSource({
            kind: 'data',
            url: `data:${lowerContentType || lowerType};base64,${item.data}`,
            filename: filename || guessAceFilenameFromDataUri(`data:${lowerContentType || lowerType}`)
          }, item, fallbackDuration);
        }
      }

      if(item.bucket && item.key && typeof item.bucket === 'string' && typeof item.key === 'string'){
        const s3Url = item.key.startsWith('http') ? item.key : `https://${item.bucket}.s3.amazonaws.com/${item.key.replace(/^\//, '')}`;
        if(/^https?:/i.test(s3Url)){
          return finalizeAceSource({ kind: 'url', url: s3Url, filename: filename || guessAceFilenameFromUrl(s3Url) }, item, fallbackDuration);
        }
      }

      if(item.data && typeof item.data === 'object'){
        const nested = aceItemToSource(item.data);
        if(nested){
          if((!Number.isFinite(nested.duration) || nested.duration <= 0) && Number.isFinite(fallbackDuration) && fallbackDuration > 0){
            nested.duration = fallbackDuration;
          }
          return nested;
        }
      }
      if(item.output && typeof item.output === 'object'){
        const nested = aceItemToSource(item.output);
        if(nested){
          if((!Number.isFinite(nested.duration) || nested.duration <= 0) && Number.isFinite(fallbackDuration) && fallbackDuration > 0){
            nested.duration = fallbackDuration;
          }
          return nested;
        }
      }
      if(item.result && typeof item.result === 'object'){
        const nested = aceItemToSource(item.result);
        if(nested){
          if((!Number.isFinite(nested.duration) || nested.duration <= 0) && Number.isFinite(fallbackDuration) && fallbackDuration > 0){
            nested.duration = fallbackDuration;
          }
          return nested;
        }
      }

      let fileId = item.fileId || item.file_id || null;
      if(!fileId && item.id && (lowerType === 'file' || lowerType === 'output')) fileId = item.id;
      const hasExplicitUrl = candidateKeys.some(key => typeof item[key] === 'string' && item[key].trim().startsWith('http'));
      if(!fileId && item.id && (filename || item.name) && !hasExplicitUrl) fileId = item.id;
      if(fileId){
        const inferredName = filename || item.name || guessAceFilenameFromUrl(item.path || item.key || '');
        return finalizeAceSource({
          kind: 'file',
          fileId,
          filename: inferredName || 'audio.ogg'
        }, item, fallbackDuration);
      }

      return null;
    }

    function extractAceAudios(data){
      const ready = [];
      const pending = [];
      const seenUrls = new Set();
      const seenFiles = new Set();
      const visited = new WeakSet();

      function pushSource(src){
        if(!src) return;
        if(src.kind === 'file'){
          const fid = src.fileId;
          if(fid && !seenFiles.has(fid)){
            seenFiles.add(fid);
            pending.push({ fileId: fid, filename: src.filename || 'audio.ogg', duration: Number.isFinite(src.duration) && src.duration > 0 ? src.duration : null });
          }
          return;
        }
        const url = src.url;
        if(!url || seenUrls.has(url)) return;
        seenUrls.add(url);
        const name = src.filename || (src.kind === 'data' ? guessAceFilenameFromDataUri(url) : guessAceFilenameFromUrl(url));
        const entry = { url, filename: name, cleanup: src.cleanup };
        if(Number.isFinite(src.duration) && src.duration > 0) entry.duration = src.duration;
        ready.push(entry);
      }

      function walk(node){
        if(node === null || node === undefined) return;
        if(typeof node === 'string'){
          const trimmed = node.trim();
          if(!trimmed) return;
          const maybe = aceItemToSource(trimmed);
          if(maybe) pushSource(maybe);
          return;
        }
        if(typeof node === 'number' || typeof node === 'boolean') return;
        if(Array.isArray(node)){
          for(const item of node) walk(item);
          return;
        }
        if(typeof node === 'object'){
          if(visited.has(node)) return;
          visited.add(node);
          pushSource(aceItemToSource(node));
          for(const key of Object.keys(node)){
            if(key === 'id' || key === 'status' || key === 'executionTime' || key === 'delayTime' || key === 'workerId') continue;
            walk(node[key]);
          }
        }
      }

      walk(data);
      return { ready, pending };
    }

    async function downloadAceFile(key, jobId, fileId, filename){
      if(!fileId) return null;
      const headers = { 'Authorization': `Bearer ${key}` };
      const bases = new Set();
      bases.add(`${ACE_FILE_ENDPOINT}/${fileId}`);
      bases.add(`${ACE_FILES_ENDPOINT}/${fileId}`);
      bases.add(`${ACE_BASE_ENDPOINT}/output/${fileId}`);
      if(jobId){
        bases.add(`${ACE_RUNS_ENDPOINT}/${jobId}/output/${fileId}`);
        bases.add(`${ACE_RUNS_ENDPOINT}/${jobId}/file/${fileId}`);
        bases.add(`${ACE_RUN_ENDPOINT}/${jobId}/output/${fileId}`);
        bases.add(`${ACE_ENDPOINT}/${jobId}/output/${fileId}`);
        bases.add(`${ACE_ENDPOINT}/${jobId}/file/${fileId}`);
      }
      const queries = ['', '?download=1', '?rp_download=1', '?rp_download=true'];
      const baseVariants = new Set();
      for(const base of bases){
        baseVariants.add(base);
        baseVariants.add(`${base}/download`);
      }
      for(const base of baseVariants){
        for(const q of queries){
          const target = `${base}${q}`;
          try{
            const resp = await fetch(target, { headers });
            if(!resp.ok) continue;
            const contentType = resp.headers.get('content-type') || '';
            const headerDuration = parseAceDurationToSeconds(resp.headers.get('x-runpod-duration') || resp.headers.get('x-runpod-audio-seconds') || resp.headers.get('content-duration'));
            if(contentType.includes('application/json')){
              const json = await resp.json();
              const src = aceItemToSource(json);
              if(src && src.kind !== 'file'){
                if((!Number.isFinite(src.duration) || src.duration <= 0) && Number.isFinite(headerDuration) && headerDuration > 0){
                  src.duration = headerDuration;
                }
                const out = { url: src.url, filename: src.filename || filename || 'audio.ogg' };
                if(Number.isFinite(src.duration) && src.duration > 0) out.duration = src.duration;
                if(typeof src.cleanup === 'function') out.cleanup = src.cleanup;
                return out;
              }
              continue;
            }
            const blob = await resp.blob();
            const name = parseContentDispositionFilename(resp.headers.get('content-disposition')) || filename || 'audio.ogg';
            const blobUrl = URL.createObjectURL(blob);
            const out = { url: blobUrl, filename: name, cleanup: () => URL.revokeObjectURL(blobUrl) };
            if(Number.isFinite(headerDuration) && headerDuration > 0) out.duration = headerDuration;
            return out;
          } catch(err){
            console.debug('ACE download candidate failed', target, err);
          }
        }
      }
      return null;
    }

    function addAceTrack(entry){
      if(!entry || !acel.gallery) return;
      const url = entry.url;
      if(!url) return;
      const name = entry.filename || guessAceFilenameFromUrl(url);
      const wrap = document.createElement('div');
      wrap.className = 'shot';
      const header = document.createElement('div');
      header.className = 'header';
      const titleWrap = document.createElement('div');
      titleWrap.style.display = 'flex';
      titleWrap.style.flexDirection = 'column';
      titleWrap.style.gap = '4px';
      titleWrap.style.minWidth = '0';
      const title = document.createElement('span');
      title.className = 'mono';
      title.textContent = name;
      title.title = name;
      title.style.wordBreak = 'break-word';
      const durationLabel = document.createElement('span');
      durationLabel.className = 'hint';
      durationLabel.textContent = 'Length: loading…';
      titleWrap.appendChild(title);
      titleWrap.appendChild(durationLabel);
      const download = document.createElement('a');
      download.className = 'btn';
      download.href = url;
      download.download = name;
      download.textContent = 'Download';
      header.appendChild(titleWrap);
      header.appendChild(download);
      wrap.appendChild(header);
      const audio = document.createElement('audio');
      audio.controls = true;
      audio.preload = 'metadata';
      audio.src = url;
      audio.style.width = '100%';
      const applyDuration = seconds => {
        const text = formatAceDurationLabel(seconds);
        if(text){
          durationLabel.textContent = text;
          durationLabel.title = text;
          durationLabel.dataset.hasDuration = 'true';
        }
      };
      const initialDuration = parseAceDurationToSeconds(entry.duration);
      if(Number.isFinite(initialDuration) && initialDuration > 0){
        applyDuration(initialDuration);
      }
      const handleDurationEvent = () => {
        const dur = audio.duration;
        if(Number.isFinite(dur) && dur > 0){ applyDuration(dur); return; }
        if(audio.seekable && audio.seekable.length){
          const end = audio.seekable.end(audio.seekable.length - 1);
          if(Number.isFinite(end) && end > 0){ applyDuration(end); }
        }
      };
      audio.addEventListener('loadedmetadata', handleDurationEvent);
      audio.addEventListener('durationchange', handleDurationEvent);
      audio.addEventListener('loadeddata', handleDurationEvent);
      audio.addEventListener('error', ()=>{
        if(!durationLabel.dataset.hasDuration){
          durationLabel.textContent = 'Length: unavailable';
          durationLabel.removeAttribute('title');
        }
      });
      if(audio.readyState >= 1) handleDurationEvent();
      wrap.appendChild(audio);
      if(entry.cleanup && typeof entry.cleanup === 'function'){
        aceBlobCleanups.push(entry.cleanup);
      }
      acel.gallery.prepend(wrap);
    }

    async function runAce(){
      const key = (acel.apiKey && acel.apiKey.value || '').trim();
      if(!key){ if(acel.status) acel.status.textContent = 'API key required'; return; }
      try{
        setAceBusy(true);
        const payload = buildAcePayload();
        if(acel.debugReq) acel.debugReq.textContent = JSON.stringify(payload, null, 2);
        const resp = await fetch(ACE_ENDPOINT, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${key}`, 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        let data = await resp.json();
        let jobId = data && data.id ? data.id : null;
        if(acel.debugResp) acel.debugResp.textContent = JSON.stringify(data, null, 2);

        if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
        if(data.status !== 'COMPLETED'){
          if(data.id){
            if(acel.status) acel.status.textContent = 'Waiting for job...';
            data = await pollStatus(key, data.id, acel.debugResp, ACE_STATUS_ENDPOINT);
            if(data && data.id) jobId = data.id;
          } else {
            throw new Error(`Job status: ${data.status}`);
          }
        }

        const { ready, pending } = extractAceAudios(data);
        const tracks = [...ready];
        if(pending.length && acel.status) acel.status.textContent = 'Fetching audio files…';
        for(const file of pending){
          const downloaded = await downloadAceFile(key, jobId, file.fileId, file.filename);
          if(downloaded){
            if(Number.isFinite(file.duration) && file.duration > 0 && (!Number.isFinite(downloaded.duration) || downloaded.duration <= 0)){
              downloaded.duration = file.duration;
            }
            tracks.push(downloaded);
          }
        }
        if(!tracks.length){
          const workerStatus = data && data.output && data.output.status ? data.output.status : null;
          throw new Error(workerStatus ? `No audio returned (worker status: ${workerStatus})` : 'No audio returned');
        }

        for(const item of tracks){
          addAceTrack(item);
        }
        if(acel.status) acel.status.textContent = `Completed in ${data.executionTime ?? '?'} ms`;
      } catch(err){
        console.error(err);
        if(acel.status) acel.status.innerHTML = `<span class="error">Error: ${err.message}</span>`;
      } finally { setAceBusy(false); }
    }

    if(acel.runBtn) acel.runBtn.addEventListener('click', (e)=>{ e.preventDefault(); runAce(); });
    if(acel.curlBtn) acel.curlBtn.addEventListener('click', ()=>{
      const payload = buildAcePayload();
      const text = makeAceCurl(payload);
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(()=>{ if(acel.status) acel.status.textContent = 'cURL copied'; });
      }
    });

    if(acel.resetBtn) acel.resetBtn.addEventListener('click', ()=>{
      if(acel.tags) acel.tags.value = '';
      if(acel.structure) acel.structure.value = '';
      if(acel.minutes) acel.minutes.value = 0;
      if(acel.seconds) acel.seconds.value = 30;
      if(acel.seed) acel.seed.value = -1;
      if(acel.steps) acel.steps.value = 50;
      if(acel.cfg) acel.cfg.value = 5.0;
      if(acel.sampler) acel.sampler.value = 'res_multistep';
      if(acel.scheduler) acel.scheduler.value = 'linear_quadratic';
      if(acel.quality) acel.quality.value = '128k';
      if(acel.seedHint) acel.seedHint.textContent = acel.seedHintDefault;
      if(acel.status) acel.status.textContent = 'Reset to defaults';
    });

    if(acel.clearBtn) acel.clearBtn.addEventListener('click', ()=>{
      if(acel.gallery) acel.gallery.innerHTML = '';
      while(aceBlobCleanups.length){
        const fn = aceBlobCleanups.pop();
        try{ if(typeof fn === 'function') fn(); } catch(err){ console.debug('ACE cleanup error', err); }
      }
      if(acel.status) acel.status.textContent = 'Outputs cleared';
    });

    // Initialize
    (function(){
      if(!el.dims) return;
      el.dims.value = '1024x1024';
      lastPresetDims = '1024x1024';
      customDimsDirty = false;
      if(el.customWidth) el.customWidth.value = 1024;
      if(el.customHeight) el.customHeight.value = 1024;
      updateCustomDimsVisibility();
    })();
  </script>


<script>
  // --- Tabs: label the existing main and wire toggling without changing SDXL code ---
  (function(){
    const sdxlMain = document.querySelector('body > main') || document.querySelector('main');
    const qwenMain = document.getElementById('qwen-main');
    const aceMain = document.getElementById('ace-main');
    const wanMain = document.getElementById('wan-main');
    const tabbar = document.getElementById('tabbar');
    if (!sdxlMain || !tabbar) return;
    sdxlMain.id = 'sdxl-main';
    const sections = { sdxl: sdxlMain };
    if(qwenMain) sections.qwen = qwenMain;
    if(aceMain) sections.ace = aceMain;
    if(wanMain) sections.wan = wanMain;
    const subtabbar = document.getElementById('sdxl-subtabbar');
    const subtabButtons = subtabbar ? Array.from(subtabbar.querySelectorAll('.tab')) : [];
    const sdxlSubtabs = Array.from(sdxlMain.querySelectorAll('.sdxl-subtab'));
    function activateSdxlSubtab(name){
      sdxlSubtabs.forEach(sub => {
        if(sub.dataset.subtab === name) sub.classList.remove('hidden');
        else sub.classList.add('hidden');
      });
      subtabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.subtab === name));
      if(name === 'regional' && typeof queueRegionPositionUpdate === 'function'){
        queueRegionPositionUpdate();
      }
    }
    if(subtabbar){
      subtabbar.addEventListener('click', (event)=>{
        const btn = event.target.closest('.tab');
        if(!btn) return;
        const name = btn.dataset.subtab;
        if(!name) return;
        activateSdxlSubtab(name);
      });
      activateSdxlSubtab('standard');
    }
    tabbar.addEventListener('click', (e)=>{
      const btn = e.target.closest('.tab'); if(!btn) return;
      const tab = btn.dataset.tab;
      if(!tab || !sections[tab]) return;
      for(const b of tabbar.querySelectorAll('.tab')) b.classList.remove('active');
      btn.classList.add('active');
      for (const key of Object.keys(sections)){
        if(key === tab) sections[key].classList.remove('hidden');
        else sections[key].classList.add('hidden');
      }
      if(tab === 'sdxl' && typeof queueRegionPositionUpdate === 'function'){
        queueRegionPositionUpdate();
      }
    });
  })();

  // --- Wan 2.2 helpers ---
  const w = id => document.getElementById(id);
  const wanel = {
    apiKey: document.getElementById('apiKey'),
    imgUrl: w('wan-img-url'),
    megapixels: w('wan-megapixels'),
    modelShift: w('wan-model-shift'),
    nsfw: w('wan-nsfw'),
    mainPrompt: w('wan-main-prompt'),
    initialLength: w('wan-initial-length'),
    steps: w('wan-steps'),
    seed: w('wan-seed'), seedHint: w('wan-seed-hint'),
    sampler1: w('wan-sampler-1'), scheduler1: w('wan-scheduler-1'),
    sameSampler2: w('wan-same-sampler-2'), sampler2Wrap: w('wan-sampler-2-wrap'), sampler2: w('wan-sampler-2'),
    sameScheduler2: w('wan-same-scheduler-2'), scheduler2Wrap: w('wan-scheduler-2-wrap'), scheduler2: w('wan-scheduler-2'),
    extendToggle: w('wan-extend'), extendWrap: w('wan-extend-wrap'),
    altPromptToggle: w('wan-alt-prompt'), secondPromptWrap: w('wan-second-prompt-wrap'), secondPrompt: w('wan-second-prompt'),
    extSteps: w('wan-ext-steps'), extLength: w('wan-ext-length'),
    extSeedSame: w('wan-ext-seed-same'), extSeedHint: w('wan-ext-seed-hint'),
    extSampler1Link: w('wan-ext-same-sampler-1'), extSampler1Wrap: w('wan-ext-sampler-1-wrap'), extSampler1: w('wan-ext-sampler-1'),
    extScheduler1Link: w('wan-ext-same-scheduler-1'), extScheduler1Wrap: w('wan-ext-scheduler-1-wrap'), extScheduler1: w('wan-ext-scheduler-1'),
    extSampler2Link: w('wan-ext-same-sampler-2'), extSampler2Wrap: w('wan-ext-sampler-2-wrap'), extSampler2: w('wan-ext-sampler-2'),
    extScheduler2Link: w('wan-ext-same-scheduler-2'), extScheduler2Wrap: w('wan-ext-scheduler-2-wrap'), extScheduler2: w('wan-ext-scheduler-2'),
    interpolate: w('wan-interpolate'), fastWrap: w('wan-fast-wrap'), fastInterpolation: w('wan-fast-interpolation'),
    pingPong: w('wan-pingpong'),
    status: w('wan-status'), timer: w('wan-timer'), gallery: w('wan-gallery'),
    runBtn: w('wan-run'), curlBtn: w('wan-curl'), resetBtn: w('wan-reset'), clearBtn: w('wan-clear'),
    debugReq: w('wan-debugReq'), debugResp: w('wan-debugResp'),
  };

  wanel.seedHintDefault = wanel.seedHint ? wanel.seedHint.textContent : '';
  wanel.extSeedHintDefault = wanel.extSeedHint ? wanel.extSeedHint.textContent : '';

  const wantimer = makeTimer(wanel.timer);
  const wanBlobCleanups = [];

  populateSelect(wanel.sampler1, SAMPLERS, 'euler');
  populateSelect(wanel.scheduler1, SCHEDULERS, 'simple');
  populateSelect(wanel.sampler2, SAMPLERS, 'euler');
  populateSelect(wanel.scheduler2, SCHEDULERS, 'simple');
  populateSelect(wanel.extSampler1, SAMPLERS, 'euler');
  populateSelect(wanel.extScheduler1, SCHEDULERS, 'simple');
  populateSelect(wanel.extSampler2, SAMPLERS, 'euler');
  populateSelect(wanel.extScheduler2, SCHEDULERS, 'simple');

  function clampWanMegapixels(){
    if(!wanel.megapixels) return 0.5;
    let raw = parseFloat(wanel.megapixels.value || '0.5');
    if(!Number.isFinite(raw)) raw = 0.5;
    raw = Math.max(0.25, Math.min(1.0, raw));
    raw = Math.round(raw * 100) / 100;
    wanel.megapixels.value = raw.toFixed(2);
    return raw;
  }

  function clampWanModelShift(){
    if(!wanel.modelShift) return 5.0;
    let raw = parseFloat(wanel.modelShift.value || '5');
    if(!Number.isFinite(raw)) raw = 5.0;
    raw = Math.max(3.0, Math.min(10.0, raw));
    raw = Math.round(raw * 100) / 100;
    wanel.modelShift.value = raw.toFixed(2);
    return raw;
  }

  function updateWanSampler2Visibility(){
    const linked = !!(wanel.sameSampler2 && wanel.sameSampler2.checked);
    if(wanel.sampler2) wanel.sampler2.disabled = linked;
    if(wanel.sampler2Wrap) wanel.sampler2Wrap.style.display = linked ? 'none' : '';
  }

  function updateWanScheduler2Visibility(){
    const linked = !!(wanel.sameScheduler2 && wanel.sameScheduler2.checked);
    if(wanel.scheduler2) wanel.scheduler2.disabled = linked;
    if(wanel.scheduler2Wrap) wanel.scheduler2Wrap.style.display = linked ? 'none' : '';
  }

  function updateWanExtendVisibility(){
    const on = !!(wanel.extendToggle && wanel.extendToggle.checked);
    if(wanel.extendWrap) wanel.extendWrap.style.display = on ? '' : 'none';
    if(!on && wanel.extSeedHint) wanel.extSeedHint.textContent = wanel.extSeedHintDefault || '';
  }

  function updateWanAltPromptVisibility(){
    if(!wanel.secondPromptWrap) return;
    const show = !!(wanel.extendToggle && wanel.extendToggle.checked && wanel.altPromptToggle && wanel.altPromptToggle.checked);
    wanel.secondPromptWrap.style.display = show ? '' : 'none';
  }

  function updateWanExtSampler1Visibility(){
    const linked = !!(wanel.extSampler1Link && wanel.extSampler1Link.checked);
    if(wanel.extSampler1) wanel.extSampler1.disabled = linked;
    if(wanel.extSampler1Wrap) wanel.extSampler1Wrap.style.display = linked ? 'none' : '';
  }

  function updateWanExtScheduler1Visibility(){
    const linked = !!(wanel.extScheduler1Link && wanel.extScheduler1Link.checked);
    if(wanel.extScheduler1) wanel.extScheduler1.disabled = linked;
    if(wanel.extScheduler1Wrap) wanel.extScheduler1Wrap.style.display = linked ? 'none' : '';
  }

  function updateWanExtSampler2Visibility(){
    const linked = !!(wanel.extSampler2Link && wanel.extSampler2Link.checked);
    if(wanel.extSampler2) wanel.extSampler2.disabled = linked;
    if(wanel.extSampler2Wrap) wanel.extSampler2Wrap.style.display = linked ? 'none' : '';
  }

  function updateWanExtScheduler2Visibility(){
    const linked = !!(wanel.extScheduler2Link && wanel.extScheduler2Link.checked);
    if(wanel.extScheduler2) wanel.extScheduler2.disabled = linked;
    if(wanel.extScheduler2Wrap) wanel.extScheduler2Wrap.style.display = linked ? 'none' : '';
  }

  function updateWanInterpolationVisibility(){
    const on = !!(wanel.interpolate && wanel.interpolate.checked);
    if(wanel.fastInterpolation) wanel.fastInterpolation.disabled = !on;
    if(wanel.fastWrap) wanel.fastWrap.style.display = on ? 'flex' : 'none';
  }

  function guessWanFilenameFromUrl(url){
    try{
      const u = new URL(url);
      const parts = u.pathname.split('/').filter(Boolean);
      const name = parts.pop();
      if(name) return name;
    }catch(err){
      if(typeof url === 'string'){
        const m = url.match(/\/([^\/\?]+)(?:\?|$)/);
        if(m && m[1]) return m[1];
      }
    }
    return 'video.mp4';
  }

  function guessWanFilenameFromDataUri(uri){
    if(typeof uri !== 'string') return 'video.mp4';
    const mimeMatch = uri.match(/^data:([^;,]+)/i);
    const mime = mimeMatch ? mimeMatch[1].toLowerCase() : 'video/mp4';
    const ext = mime.includes('webm') ? 'webm' : mime.includes('gif') ? 'gif' : 'mp4';
    return `video.${ext}`;
  }

  async function fetchWanFile(url){
    const resp = await fetch(url);
    if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const blob = await resp.blob();
    const objectUrl = URL.createObjectURL(blob);
    return {
      url: objectUrl,
      filename: guessWanFilenameFromUrl(url),
      cleanup(){ URL.revokeObjectURL(objectUrl); }
    };
  }

  function extractWanVideos(data){
    const ready = [];
    const pending = [];
    const seenUrls = new Set();
    const seenFiles = new Set();
    const visited = new WeakSet();
    const videoPattern = /\.(?:mp4|webm|mov|m4v)(?:\?.*)?$/i;

    function pushUrl(url, filename){
      if(!url || seenUrls.has(url)) return;
      seenUrls.add(url);
      ready.push({ url, filename: filename || guessWanFilenameFromUrl(url) });
    }

    function pushFile(fileId, filename){
      if(!fileId || seenFiles.has(fileId)) return;
      seenFiles.add(fileId);
      pending.push({ fileId, filename: filename || 'video.mp4' });
    }

    function walk(node){
      if(node === null || node === undefined) return;
      if(typeof node === 'string'){
        const trimmed = node.trim();
        if(!trimmed) return;
        if(trimmed.startsWith('data:video/')){
          pushUrl(trimmed, guessWanFilenameFromDataUri(trimmed));
        } else if(/^https?:/i.test(trimmed) && (videoPattern.test(trimmed) || trimmed.includes('/file/') || trimmed.includes('/output/'))){
          pushUrl(trimmed, guessWanFilenameFromUrl(trimmed));
        }
        return;
      }
      if(typeof node === 'number' || typeof node === 'boolean') return;
      if(Array.isArray(node)){
        for(const item of node) walk(item);
        return;
      }
      if(typeof node !== 'object') return;
      if(visited.has(node)) return;
      visited.add(node);

      const type = typeof node.type === 'string' ? node.type.toLowerCase() : '';
      const mime = typeof node.mime === 'string' ? node.mime.toLowerCase() :
        typeof node.content_type === 'string' ? node.content_type.toLowerCase() :
        typeof node.contentType === 'string' ? node.contentType.toLowerCase() : '';
      const filename = node.filename || node.file_name || node.name || null;

      if(type === 'base64' && typeof node.data === 'string'){
        const mimeType = mime && mime.startsWith('video/') ? mime : 'video/mp4';
        pushUrl(`data:${mimeType};base64,${node.data}`, filename || guessWanFilenameFromDataUri(`data:${mimeType}`));
      }

      const dataField = node.data;
      if(typeof dataField === 'string' || Array.isArray(dataField) || (dataField && typeof dataField === 'object')){
        walk(dataField);
      }

      const urlFields = [node.url, node.path, node.location, node.signed_url, node.signedUrl, node.download_url, node.downloadUrl];
      for(const value of urlFields){
        if(typeof value !== 'string') continue;
        const trimmed = value.trim();
        if(!trimmed) continue;
        if(trimmed.startsWith('data:video/')){
          pushUrl(trimmed, filename || guessWanFilenameFromDataUri(trimmed));
        } else if(/^https?:/i.test(trimmed) && (videoPattern.test(trimmed) || type.includes('video') || mime.startsWith('video'))){
          pushUrl(trimmed, filename || guessWanFilenameFromUrl(trimmed));
        }
      }

      if(node.output !== undefined) walk(node.output);
      if(node.videos !== undefined) walk(node.videos);
      if(node.images !== undefined) walk(node.images);
      if(node.frames !== undefined) walk(node.frames);

      let fileId = node.fileId || node.file_id || null;
      const hasExplicitUrl = urlFields.some(v => typeof v === 'string' && v.trim().startsWith('http'));
      if(!fileId && node.id && (type.includes('video') || mime.startsWith('video') || filename) && !hasExplicitUrl){
        fileId = node.id;
      }
      if(fileId){
        pushFile(fileId, filename || 'video.mp4');
      }

      for(const key of Object.keys(node)){
        if(key === 'id' || key === 'status' || key === 'executionTime' || key === 'delayTime' || key === 'workerId') continue;
        if(key === 'data' || key === 'output' || key === 'url' || key === 'path' || key === 'location' || key === 'signed_url' || key === 'signedUrl' || key === 'download_url' || key === 'downloadUrl') continue;
        walk(node[key]);
      }
    }

    walk(data);
    return { ready, pending };
  }

  function addWanVideo(entry){
    if(!entry || !entry.url || !wanel.gallery) return;
    const name = entry.filename || guessWanFilenameFromUrl(entry.url);
    const wrap = document.createElement('div');
    wrap.className = 'shot';
    const header = document.createElement('div'); header.className = 'header';
    header.innerHTML = `<header><span class="mono" title="${name}">${name}</span><a class="btn" href="${entry.url}" download>Download</a></header>`;
    wrap.appendChild(header);
    const video = document.createElement('video');
    video.controls = true;
    video.preload = 'metadata';
    video.src = entry.url;
    video.playsInline = true;
    video.style.width = '100%';
    wrap.appendChild(video);
    if(entry.cleanup && typeof entry.cleanup === 'function') wanBlobCleanups.push(entry.cleanup);
    wanel.gallery.prepend(wrap);
  }

  function getWanTemplate(){
    const el = document.getElementById('wan-template');
    if(!el) throw new Error('Missing wan-template');
    const raw = el.textContent.trim();
    return JSON.parse(raw);
  }

  function buildWanPlaceholderMap(){
    const imgUrl = (wanel.imgUrl && wanel.imgUrl.value || '').trim();
    let seedVal = parseInt(wanel.seed && (wanel.seed.value || '-1'), 10);
    if(!Number.isFinite(seedVal)) seedVal = -1;
    if(seedVal === -1){
      seedVal = genRandomSeed();
      if(wanel.seedHint) wanel.seedHint.textContent = `Random seed: ${seedVal}`;
    } else if(wanel.seedHint){
      wanel.seedHint.textContent = wanel.seedHintDefault || '';
    }

    const mpVal = clampWanMegapixels();
    const shiftVal = clampWanModelShift();
    const stepsVal = parseInt(wanel.steps && wanel.steps.value, 10) || 4;
    const initialLengthVal = parseInt(wanel.initialLength && wanel.initialLength.value, 10) || 45;
    const sampler1Val = wanel.sampler1 ? wanel.sampler1.value : 'euler';
    const scheduler1Val = wanel.scheduler1 ? wanel.scheduler1.value : 'simple';
    const sampler2Val = (wanel.sameSampler2 && wanel.sameSampler2.checked) ? sampler1Val : (wanel.sampler2 ? wanel.sampler2.value : sampler1Val);
    const scheduler2Val = (wanel.sameScheduler2 && wanel.sameScheduler2.checked) ? scheduler1Val : (wanel.scheduler2 ? wanel.scheduler2.value : scheduler1Val);

    const extendOn = !!(wanel.extendToggle && wanel.extendToggle.checked);
    const altPrompt = extendOn && wanel.altPromptToggle && wanel.altPromptToggle.checked;
    const secondPromptVal = altPrompt && wanel.secondPrompt ? (wanel.secondPrompt.value || '') : '';

    const extStepsVal = parseInt(wanel.extSteps && wanel.extSteps.value, 10) || stepsVal;
    const extLengthVal = parseInt(wanel.extLength && wanel.extLength.value, 10) || initialLengthVal;

    let extSampler1Val = sampler1Val;
    if(wanel.extSampler1){
      const link = !!(wanel.extSampler1Link && wanel.extSampler1Link.checked);
      extSampler1Val = link ? sampler1Val : wanel.extSampler1.value;
    }

    let extScheduler1Val = scheduler1Val;
    if(wanel.extScheduler1){
      const link = !!(wanel.extScheduler1Link && wanel.extScheduler1Link.checked);
      extScheduler1Val = link ? scheduler1Val : wanel.extScheduler1.value;
    }

    let extSampler2Val = extSampler1Val;
    if(wanel.extSampler2){
      const link = !!(wanel.extSampler2Link && wanel.extSampler2Link.checked);
      extSampler2Val = link ? extSampler1Val : wanel.extSampler2.value;
    }

    let extScheduler2Val = extScheduler1Val;
    if(wanel.extScheduler2){
      const link = !!(wanel.extScheduler2Link && wanel.extScheduler2Link.checked);
      extScheduler2Val = link ? extScheduler1Val : wanel.extScheduler2.value;
    }

    let extSeedVal = seedVal;
    if(extendOn){
      const sameSeed = !!(wanel.extSeedSame && wanel.extSeedSame.checked);
      if(sameSeed){
        extSeedVal = seedVal;
        if(wanel.extSeedHint) wanel.extSeedHint.textContent = wanel.extSeedHintDefault || 'Matches initial seed when enabled.';
      } else {
        extSeedVal = genRandomSeed();
        if(wanel.extSeedHint) wanel.extSeedHint.textContent = `Random seed: ${extSeedVal}`;
      }
    } else if(wanel.extSeedHint){
      wanel.extSeedHint.textContent = wanel.extSeedHintDefault || '';
    }

    return {
      img_url: imgUrl,
      megapixels: parseFloat(mpVal.toFixed(2)),
      model_shift: parseFloat(shiftVal.toFixed(2)),
      is_nsfw: !!(wanel.nsfw && wanel.nsfw.checked),
      main_prompt: wanel.mainPrompt ? wanel.mainPrompt.value || '' : '',
      initial_length: initialLengthVal,
      steps: stepsVal,
      seed: seedVal,
      sampler_1: sampler1Val,
      scheduler_1: scheduler1Val,
      sampler_2: sampler2Val,
      scheduler_2: scheduler2Val,
      extend_video: extendOn,
      alt_prompt_2nd_pass: altPrompt,
      second_prompt: secondPromptVal,
      ext_steps: extStepsVal,
      ext_length: extLengthVal,
      ext_seed: extSeedVal,
      ext_sampler_1: extSampler1Val,
      ext_scheduler_1: extScheduler1Val,
      ext_sampler_2: extSampler2Val,
      ext_scheduler_2: extScheduler2Val,
      interpolate: !!(wanel.interpolate && wanel.interpolate.checked),
      fast_interpolation: !!(wanel.fastInterpolation && wanel.fastInterpolation.checked),
      'ping-pong': !!(wanel.pingPong && wanel.pingPong.checked),
    };
  }

  function buildWanPayload(){
    const template = getWanTemplate();
    const map = buildWanPlaceholderMap();
    const resolved = deepReplacePlaceholders(template, map);
    return { input: { workflow: resolved } };
  }

  function makeWanCurl(payload){
    const key = (wanel.apiKey && wanel.apiKey.value || '').trim() || '<api_key>';
    return [
      'curl -sX POST',
      `  -H "Authorization: Bearer ${key}"`,
      '  -H "Content-Type: application/json"',
      `  -d '${JSON.stringify(payload)}'`,
      `  ${WAN_ENDPOINT}`
    ].join(' \n');
  }

  function setWanBusy(b){
    if(wanel.runBtn) wanel.runBtn.disabled = b;
    if(wanel.status) wanel.status.textContent = b ? 'Running…' : 'Idle';
    if(wanel.timer){ b ? wantimer.start() : wantimer.stop(); }
  }

  async function runWan(){
    const key = (wanel.apiKey && wanel.apiKey.value || '').trim();
    if(!key){ if(wanel.status) wanel.status.textContent = 'API key required'; return; }
    const imgUrl = (wanel.imgUrl && wanel.imgUrl.value || '').trim();
    if(!imgUrl){ if(wanel.status) wanel.status.textContent = 'Image URL required'; return; }
    try{
      setWanBusy(true);
      const payload = buildWanPayload();
      if(wanel.debugReq) wanel.debugReq.textContent = JSON.stringify(payload, null, 2);
      const resp = await fetch(WAN_ENDPOINT, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${key}`, 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      let data = await resp.json();
      if(wanel.debugResp) wanel.debugResp.textContent = JSON.stringify(data, null, 2);
      let jobId = data && data.id ? data.id : null;

      if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
      if(data.status !== 'COMPLETED'){
        if(data.id){
          if(wanel.status) wanel.status.textContent = 'Waiting for job...';
          data = await pollStatus(key, data.id, wanel.debugResp, WAN_STATUS_ENDPOINT);
          if(data && data.id) jobId = data.id;
        } else {
          throw new Error(`Job status: ${data.status}`);
        }
      }

      const { ready, pending } = extractWanVideos(data);
      const clips = [...ready];
      if(pending.length && wanel.status) wanel.status.textContent = 'Fetching video files…';
      for(const file of pending){
        const downloaded = await downloadAceFile(key, jobId, file.fileId, file.filename);
        if(downloaded){
          clips.push(downloaded);
        }
      }
      if(!clips.length){
        const workerStatus = data && data.output && data.output.status ? data.output.status : null;
        throw new Error(workerStatus ? `No video returned (worker status: ${workerStatus})` : 'No video returned');
      }

      for(const item of clips){
        addWanVideo(item);
      }
      if(wanel.status) wanel.status.textContent = `Completed in ${data.executionTime ?? '?'} ms`;
    } catch(err){
      console.error(err);
      if(wanel.status) wanel.status.innerHTML = `<span class="error">Error: ${err.message}</span>`;
    } finally { setWanBusy(false); }
  }

  function resetWanDefaults(){
    if(wanel.imgUrl) wanel.imgUrl.value = '';
    if(wanel.megapixels) wanel.megapixels.value = '0.50';
    if(wanel.modelShift) wanel.modelShift.value = '5.00';
    if(wanel.nsfw) wanel.nsfw.checked = false;
    if(wanel.mainPrompt) wanel.mainPrompt.value = '';
    if(wanel.initialLength) wanel.initialLength.value = '45';
    if(wanel.steps) wanel.steps.value = '4';
    if(wanel.seed) wanel.seed.value = -1;
    if(wanel.seedHint) wanel.seedHint.textContent = wanel.seedHintDefault || '';
    if(wanel.sampler1) wanel.sampler1.value = 'euler';
    if(wanel.scheduler1) wanel.scheduler1.value = 'simple';
    if(wanel.sampler2) wanel.sampler2.value = 'euler';
    if(wanel.scheduler2) wanel.scheduler2.value = 'simple';
    if(wanel.sameSampler2) wanel.sameSampler2.checked = true;
    if(wanel.sameScheduler2) wanel.sameScheduler2.checked = true;
    if(wanel.extendToggle) wanel.extendToggle.checked = false;
    if(wanel.altPromptToggle) wanel.altPromptToggle.checked = false;
    if(wanel.secondPrompt) wanel.secondPrompt.value = '';
    if(wanel.extSteps) wanel.extSteps.value = '4';
    if(wanel.extLength) wanel.extLength.value = '45';
    if(wanel.extSeedSame) wanel.extSeedSame.checked = true;
    if(wanel.extSeedHint) wanel.extSeedHint.textContent = wanel.extSeedHintDefault || '';
    if(wanel.extSampler1) wanel.extSampler1.value = 'euler';
    if(wanel.extScheduler1) wanel.extScheduler1.value = 'simple';
    if(wanel.extSampler2) wanel.extSampler2.value = 'euler';
    if(wanel.extScheduler2) wanel.extScheduler2.value = 'simple';
    if(wanel.extSampler1Link) wanel.extSampler1Link.checked = true;
    if(wanel.extScheduler1Link) wanel.extScheduler1Link.checked = true;
    if(wanel.extSampler2Link) wanel.extSampler2Link.checked = true;
    if(wanel.extScheduler2Link) wanel.extScheduler2Link.checked = true;
    if(wanel.interpolate) wanel.interpolate.checked = true;
    if(wanel.fastInterpolation) wanel.fastInterpolation.checked = true;
    if(wanel.pingPong) wanel.pingPong.checked = false;
    clampWanMegapixels();
    clampWanModelShift();
    updateWanSampler2Visibility();
    updateWanScheduler2Visibility();
    updateWanExtendVisibility();
    updateWanAltPromptVisibility();
    updateWanExtSampler1Visibility();
    updateWanExtScheduler1Visibility();
    updateWanExtSampler2Visibility();
    updateWanExtScheduler2Visibility();
    updateWanInterpolationVisibility();
  }

  if(wanel.megapixels){
    wanel.megapixels.addEventListener('change', clampWanMegapixels);
    wanel.megapixels.addEventListener('blur', clampWanMegapixels);
  }
  if(wanel.modelShift){
    wanel.modelShift.addEventListener('change', clampWanModelShift);
    wanel.modelShift.addEventListener('blur', clampWanModelShift);
  }
  if(wanel.sameSampler2) wanel.sameSampler2.addEventListener('change', updateWanSampler2Visibility);
  if(wanel.sameScheduler2) wanel.sameScheduler2.addEventListener('change', updateWanScheduler2Visibility);
  if(wanel.extendToggle) wanel.extendToggle.addEventListener('change', () => { updateWanExtendVisibility(); updateWanAltPromptVisibility(); });
  if(wanel.altPromptToggle) wanel.altPromptToggle.addEventListener('change', updateWanAltPromptVisibility);
  if(wanel.extSampler1Link) wanel.extSampler1Link.addEventListener('change', updateWanExtSampler1Visibility);
  if(wanel.extScheduler1Link) wanel.extScheduler1Link.addEventListener('change', updateWanExtScheduler1Visibility);
  if(wanel.extSampler2Link) wanel.extSampler2Link.addEventListener('change', updateWanExtSampler2Visibility);
  if(wanel.extScheduler2Link) wanel.extScheduler2Link.addEventListener('change', updateWanExtScheduler2Visibility);
  if(wanel.interpolate) wanel.interpolate.addEventListener('change', updateWanInterpolationVisibility);
  if(wanel.extSeedSame) wanel.extSeedSame.addEventListener('change', () => {
    if(!wanel.extSeedHint) return;
    if(wanel.extSeedSame.checked) wanel.extSeedHint.textContent = wanel.extSeedHintDefault || '';
    else wanel.extSeedHint.textContent = 'Random seed will be generated on run.';
  });

  if(wanel.runBtn) wanel.runBtn.addEventListener('click', (e)=>{ e.preventDefault(); runWan(); });
  if(wanel.curlBtn) wanel.curlBtn.addEventListener('click', ()=>{
    const payload = buildWanPayload();
    const text = makeWanCurl(payload);
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).then(()=>{ if(wanel.status) wanel.status.textContent = 'cURL copied'; });
    }
  });
  if(wanel.resetBtn) wanel.resetBtn.addEventListener('click', ()=>{
    resetWanDefaults();
    if(wanel.status) wanel.status.textContent = 'Reset to defaults';
  });
  if(wanel.clearBtn) wanel.clearBtn.addEventListener('click', ()=>{
    if(wanel.gallery) wanel.gallery.innerHTML = '';
    while(wanBlobCleanups.length){
      const fn = wanBlobCleanups.pop();
      try{ if(typeof fn === 'function') fn(); } catch(err){ console.debug('WAN cleanup error', err); }
    }
    if(wanel.status) wanel.status.textContent = 'Outputs cleared';
  });

  resetWanDefaults();

  // --- Qwen element helpers ---
  const q = id => document.getElementById(id);
  const qel = {
    apiKey: document.getElementById('apiKey'),
    prompt: q('q-prompt'),
    lowstep: q('q-lowstep'),
    negative: q('q-negative'), negwrap: q('q-negwrap'),
    width: q('q-width'), height: q('q-height'),
    seed: q('q-seed'), seedHint: q('q-seedHint'), steps: q('q-steps'), stepsWrap: q('q-steps-wrap'),
    stepsToggleWrap: q('q-steps-toggle'), stepsToggle: q('q-steps-toggle-input'), stepsToggleHint: q('q-steps-toggle-hint'),
    cfg: q('q-cfg'), sampler: q('q-sampler'), scheduler: q('q-scheduler'),
    modelShift: q('q-model-shift'),
    runBtn: q('q-run'), curlBtn: q('q-curl'), resetBtn: q('q-reset'), clearBtn: q('q-clear'),
    status: q('q-status'), timer: q('q-timer'), gallery: q('q-gallery'), debugReq: q('q-debugReq'), debugResp: q('q-debugResp'),
  };

  const qtimer = makeTimer(qel.timer);

  qel.seedHintDefault = qel.seedHint ? qel.seedHint.textContent : '';

  populateSelect(qel.sampler, SAMPLERS, 'euler');
  populateSelect(qel.scheduler, SCHEDULERS, 'normal');

  function updateLowstepStepsHint(){
    if(!qel.stepsToggleHint) return;
    const useEight = !!(qel.stepsToggle && qel.stepsToggle.checked);
    qel.stepsToggleHint.textContent = useEight ? '8 steps' : '4 steps';
  }

  function updateLowstepUI(){
    const on = !!(qel.lowstep && qel.lowstep.checked);
    if(qel.negwrap) qel.negwrap.style.display = on ? 'none' : '';
    if(qel.steps) qel.steps.style.display = on ? 'none' : '';
    if(qel.stepsToggleWrap) qel.stepsToggleWrap.style.display = on ? 'flex' : 'none';
    updateLowstepStepsHint();
  }

  if(qel.lowstep) qel.lowstep.addEventListener('change', updateLowstepUI);
  if(qel.stepsToggle) qel.stepsToggle.addEventListener('change', updateLowstepStepsHint);
  updateLowstepUI();

  qel.resetBtn.addEventListener('click', ()=>{
    qel.prompt.value = '';
    qel.lowstep.checked = false;
    if(qel.stepsToggle) qel.stepsToggle.checked = true;
    updateLowstepUI();
    qel.negative.value = '';
    qel.width.value = 1024; qel.height.value = 1024;
    qel.seed.value = -1; qel.steps.value = 20; qel.cfg.value = 2.0;
    qel.sampler.value = 'euler'; qel.scheduler.value = 'normal';
    qel.modelShift.value = 3.10;
    if(qel.seedHint) qel.seedHint.textContent = qel.seedHintDefault;
    qel.status.textContent = 'Reset to defaults';
  });

  qel.clearBtn.addEventListener('click', ()=>{ qel.gallery.innerHTML=''; qel.status.textContent='Gallery cleared'; });

  function buildQwenPlaceholderMap(){
    let seedVal = parseInt(qel.seed.value || '-1', 10);
    if(seedVal === -1){
      seedVal = genRandomSeed();
      if(qel.seedHint) qel.seedHint.textContent = `Random seed: ${seedVal}`;
    } else if(qel.seedHint){
      qel.seedHint.textContent = qel.seedHintDefault;
    }
    const low = !!(qel.lowstep && qel.lowstep.checked);
    const lowToggleEight = !!(qel.stepsToggle && qel.stepsToggle.checked);
    let steps;
    let lowStepLora = 'Qwen-Image-Lightning-8steps-V2.0.safetensors';
    if(low){
      if(lowToggleEight){
        steps = 8;
        lowStepLora = 'Qwen-Image-Lightning-8steps-V2.0.safetensors';
      } else {
        steps = 4;
        lowStepLora = 'Qwen-Image-Lightning-4steps-V2.0.safetensors';
      }
    } else {
      steps = Math.max(10, Math.min(30, parseInt(qel.steps.value || '20',10)));
    }
    const cfg = Math.max(1.0, Math.min(3.5, parseFloat((qel.cfg.value || '2.0').toString())));
    const w = Math.max(64, Math.min(1920, parseInt(qel.width.value || '1024',10)));
    const h = Math.max(64, Math.min(1920, parseInt(qel.height.value || '1024',10)));
    const shift = Math.max(0, parseFloat((qel.modelShift.value || '3.10')).toFixed(2));
    return {
      use_low_step: low,
      prompt: qel.prompt.value || '',
      negative_prompt: low ? '' : (qel.negative.value || ''),
      width: w, height: h,
      seed: seedVal, steps: steps,
      cfg: parseFloat(cfg.toFixed(1)),
      sampler: qel.sampler.value,
      scheduler: qel.scheduler.value,
      model_shift: shift,
      low_step_lora: lowStepLora
    };
  }

  function getQwenTemplate(){
    const el = document.getElementById('qwen-template');
    if(!el) throw new Error('Missing qwen-template');
    const raw = el.textContent.trim();
    return JSON.parse(raw);
  }

  function deepReplacePlaceholdersQ(obj, map){
    if (obj === null || obj === undefined) return obj;
    if (typeof obj === 'string'){
      const m = obj.match(/^%([a-zA-Z0-9_-]+)%$/);
      if (m){
        const key = m[1];
        if (!(key in map)) throw new Error(`Missing placeholder: ${key}`);
        return map[key];
      }
      return obj;
    } else if (Array.isArray(obj)){
      return obj.map(v => deepReplacePlaceholdersQ(v, map));
    } else if (typeof obj === 'object'){
      const out = {};
      for (const k of Object.keys(obj)) out[k] = deepReplacePlaceholdersQ(obj[k], map);
      return out;
    }
    return obj;
  }

  function buildQwenPayload(){
    const template = getQwenTemplate();
    const map = buildQwenPlaceholderMap();
    const resolved = deepReplacePlaceholdersQ(template, map);
    return { input: { workflow: resolved } };
  }

  function makeQwenCurl(payload){
    const key = (qel.apiKey && qel.apiKey.value || '').trim() || '<api_key>';
    return [
      'curl -sX POST',
      `  -H "Authorization: Bearer ${key}"`,
      '  -H "Content-Type: application/json"',
      `  -d '${JSON.stringify(payload)}'`,
      `  ${ENDPOINT}`
    ].join(' \\n');
  }

  function setQBusy(b){
    if(qel.runBtn) qel.runBtn.disabled = b;
    if(qel.status) qel.status.textContent = b? 'Running…' : 'Idle';
    if(qel.timer){ b ? qtimer.start() : qtimer.stop(); }
  }

  function addQShot(url, name){
    const wrap = document.createElement('div');
    wrap.className = 'shot';
    const header = document.createElement('div'); header.className = 'header';
    header.innerHTML = `<header><span class="mono" title="${name}">${name}</span><a class="btn" href="${url}" download>Download</a></header>`;
    wrap.appendChild(header);
    const img = new Image(); img.loading = 'lazy'; img.src = url; img.addEventListener('click', ()=>openLightbox(url)); wrap.appendChild(img);
    qel.gallery.prepend(wrap);
  }

  async function runQwen(){
    const key = (qel.apiKey && qel.apiKey.value || '').trim();
    if(!key){ if(qel.status) qel.status.textContent = 'API key required'; return; }
    try{
      setQBusy(true);
      const payload = buildQwenPayload();
      if(qel.debugReq) qel.debugReq.textContent = JSON.stringify(payload, null, 2);
      const resp = await fetch(ENDPOINT, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${key}`, 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      let data = await resp.json();
      if(qel.debugResp) qel.debugResp.textContent = JSON.stringify(data, null, 2);

      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      if (data.status !== 'COMPLETED'){
        if(data.id){
          if(qel.status) qel.status.textContent = 'Waiting for job...';
          data = await pollStatus(key, data.id, qel.debugResp);
        }else{
          throw new Error(`Job status: ${data.status}`);
        }
      }
      if (!data.output || !Array.isArray(data.output.images) || data.output.images.length === 0) throw new Error('No images in response');

      for (const item of data.output.images){
        if (item.type === 'base64' && item.data){
          const imgUrl = `data:image/avif;base64,${item.data}`;
          addQShot(imgUrl, item.filename || 'image.avif');
        } else if (item.type === 's3_url' && item.data){
          addQShot(item.data, item.filename || 'image.avif');
        }
      }
      if(qel.status) qel.status.textContent = `Completed in ${data.executionTime ?? '?'} ms`;
    } catch(err){
      console.error(err);
      if(qel.status) qel.status.innerHTML = `<span class="error">Error: ${err.message}</span>`;
    } finally{ setQBusy(false); }
  }

  if (qel.runBtn) qel.runBtn.addEventListener('click', (e)=>{ e.preventDefault(); runQwen(); });
  if (qel.curlBtn) qel.curlBtn.addEventListener('click', ()=>{
    const payload = buildQwenPayload();
    const text = makeQwenCurl(payload);
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(()=>{ if(qel.status) qel.status.textContent = 'cURL copied'; });
    }
  });
</script>

<script>
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = lightbox.querySelector('img');
  const lightboxClose = lightbox.querySelector('.close');
  function openLightbox(src){
    lightboxImg.src = src;
    lightbox.classList.remove('hidden');
  }
  function closeLightbox(){
    lightbox.classList.add('hidden');
    lightboxImg.src = '';
  }
  lightbox.addEventListener('click', (e)=>{ if(e.target === lightbox) closeLightbox(); });
  if (lightboxClose) lightboxClose.addEventListener('click', closeLightbox);
  window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeLightbox(); });
</script>

</body>
</html>
